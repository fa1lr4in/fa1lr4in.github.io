<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="fa1lr4in">
    
    <title>
        
            domato101 |
        
        fa1lr4in&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"fa1lr4in.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"男儿何不带吴钩，收取关山五十州。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                fa1lr4in&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">domato101</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">fa1lr4in</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-04-14 11:28:06</span>
        <span class="mobile">2022-04-14 11:28</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/101/">101</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/fuzz/">fuzz</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>10.9k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>51 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="Domato101"><a href="#Domato101" class="headerlink" title="Domato101"></a>Domato101</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Domato是googleprojectzero团队成员<a class="link"   target="_blank" rel="noopener" href="https://twitter.com/ifsecure" >Ivan Fratric<i class="fas fa-external-link-alt"></i></a>使用python开发的一款基于生成的DOM引擎fuzzer。</p>
<p>基于生成的fuzzer最困难的点之一在于创建的样本的语法或其他结构，作者尝试过手动创建以及从 Web 浏览器代码中自动提取的语法。</p>
<p>fuzzer由几个部分组成：</p>
<ul>
<li>一个给定语法结构可以生成样本的主引擎</li>
<li>一组用于生成 HTML、CSS 和 JavaScript 代码的语法规定。</li>
</ul>
<p>domato的使用非常简单</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># domato目前使用python3 </span></span><br><span class="line"><span class="comment"># https://github.com/googleprojectzero/domato</span></span><br><span class="line"><span class="comment"># 查看使用信息</span></span><br><span class="line">python3 generator.py -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成单个文件</span></span><br><span class="line">python3 generator.py -f &lt;output file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成多个文件</span></span><br><span class="line">python generator.py -o &lt;output directory&gt; -n &lt;number of output files&gt;</span><br></pre></td></tr></table></figure>

<p>生成的html文件都比较大，目的可能是为了增加代码覆盖率，从而增加触发crash的概率。生成的样本因为会指定目录下，所以命名为 fuzz-<number>.html，例如 fuzz-00001.html、fuzz-00002.html 等。生成多个样本，只输入的语法文件需要加载和解析一次。</p>
<h3 id="使用bugid配合domato进行fuzz测试"><a href="#使用bugid配合domato进行fuzz测试" class="headerlink" title="使用bugid配合domato进行fuzz测试"></a>使用bugid配合domato进行fuzz测试</h3><p>下载bugid并开启页堆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># BugId使用python2，如果python2和python3共存，可以将里面的可执行文件复制，并改名为python[2|3]</span></span><br><span class="line"><span class="comment"># https://github.com/SkyLined/BugId</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启对应应用程序的页堆：可以使用visual studio附带的gflags，也可以使用bugid带的脚本PageHeap.cmd。四大浏览器开启页堆命令如下。</span></span><br><span class="line"><span class="comment"># 使用PageHeap开启命令需要管理员权限</span></span><br><span class="line">PageHeap.cmd edge ON</span><br><span class="line">PageHeap.cmd chrome ON</span><br><span class="line">PageHeap.cmd firefox ON</span><br><span class="line">PageHeap.cmd msie ON</span><br></pre></td></tr></table></figure>

<p>本人暂时未搭建其他浏览器的环境，至测试了IE环境，下面的图片来自<a class="link"   target="_blank" rel="noopener" href="https://blog.skylined.nl/20181017001.html" >blog<i class="fas fa-external-link-alt"></i></a></p>
<p>![#2 PageHeap](../../../study/【1】fa1lr4in_article/【2】FUZZ【进行中】/【1】FUZZ基础概念/【2】源码分析/domato/%232 PageHeap.png)</p>
<p>检测环境是否就绪</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;print &#x27;ok!&#x27;&quot;</span></span><br><span class="line">python.exe <span class="string">&quot;domato-master\generator.py&quot;</span></span><br><span class="line">BugId\BugId.cmd <span class="string">&quot;%WinDir%\system32\cmd.exe&quot;</span> --cBugId.bEnsurePageHeap=<span class="literal">false</span> -- /C ECHO ok!</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/14/domato101/image-20211223215213610.png" alt="image-20211223215213610"></p>
<p>有关下面两段代码的解释可以参考<a class="link"   target="_blank" rel="noopener" href="https://blog.skylined.nl/20181017001.html" >here<i class="fas fa-external-link-alt"></i></a></p>
<ul>
<li>fuzz.cmd的主要功能就是调用了domato去生成了一些样本，并通过bugid进行逐个分析。</li>
<li>index.html则主要是测试浏览器对每个标签页的响应速度，一般测试为2s，根据自己的实际情况进行测试。</li>
</ul>
<h3 id="fuzz-cmd"><a href="#fuzz-cmd" class="headerlink" title="fuzz.cmd"></a>fuzz.cmd</h3><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@ECHO <span class="keyword">OFF</span></span><br><span class="line">SET BASE_FOLDER=C:\Fuzzing</span><br><span class="line">SET PYTHON_EXE=C:\Python27\python.exe</span><br><span class="line"></span><br><span class="line">:: What browser do we want <span class="keyword">to</span> fuzz? (<span class="string">&quot;chrome&quot;</span> | <span class="string">&quot;edge&quot;</span> | <span class="string">&quot;firefox&quot;</span> | <span class="string">&quot;msie&quot;</span>)</span><br><span class="line">SET TARGET_BROWSER=msie</span><br><span class="line">:: How many HTML <span class="keyword">files</span> shall we teach during each loop?</span><br><span class="line">SET NUMBER_OF_FILES=<span class="number">100</span></span><br><span class="line">:: How long does it take BugId <span class="keyword">to</span> start the browser <span class="keyword">and</span> <span class="keyword">load</span> an HTML file?</span><br><span class="line">SET BROWSER_LOAD_TIMEOUT_IN_SECONDS=<span class="number">30</span></span><br><span class="line">:: How long does it take the browser <span class="keyword">to</span> render each HTML file?</span><br><span class="line">SET AVERAGE_PAGE_LOAD_TIME_IN_SECONDS=<span class="number">2</span></span><br><span class="line"></span><br><span class="line">:: Optionally configurable</span><br><span class="line">SET BUGID_FOLDER=%BASE_FOLDER%\BugId</span><br><span class="line">SET DOMATO_FOLDER=%BASE_FOLDER%\domato-master</span><br><span class="line">SET TESTS_FOLDER=%BASE_FOLDER%\Tests</span><br><span class="line">SET REPORT_FOLDER=%BASE_FOLDER%\Report</span><br><span class="line">SET RESULT_FOLDER=%BASE_FOLDER%\Results</span><br><span class="line">:: Store our results in a folder named after the target:</span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">NOT</span> EXIST <span class="string">&quot;%RESULT_FOLDER%\%TARGET_BROWSER%&quot;</span> <span class="keyword">MKDIR</span> <span class="string">&quot;%RESULT_FOLDER%\%TARGET_BROWSER%&quot;</span></span><br><span class="line"></span><br><span class="line">::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><br><span class="line">:: Repeatedly generate tests <span class="keyword">and</span> <span class="keyword">run</span> them in the browser.</span><br><span class="line">:LOOP</span><br><span class="line">  <span class="keyword">CALL</span> :GENERATE</span><br><span class="line">  <span class="keyword">IF</span> ERRORLEVEL <span class="number">1</span> EXIT /B <span class="number">1</span></span><br><span class="line">  <span class="keyword">CALL</span> :TEST</span><br><span class="line">  <span class="keyword">IF</span> ERRORLEVEL <span class="number">1</span> EXIT /B <span class="number">1</span></span><br><span class="line">  <span class="keyword">GOTO</span> :LOOP</span><br><span class="line"></span><br><span class="line">::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><br><span class="line">:: Generate test HTML <span class="keyword">files</span></span><br><span class="line">:GENERATE</span><br><span class="line">  <span class="comment">REM Delete old files.</span></span><br><span class="line">  DEL <span class="string">&quot;%TESTS_FOLDER%\fuzz-*.html&quot;</span> /Q &gt;nul <span class="number">2</span>&gt;nul</span><br><span class="line">  <span class="comment">REM Generate new HTML files.</span></span><br><span class="line">  <span class="string">&quot;%PYTHON_EXE%&quot;</span> <span class="string">&quot;%DOMATO_FOLDER%\generator.py&quot;</span> --output_dir <span class="string">&quot;%TESTS_FOLDER%&quot;</span> --no_of_files %NUMBER_OF_FILES%</span><br><span class="line">  <span class="keyword">IF</span> ERRORLEVEL <span class="number">1</span> EXIT /B <span class="number">1</span></span><br><span class="line">  EXIT /B <span class="number">0</span></span><br><span class="line"></span><br><span class="line">::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><br><span class="line">:: <span class="keyword">Run</span> browser in BugId <span class="keyword">and</span> <span class="keyword">load</span> test HTML <span class="keyword">files</span></span><br><span class="line">:TEST</span><br><span class="line">  <span class="comment">REM Delete old report if any.</span></span><br><span class="line">  <span class="keyword">IF</span> <span class="keyword">NOT</span> EXIST <span class="string">&quot;%REPORT_FOLDER%&quot;</span> (</span><br><span class="line">    <span class="keyword">MKDIR</span> <span class="string">&quot;%REPORT_FOLDER%&quot;</span></span><br><span class="line">  ) <span class="keyword">ELSE</span> (</span><br><span class="line">    DEL <span class="string">&quot;%REPORT_FOLDER%\*.html&quot;</span> /Q &gt;nul <span class="number">2</span>&gt;nul</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">REM Guess how long the browser needs to run to process all tests.</span></span><br><span class="line">  <span class="comment">REM This is used by BugId to terminate the browser in case it survives all tests.</span></span><br><span class="line">  SET /A MAX_BROWSER_RUN_TIME=%BROWSER_LOAD_TIMEOUT_IN_SECONDS% + %AVERAGE_PAGE_LOAD_TIME_IN_SECONDS% * %NUMBER_OF_FILES%</span><br><span class="line">  <span class="comment">REM Start browser in BugId...</span></span><br><span class="line">  <span class="string">&quot;%PYTHON_EXE%&quot;</span> <span class="string">&quot;%BUGID_FOLDER%\BugId.py&quot;</span> <span class="string">&quot;%TARGET_BROWSER%&quot;</span> <span class="string">&quot;--sReportFolderPath=\&quot;%REPORT_FOLDER:\=\\%\&quot;&quot;</span> --nApplicationMaxRunTimeInSeconds=%MAX_BROWSER_RUN_TIME% -- <span class="string">&quot;file://%TESTS_FOLDER%\index.html&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">IF</span> ERRORLEVEL <span class="number">2</span> (</span><br><span class="line">    ECHO - <span class="keyword">ERROR</span> %ERRORLEVEL%.</span><br><span class="line">    <span class="comment">REM ERRORLEVEL 2+ means something went wrong.</span></span><br><span class="line">    ECHO Please <span class="keyword">fix</span> the issue before continuing...</span><br><span class="line">    EXIT /B <span class="number">1</span></span><br><span class="line">  ) <span class="keyword">ELSE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> ERRORLEVEL <span class="number">1</span> (</span><br><span class="line">    EXIT /B <span class="number">0</span></span><br><span class="line">  )</span><br><span class="line">  ECHO Crash detected!</span><br><span class="line"></span><br><span class="line">  <span class="comment">REM Create results sub-folder based on report file name and copy test files</span></span><br><span class="line">  <span class="comment">REM and report.</span></span><br><span class="line">  <span class="keyword">FOR</span> %%I IN (<span class="string">&quot;%REPORT_FOLDER%\*.html&quot;</span>) DO (</span><br><span class="line">    <span class="keyword">CALL</span> :COPY_TO_UNIQUE_CRASH_FOLDER <span class="string">&quot;%RESULT_FOLDER%\%%~nxI&quot;</span></span><br><span class="line">    EXIT /B <span class="number">0</span></span><br><span class="line">  )</span><br><span class="line">  ECHO BugId reported finding a crash, but <span class="keyword">not</span> report file could be found!?</span><br><span class="line">  EXIT /B <span class="number">1</span></span><br><span class="line"></span><br><span class="line">:COPY_TO_UNIQUE_CRASH_FOLDER</span><br><span class="line">  SET REPORT_FILE=%~nx1</span><br><span class="line">  <span class="comment">REM We want to remove the &quot;.html&quot; extension from the report file name to get</span></span><br><span class="line">  <span class="comment">REM a unique folder name:</span></span><br><span class="line">  SET UNIQUE_CRASH_FOLDER=%RESULT_FOLDER%\%TARGET_BROWSER%\%REPORT_FILE:~<span class="number">0</span>,-<span class="number">5</span>%</span><br><span class="line">  <span class="keyword">IF</span> EXIST <span class="string">&quot;%UNIQUE_CRASH_FOLDER%&quot;</span> (</span><br><span class="line">    ECHO Repro <span class="keyword">and</span> report already saved after previous test detected the same issue.</span><br><span class="line">    EXIT /B <span class="number">0</span></span><br><span class="line">  )</span><br><span class="line">  ECHO Copying report <span class="keyword">and</span> repro <span class="keyword">to</span> %UNIQUE_CRASH_FOLDER% folder...</span><br><span class="line">  <span class="comment">REM Move report to unique folder</span></span><br><span class="line">  <span class="keyword">MKDIR</span> <span class="string">&quot;%UNIQUE_CRASH_FOLDER%&quot;</span></span><br><span class="line">  MOVE <span class="string">&quot;%REPORT_FOLDER%\%REPORT_FILE%&quot;</span> <span class="string">&quot;%UNIQUE_CRASH_FOLDER%\report.html&quot;</span></span><br><span class="line">  <span class="comment">REM Copy repro</span></span><br><span class="line">  <span class="keyword">MKDIR</span> <span class="string">&quot;%UNIQUE_CRASH_FOLDER%\Repro&quot;</span></span><br><span class="line">  COPY <span class="string">&quot;%TESTS_FOLDER%\*.html&quot;</span> <span class="string">&quot;%UNIQUE_CRASH_FOLDER%\Repro&quot;</span></span><br><span class="line">  ECHO Report <span class="keyword">and</span> repro copied <span class="keyword">to</span> %UNIQUE_CRASH_FOLDER% folder.</span><br><span class="line">  EXIT /B <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- saved from url=(0014)about:internet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">      <span class="keyword">var</span> oIFrameElement = <span class="built_in">document</span>.getElementById(<span class="string">&quot;IFrame&quot;</span>),</span></span><br><span class="line"><span class="javascript">          nPageLoadTimeoutInSeconds = <span class="number">5</span>,</span></span><br><span class="line"><span class="javascript">          uIndex = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">      onload = <span class="function"><span class="keyword">function</span> <span class="title">fLoadNext</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// Show progress in title bar.</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> sIndex = <span class="string">&quot;&quot;</span> + uIndex++;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">while</span> (sIndex.length &lt; <span class="number">5</span>) sIndex = <span class="string">&quot;0&quot;</span> + sIndex;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> sTestURL = <span class="string">&quot;fuzz-&quot;</span> + sIndex + <span class="string">&quot;.html&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.title = <span class="string">&quot;Loading test &quot;</span> + sTestURL + <span class="string">&quot;...&quot;</span>;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// Add iframe element that loads the next test case.</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> oIFrame = <span class="built_in">document</span>.body.appendChild(<span class="built_in">document</span>.createElement(<span class="string">&quot;iframe&quot;</span>)),</span></span><br><span class="line"><span class="javascript">            bFinished = <span class="literal">false</span>;</span></span><br><span class="line"><span class="javascript">        oIFrame.setAttribute(<span class="string">&quot;sandbox&quot;</span>, <span class="string">&quot;allow-scripts&quot;</span>);</span></span><br><span class="line"><span class="javascript">        oIFrame.setAttribute(<span class="string">&quot;src&quot;</span>, sTestURL);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// Hook load event handler and add timeout to remove the iframe when the test is finished.</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">          oIFrame.contentWindow.addEventListener(<span class="string">&quot;load&quot;</span>, fCleanupAndLoadNext);</span></span><br><span class="line"><span class="javascript">        &#125; <span class="keyword">catch</span> (e) &#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// This may cause an exception because some browsers treat different files loaded from the</span></span></span><br><span class="line"><span class="javascript">          <span class="comment">// local file system as comming from different origins.</span></span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> xTimeout = <span class="built_in">setTimeout</span>(fCleanupAndLoadNext, nPageLoadTimeoutInSeconds * <span class="number">1000</span>);</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">fCleanupAndLoadNext</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">          <span class="comment">// Both the load event and the timeout can call this function; make sure we only execute once:</span></span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span> (!bFinished) &#123;</span></span><br><span class="line"><span class="javascript">            bFinished = <span class="literal">true</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">&quot;Finished test &quot;</span> + sTestURL + <span class="string">&quot;...&quot;</span>);</span></span><br><span class="line"><span class="javascript">            <span class="comment">// Let&#x27;s give the page another 5 seconds to render animations etc.</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">              <span class="comment">// Remove the iframe from the document to delete the test.</span></span></span><br><span class="line"><span class="javascript">              <span class="keyword">try</span> &#123;</span></span><br><span class="line"><span class="javascript">                <span class="built_in">document</span>.body.removeChild(oIFrame);</span></span><br><span class="line"><span class="javascript">              &#125; <span class="keyword">catch</span> (e) &#123;&#125;;</span></span><br><span class="line"><span class="javascript">            &#125;, <span class="number">5000</span>);</span></span><br><span class="line"><span class="javascript">            fLoadNext();</span></span><br><span class="line"><span class="javascript">          &#125;;</span></span><br><span class="line"><span class="javascript">        &#125;;</span></span><br><span class="line"><span class="javascript">      &#125;;</span></span><br><span class="line"><span class="javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行截图</p>
<p><img src="/2022/04/14/domato101/image-20211223215010429.png" alt="image-20211223215010429"></p>
<h2 id="模块分析"><a href="#模块分析" class="headerlink" title="模块分析"></a>模块分析</h2><h3 id="generator-py"><a href="#generator-py" class="headerlink" title="generator.py"></a>generator.py</h3><p>是主脚本，使用了grammar.py 作为库，并包含fuzzer的额外代码。</p>
<h3 id="grammar-py"><a href="#grammar-py" class="headerlink" title="grammar.py"></a>grammar.py</h3><p>包含大多数与应用程序无关的生成引擎，因此可以在其他（即非DOM）基于生成的模糊器中使用。</p>
<p>.txt 文件包含语法定义。有 3 个主要文件，html.txt、css.txt 和 js.txt，分别包含 HTML、CSS 和 JavaScript 语法。这些根语法文件可能包含来自其他文件的内容。</p>
<p>该文件可以当作库进行使用，当我们需要使用自定义语法时，可以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> grammar <span class="keyword">import</span> Grammar</span><br><span class="line"></span><br><span class="line">my_grammar = Grammar()</span><br><span class="line">my_grammar.parse_from_file(<span class="string">&#x27;input_file.txt&#x27;</span>)</span><br><span class="line">result_string = my_grammar.generate_symbol(<span class="string">&#x27;symbol_name&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h3><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4><p>Domato 基于一个引擎，该引擎以下面指定的简单格式给出上下文无关的文法，然后从该文法生成样本。</p>
<p>语法被描述为具有以下基本格式的一组规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;symbol&gt; = a mix of constants and &lt;other_symbol&gt;s</span><br></pre></td></tr></table></figure>

<p>每个语法规则都包含由等号左侧和右侧。左侧包含一个符号，而右侧包含该符号的实现。</p>
<p>考虑以下 CSS 语法部分的简化示例：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;cssrule&gt; = &lt;selector&gt; &#123; &lt;declaration&gt; &#125;</span><br><span class="line">&lt;selector&gt; = <span class="selector-tag">a</span></span><br><span class="line">&lt;selector&gt; = <span class="selector-tag">b</span></span><br><span class="line">&lt;declaration&gt; = <span class="attribute">width</span>:<span class="number">100%</span></span><br></pre></td></tr></table></figure>

<p>使用上面的语法可以生成如下的代码</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">a</span> &#123; <span class="attribute">width</span>:<span class="number">100%</span> &#125;</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">b</span> &#123; <span class="attribute">width</span>:<span class="number">100%</span> &#125;</span><br></pre></td></tr></table></figure>

<p>也可以对<code>selector</code>进行加权</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;selector <span class="selector-tag">p</span>=<span class="number">0.9</span>&gt; = <span class="selector-tag">a</span></span><br><span class="line">&lt;selector <span class="selector-tag">p</span>=<span class="number">0.1</span>&gt; = <span class="selector-tag">b</span></span><br></pre></td></tr></table></figure>

<p>这样字符串 ‘a’ 将比 ‘b’ 更频繁地输出。</p>
<h4 id="生成编程语言代码"><a href="#生成编程语言代码" class="headerlink" title="生成编程语言代码"></a>生成编程语言代码</h4><p>要生成编程语言代码，可以使用类似的语法，但存在一些差异。编程语言语法的每一行都将对应于输出行。正因为如此，文法语法将更加自由，以允许用各种编程语言表达结构。其次，当生成一行时，除了输出该行之外，还可以创建一个或多个变量，这些变量可以在生成其他行时重复使用。同样，让我们看一下简化的示例：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">!varformat fuzzvar%<span class="number">05</span>d</span><br><span class="line">!lineguard try &#123; &lt;line&gt; &#125; catch(e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">!begin lines</span><br><span class="line">&lt;new element&gt; = document<span class="selector-class">.getElementById</span>(&quot;&lt;string min=<span class="number">97</span> max=<span class="number">122</span>&gt;&quot;);</span><br><span class="line">&lt;element&gt;<span class="selector-class">.doSomething</span>();</span><br><span class="line">!end lines</span><br></pre></td></tr></table></figure>

<p>如果引擎生成 5 行，我们可能会得到如下结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; var00001 = <span class="built_in">document</span>.getElementById(<span class="string">&quot;hw&quot;</span>); &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"><span class="keyword">try</span> &#123; var00001.doSomething(); &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"><span class="keyword">try</span> &#123; var00002 = <span class="built_in">document</span>.getElementById(<span class="string">&quot;feezcqbndf&quot;</span>); &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"><span class="keyword">try</span> &#123; var00002.doSomething(); &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br><span class="line"><span class="keyword">try</span> &#123; var00001.doSomething(); &#125; <span class="keyword">catch</span>(e) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>对上面的代码进行解释</p>
<ul>
<li>编程语言被限制在 ‘!begin lines’ 和 ‘!end lines’ 之间。这样语法解析器更容易识别各个范围。</li>
<li><code>&lt;new element&gt;</code>和<code>&lt;element&gt;</code>的区别在于： <code>&lt;new element&gt;</code>表示变量赋值，而<code>&lt;element&gt;</code>表示了变量属性调用。</li>
<li><code>&lt;string&gt;</code> 是内置符号之一，无需定义。</li>
<li>[可选]  !varformat 定义要使用变量命名的格式。</li>
<li>[可选]  !lineguard 定义在每一行周围插入的附加代码，以便捕获异常或执行其他任务。这样您就无需为每一行单独编写它。</li>
<li>除了 ‘!begin lines’ 和 ‘!end lines’ 之外，您还可以使用 ‘!begin helperlines’ 和 ‘!end helperlines’ 定义辅助输出行（）</li>
</ul>
<h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>该行第一个“#”字符之后的所有内容都被视为注释，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is a comment</span></span><br></pre></td></tr></table></figure>

<h4 id="防止无限递归"><a href="#防止无限递归" class="headerlink" title="防止无限递归"></a>防止无限递归</h4><p>语法中有种方法可以告诉fuzzer哪些规则是非递归的，即使达到了最大递归级别也可以安全使用。这是通过“非递归”属性完成的。下面给出一个例子。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">!max_recursion <span class="number">10</span></span><br><span class="line">&lt;test root=true&gt; = &lt;foobar&gt;</span><br><span class="line">&lt;foobar&gt; = foo&lt;foobar&gt;</span><br><span class="line">&lt;foobar nonrecursive&gt; = bar</span><br></pre></td></tr></table></figure>

<p>可选选项 ‘!max_recursion’ 语句定义了最大递归深度级别（默认为 50）。第三行使用了递归调用，如果达到最大递归层数，生成器将强制结束递归语句的生成。</p>
<h4 id="include与import"><a href="#include与import" class="headerlink" title="include与import"></a>include与import</h4><p>在 Domato 中，<code>include</code>和<code>import</code>是不同的</p>
<p><code>include</code>比较简单，如下代码所示：将 other.txt 中的rules包含到当前rules中。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!include other<span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure>

<p><code>import</code>的工作方式略有不同：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!import other<span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure>

<p>它会创建一个新的 Grammar() 对象，然后可以使用特殊<code>&lt;import&gt;</code>符号从当前语法中引用该对象，例如：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;cssrule&gt; = &lt;import <span class="selector-tag">from</span>=css<span class="selector-class">.txt</span> symbol=rule&gt;</span><br></pre></td></tr></table></figure>

<p>从<code>namespace</code>的角度考虑<code>include</code>和<code>import</code>：<code>include</code> 会将包含的语法放入单个<code>namespace</code>中，而 <code>import</code> 将创建一个新的<code>namespace</code>，然后可以使用<code>&lt;import&gt;</code>符号和通过 <code>from</code> 属性让其他<code>namespace</code>进行访问.</p>
<h4 id="使用-Python-代码"><a href="#使用-Python-代码" class="headerlink" title="使用 Python 代码"></a>使用 Python 代码</h4><p>当我们想在语法中调用自定义 Python 代码。例如，假设您想使用引擎生成 http 响应，并且您希望正文长度与“大小”标头相匹配。正常情况下普通语法规则很难实现，但我们可以通过自定义 Python 代码来轻松它，如下所示：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">!begin function savesize</span><br><span class="line">  context<span class="selector-attr">[<span class="string">&#x27;size&#x27;</span>]</span> = ret_val</span><br><span class="line">!end function</span><br><span class="line"></span><br><span class="line">!begin function createbody</span><br><span class="line">  n = int(context<span class="selector-attr">[<span class="string">&#x27;size&#x27;</span>]</span>)</span><br><span class="line">  ret_val = &#x27;<span class="selector-tag">a</span>&#x27; * n</span><br><span class="line">!end function</span><br><span class="line"></span><br><span class="line">&lt;foo root&gt; = &lt;<span class="selector-tag">header</span>&gt;&lt;cr&gt;&lt;lf&gt;&lt;<span class="selector-tag">body</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">header</span>&gt; = Size: &lt;int min=<span class="number">1</span> max=<span class="number">20</span> beforeoutput=savesize&gt;</span><br><span class="line">&lt;body&gt; = &lt;call function=createbody&gt;</span><br></pre></td></tr></table></figure>

<p>python 函数定义在 ‘!begin function <function_name>‘ 和 ‘!end function’ 命令之间。我们可以通过使用<code>beforeoutput</code>属性和使用<code>&lt;call&gt;</code>符号两种方式调用这些函数。</p>
<p>使用 <code>beforeoutput</code> 时，会在外部给调用的函数一个初始值，而这个初始值会被传递给<code>ret_val</code>。</p>
<p>使用<code>&lt;call&gt;</code>时，会将函数的结果保存在<code>ret_val</code>中，如果不给<code>ret_val</code>赋值默认为空。</p>
<p>您的 Python 代码可以访问以下变量：</p>
<ul>
<li><code>context</code>- 相当于一个字典，上面的例子中savesize函数使用了<code>key</code>对应了<code>size</code>，而<code>value</code>对应了<code>ret_val</code>。实际上就是通过<code>context</code>定义了变量。</li>
<li><code>attributes</code>- 相当于函数参数的传递。例如，类似于<code>&lt;call function=func foo=bar&gt;</code>，则<code>foo</code>的缺省值为”bar”。</li>
<li><code>ret_val</code>- 函数的返回值。使用<code>&lt;call&gt;</code>时默认为空，</li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>考虑另一个生成 html 样本的示例：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">html</span>&gt; = &lt;lt&gt;<span class="selector-tag">html</span>&lt;gt&gt;&lt;head&gt;&lt;<span class="selector-tag">body</span>&gt;&lt;lt&gt;/<span class="selector-tag">html</span>&lt;gt&gt;</span><br><span class="line">&lt;head&gt; = &lt;lt&gt;head&lt;gt&gt;...&lt;lt&gt;/head&lt;gt&gt;</span><br><span class="line">&lt;<span class="selector-tag">body</span>&gt; = &lt;lt&gt;<span class="selector-tag">body</span>&lt;gt&gt;...&lt;lt&gt;/<span class="selector-tag">body</span>&lt;gt&gt;</span><br></pre></td></tr></table></figure>

<p>由于 ‘&lt;’ 和 ‘&gt;’ 在语法文件中会用到，因此我们在这里使用<code>&lt;lt&gt;</code>and<code>&lt;gt&gt;</code>代替。这些符号是内置的，不需要用户定义。所有内置符号的列表如下：</p>
<h5 id="内置符号"><a href="#内置符号" class="headerlink" title="内置符号"></a>内置符号</h5><p>以下符号具有特殊含义，用户不应重新定义：</p>
<ul>
<li><code>&lt;lt&gt;</code> - ‘&lt;’ 字符</li>
<li><code>&lt;gt&gt;</code> - ‘&gt;’ 字符</li>
<li><code>&lt;hash&gt;</code> - ‘＃’ 特点</li>
<li><code>&lt;cr&gt;</code> - CR 字符</li>
<li><code>&lt;lf&gt;</code> - LF 字符</li>
<li><code>&lt;space&gt;</code> - 空格字符</li>
<li><code>&lt;tab&gt;</code> - 制表符</li>
<li><code>&lt;ex&gt;</code>- ‘！特点</li>
<li><code>&lt;char&gt;</code>- 可用于使用 ‘code’ 属性生成任意 ASCII 字符。例如<code>&lt;char code=97&gt;</code>对应于’a’。如果未指定，则生成随机字符。支持“min”和“max”属性。</li>
<li><code>&lt;hex&gt;</code> - 生成一个随机的十六进制数字。</li>
<li><code>&lt;int&gt;</code>, <code>&lt;int 8&gt;</code>, <code>&lt;uint8&gt;</code>, <code>&lt;int16&gt;</code>, <code>&lt;uint16&gt;</code>, <code>&lt;int32&gt;</code>, <code>&lt;uint32&gt;</code>, <code>&lt;int64&gt;</code>, <code>&lt;uint64&gt;</code>- 可用于生成随机整数。支持 ‘min’ 和 ‘max’ 属性，可用于限制将生成的整数范围。支持 ‘b’ 和 ‘be’ 属性，这使得输出二进制文件为小/大端格式，而不是文本输出。</li>
<li><code>&lt;float&gt;</code>, <code>&lt;double&gt;</code>- 生成一个随机浮点数。支持 ‘min’ 和 ‘max’ 属性（如果未指定，则为 0 和 1）。支持使输出二进制的“b”属性。</li>
<li><code>&lt;string&gt;</code>- 生成一个随机字符串。支持控制生成的最小和最大字符代码的“min”和“max”属性以及控制字符串长度的“minlength”和“maxlength”属性。</li>
<li><code>&lt;htmlsafestring&gt;</code>- 与<code>&lt;string&gt;</code>除了 HTML 元字符将被转义外相同，从而可以安全地将字符串作为 HTML 文本或属性值的一部分嵌入。</li>
<li><code>&lt;lines&gt;</code>- 输出给定数量（通过 ‘count’ 属性）的代码行。例如，请参阅有关生成编程语言代码的部分。</li>
<li><code>&lt;import&gt;</code> - 从另一个语法导入符号，请参阅包含外部语法的部分了解详细信息。</li>
<li><code>&lt;call&gt;</code>- 调用与函数属性相对应的用户定义函数。有关详细信息，请参阅有关在语法中包含 Python 代码的部分。</li>
</ul>
<h5 id="符号属性"><a href="#符号属性" class="headerlink" title="符号属性"></a>符号属性</h5><p>支持以下属性：</p>
<ul>
<li><code>root</code> - 将符号标记为语法的根符号。唯一支持的值为“true”。调用 GenerateSymbol() 时，如果未指定参数，将生成根符号。</li>
<li><code>nonrecursive</code> - 向生成器提示此规则不包含递归循环并用于防止无限递归。唯一支持的值为“true”。</li>
<li><code>new</code> - 在生成编程语言时用于表示此处创建了一个新变量，而不是像往常一样扩展符号。唯一支持的值为“true”。</li>
<li><code>from</code>, 符号 - 从其他语法导入符号时使用，请参阅“包括外部语法”部分。</li>
<li><code>count</code> - 用于行符号以指定要创建的行数。</li>
<li><code>id</code> - 用于标记多个符号应该共享相同的值。例如，在规则中，<code>‘doSomething(&lt;int id=1&gt;, &lt;int id=1&gt;)’</code>两个整数最终将具有相同的值。实际上只有第一个实例被扩展，第二个只是从第一个实例复制而来。</li>
<li><code>min, max</code> - 用于生成数字类型以指定最小值和最大值。也用于限制字符串中生成的字符集。</li>
<li><code>b, be</code> - 在数字类型中用于指定二进制小端 (‘b’) 或大端 (‘be’) 输出。</li>
<li><code>code</code> - 用于字符符号以指定要由其代码输出的确切字符。</li>
<li><code>minlength, maxlength</code> - 在生成字符串时用于指定最小和最大长度。</li>
<li><code>up</code> - 在十六进制符号中用于指定大写输出（小写是默认值）。</li>
<li><code>function</code> - 在<code>&lt;call&gt;</code>符号中使用，有关更多信息，请参阅“包括 Python 代码”部分。</li>
<li><code>beforeoutput</code> - 用于调用用户指定的函数，请参阅“包括 Python”。</li>
</ul>
<p>待改进的点</p>
<ol>
<li>最好结合目前主流的基于覆盖引导的模糊测试技术来增加发现crash的概率（作者在他的博客上po上了相关的尝试，但是效果不太理想），作者的思路是目前比较主流的基于覆盖引导的fuzzer常用的思路，没有发现新的崩溃可能是由于对变异策略等方向的实现出现了问题（也就是作者结合的可能不够好，这块一定是一个可搞的点，不过有个问题就是很多的基于覆盖引导的fuzzer在开始fuzz前会给fuzzer提供语料库，并对其进行精简，而domato生成的样本又比较大，如何平衡这种代码覆盖率和效率的问题是非常关键的一点）。</li>
<li>目前官方工具里面没有对主流浏览器进行自动化测试的工具（ps：虽然这个功能比较简单）</li>
</ol>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="generator-py-1"><a href="#generator-py-1" class="headerlink" title="generator.py"></a>generator.py</h3><p>首先判断参数，决定生成单个文件还是多个文件，都是调用generate_samples来生成文件，区别在于生成多少个。生成文件的命名格式，如果是多个，则按照fuzz-xxxxx.html递增。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> args.file:</span><br><span class="line">    generate_samples(template, [args.file])                 <span class="comment"># 可见generate_samples函数为生成样本的核心函数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> args.output_dir:</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> args.no_of_files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Please use switch -n to specify the number of files&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ...</span><br><span class="line">        outfiles = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(nsamples):</span><br><span class="line">            outfiles.append(os.path.join(out_dir, <span class="string">&#x27;fuzz-&#x27;</span> + <span class="built_in">str</span>(i).zfill(<span class="number">5</span>) + <span class="string">&#x27;.html&#x27;</span>))</span><br><span class="line">        generate_samples(template, outfiles)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    parser.print_help()</span><br></pre></td></tr></table></figure>

<p>在generate_samples，调用了Grammar.py的库，解析了三个txt文件作为文法，并把css的文法namespace导入到html和js的文法namespace中。这里的<code>parse_from_file</code>函数后续要跟入Grammar.py去查看实现。最后调用了generate_new_sample去完成实际的html文件生成的操作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_samples</span>(<span class="params">template, outfiles</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;该函数主要为了生成样本和写文件</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      template: 生成样本的模板，传入generate_new_sample函数中使用。</span></span><br><span class="line"><span class="string">      outfiles: 输出文件名的列表</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    grammar_dir = os.path.join(os.path.dirname(__file__), <span class="string">&#x27;rules&#x27;</span>)</span><br><span class="line">    htmlgrammar = Grammar()</span><br><span class="line"></span><br><span class="line">    err = htmlgrammar.parse_from_file(os.path.join(grammar_dir, <span class="string">&#x27;html.txt&#x27;</span>))</span><br><span class="line">    <span class="comment"># CheckGrammar(htmlgrammar)</span></span><br><span class="line">    cssgrammar = Grammar()</span><br><span class="line">    err = cssgrammar.parse_from_file(os.path.join(grammar_dir, <span class="string">&#x27;css.txt&#x27;</span>))</span><br><span class="line">    <span class="comment"># CheckGrammar(cssgrammar)</span></span><br><span class="line">    jsgrammar = Grammar()</span><br><span class="line">    err = jsgrammar.parse_from_file(os.path.join(grammar_dir, <span class="string">&#x27;js.txt&#x27;</span>))</span><br><span class="line">    <span class="comment"># CheckGrammar(jsgrammar)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JS and HTML grammar need access to CSS grammar.</span></span><br><span class="line">    <span class="comment"># Add it as import</span></span><br><span class="line">    htmlgrammar.add_import(<span class="string">&#x27;cssgrammar&#x27;</span>, cssgrammar)</span><br><span class="line">    jsgrammar.add_import(<span class="string">&#x27;cssgrammar&#x27;</span>, cssgrammar)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> outfile <span class="keyword">in</span> outfiles:</span><br><span class="line">        result = generate_new_sample(template, htmlgrammar, cssgrammar, jsgrammar)</span><br><span class="line">        <span class="comment">#writefile</span></span><br></pre></td></tr></table></figure>

<p>这里需要注意的是<code>generate_symbol</code>函数，还有<code>_generate_code</code>函数，<code>_generate_code</code>在generate_function_body函数中，用来生成js代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate_symbol 函数</span></span><br><span class="line"><span class="comment"># 先生成了html和css的结果，定义了template文件，方便将随机化生成的html，css，js放入特定的模板中进行排布，</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_new_sample</span>(<span class="params">template, htmlgrammar, cssgrammar, jsgrammar</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;从字符串中解析grammar规则</span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">      template: 是一个html文件，利用随机生成的html,js,css替换模板文件中的uzzer&gt;，&lt;jsfuzzer&gt;，&lt;cssfuzzer&gt;</span></span><br><span class="line"><span class="string">      htmlgrammar: grammar生成的html代码</span></span><br><span class="line"><span class="string">      cssgrammar: grammar生成的css代码</span></span><br><span class="line"><span class="string">      jsgrammar: grammar生成的js代码</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">     最终的样本代码，html格式</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    result = template</span><br><span class="line"></span><br><span class="line">    css = cssgrammar.generate_symbol(<span class="string">&#x27;rules&#x27;</span>)</span><br><span class="line">    html = htmlgrammar.generate_symbol(<span class="string">&#x27;bodyelements&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    htmlctx = &#123;</span><br><span class="line">        <span class="string">&#x27;htmlvars&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;htmlvarctr&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&#x27;svgvarctr&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&#x27;htmlvargen&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    html = re.sub(</span><br><span class="line">        <span class="string">r&#x27;&lt;[a-zA-Z0-9_-]+ &#x27;</span>,                              <span class="comment"># 从html_tags.py与svg_tags.py文件去匹配match与tag的对应关系</span></span><br><span class="line">        <span class="keyword">lambda</span> match: add_html_ids(match, htmlctx),       <span class="comment"># lambda 匿名函数表达式，可以直接作为函数使用，也更方便了函数的嵌套</span></span><br><span class="line">        html</span><br><span class="line">    )</span><br><span class="line"> </span><br><span class="line">    generate_html_elements(htmlctx, _N_ADDITIONAL_HTMLVARS)			<span class="comment"># 默认为htmlctx加了5个随机的_HTML_TYPES，但没改变变量html</span></span><br><span class="line"></span><br><span class="line">    result = result.replace(<span class="string">&#x27;&lt;cssfuzzer&gt;&#x27;</span>, css)</span><br><span class="line">    result = result.replace(<span class="string">&#x27;&lt;htmlfuzzer&gt;&#x27;</span>, html)</span><br><span class="line"></span><br><span class="line">    handlers = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="string">&#x27;&lt;jsfuzzer&gt;&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        numlines = _N_MAIN_LINES</span><br><span class="line">        <span class="keyword">if</span> handlers:</span><br><span class="line">            numlines = _N_EVENTHANDLER_LINES</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            handlers = <span class="literal">True</span></span><br><span class="line">        result = result.replace(</span><br><span class="line">            <span class="string">&#x27;&lt;jsfuzzer&gt;&#x27;</span>,</span><br><span class="line">            generate_function_body(jsgrammar, htmlctx, numlines),				<span class="comment"># 通过生成js代码并替换result来实现最后的替换。</span></span><br><span class="line">            <span class="number">1</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>add_html_ids函数实现，该函数会判断随机生成的标签属于html还是svg，之后会对html_ctx赋值。目的是为了统计之前生成的html标签和svg标签计数。并将id加到标签中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_html_ids</span>(<span class="params">matchobj, ctx</span>):</span></span><br><span class="line">    tagname = matchobj.group(<span class="number">0</span>)[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> tagname <span class="keyword">in</span> _HTML_TYPES:</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvarctr&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        varname = <span class="string">&#x27;htmlvar%05d&#x27;</span> % ctx[<span class="string">&#x27;htmlvarctr&#x27;</span>]</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvars&#x27;</span>].append(&#123;<span class="string">&#x27;name&#x27;</span>: varname, <span class="string">&#x27;type&#x27;</span>: _HTML_TYPES[tagname]&#125;)</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvargen&#x27;</span>] += <span class="string">&#x27;/* newvar&#123;&#x27;</span> + varname + <span class="string">&#x27;:&#x27;</span> + _HTML_TYPES[</span><br><span class="line">            tagname] + <span class="string">&#x27;&#125; */ var &#x27;</span> + varname + <span class="string">&#x27; = document.getElementById(\&quot;&#x27;</span> + varname + <span class="string">&#x27;\&quot;); //&#x27;</span> + _HTML_TYPES[</span><br><span class="line">                                 tagname] + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> matchobj.group(<span class="number">0</span>) + <span class="string">&#x27;id=\&quot;&#x27;</span> + varname + <span class="string">&#x27;\&quot; &#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> tagname <span class="keyword">in</span> _SVG_TYPES:</span><br><span class="line">        ctx[<span class="string">&#x27;svgvarctr&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        varname = <span class="string">&#x27;svgvar%05d&#x27;</span> % ctx[<span class="string">&#x27;svgvarctr&#x27;</span>]</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvars&#x27;</span>].append(&#123;<span class="string">&#x27;name&#x27;</span>: varname, <span class="string">&#x27;type&#x27;</span>: _SVG_TYPES[tagname]&#125;)</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvargen&#x27;</span>] += <span class="string">&#x27;/* newvar&#123;&#x27;</span> + varname + <span class="string">&#x27;:&#x27;</span> + _SVG_TYPES[</span><br><span class="line">            tagname] + <span class="string">&#x27;&#125; */ var &#x27;</span> + varname + <span class="string">&#x27; = document.getElementById(\&quot;&#x27;</span> + varname + <span class="string">&#x27;\&quot;); //&#x27;</span> + _SVG_TYPES[</span><br><span class="line">                                 tagname] + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> matchobj.group(<span class="number">0</span>) + <span class="string">&#x27;id=\&quot;&#x27;</span> + varname + <span class="string">&#x27;\&quot; &#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> matchobj.group(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>generate_html_elements这个函数比较简单，添加了<code>n</code>行html元素到html_ctx中，默认为5，可以通过修改代码进行更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_html_elements</span>(<span class="params">ctx, n</span>):</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        tag = random.choice(<span class="built_in">list</span>(_HTML_TYPES))</span><br><span class="line">        tagtype = _HTML_TYPES[tag]</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvarctr&#x27;</span>] += <span class="number">1</span></span><br><span class="line">        varname = <span class="string">&#x27;htmlvar%05d&#x27;</span> % ctx[<span class="string">&#x27;htmlvarctr&#x27;</span>]</span><br><span class="line">        ctx[<span class="string">&#x27;htmlvars&#x27;</span>].append(&#123;<span class="string">&#x27;name&#x27;</span>: varname, <span class="string">&#x27;type&#x27;</span>: tagtype&#125;)</span><br><span class="line">        ctx[</span><br><span class="line">            <span class="string">&#x27;htmlvargen&#x27;</span>] += <span class="string">&#x27;/* newvar&#123;&#x27;</span> + varname + <span class="string">&#x27;:&#x27;</span> + tagtype + <span class="string">&#x27;&#125; */ var &#x27;</span> + varname + <span class="string">&#x27; = document.createElement(\&quot;&#x27;</span> + tag + <span class="string">&#x27;\&quot;); //&#x27;</span> + tagtype + <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p>generate_function_body这个函数用来生成js代码，前面是一段模板式的代码，后面调用_generate_code生成随机的js代码，可以指定行数。这个函数上面也说过，最关键的在于<code>_generate_code</code>函数的逻辑。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_function_body</span>(<span class="params">jsgrammar, htmlctx, num_lines</span>):</span></span><br><span class="line">    js = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    js += <span class="string">&#x27;var fuzzervars = &#123;&#125;;\n\n&#x27;</span></span><br><span class="line">    js += <span class="string">&quot;SetVariable(fuzzervars, window, &#x27;Window&#x27;);\nSetVariable(fuzzervars, document, &#x27;Document&#x27;);\nSetVariable(fuzzervars, document.body.firstChild, &#x27;Element&#x27;);\n\n&quot;</span></span><br><span class="line">    js += <span class="string">&#x27;//beginjs\n&#x27;</span></span><br><span class="line">    js += htmlctx[<span class="string">&#x27;htmlvargen&#x27;</span>]</span><br><span class="line">    js += jsgrammar._generate_code(num_lines, htmlctx[<span class="string">&#x27;htmlvars&#x27;</span>])</span><br><span class="line">    js += <span class="string">&#x27;\n//endjs\n&#x27;</span></span><br><span class="line">    js += <span class="string">&#x27;var fuzzervars = &#123;&#125;;\nfreememory()\n&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> js</span><br></pre></td></tr></table></figure>

<p>generate_new_sample函数调试跟踪。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># html变量某次结果</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">longdesc</span>=<span class="string">&quot;^r&#123;=g$3-<span class="symbol">&amp;#x27;</span>f<span class="symbol">&amp;gt;</span>&#125;N7&quot;</span> <span class="attr">is</span>=<span class="string">&quot;x-rect&quot;</span> <span class="attr">srcdoc</span>=<span class="string">&quot;!m!VM)u&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;1&quot;</span> <span class="attr">srcdoc</span>=<span class="string">&quot;gPd80b6D0g&quot;</span> <span class="attr">style</span>=<span class="string">&quot;scroll-snap-points-y: inherit; mso-font-kerning: 6pt; border-bottom-left-radius: -1px; border-right-style: hidden; overflow-y: auto&quot;</span> <span class="attr">download</span>=<span class="string">&quot;^<span class="symbol">&amp;lt;</span>&quot;</span> <span class="attr">formnovalidate</span>=<span class="string">&quot;formnovalidate&quot;</span> <span class="attr">srcset</span>=<span class="string">&quot;AJZ=1<span class="symbol">&amp;#x27;</span>btpN<span class="symbol">&amp;#x27;</span>=&quot;</span> <span class="attr">formmethod</span>=<span class="string">&quot;get&quot;</span>&gt;</span>t;3qg<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">dir</span>=<span class="string">&quot;rtl&quot;</span> <span class="attr">style</span>=<span class="string">&quot;clip-path: url(#htmlvar00006); grid-template-areas: &#x27;a&#x27;; overflow-wrap: break-word; width: 1pt; tab-size: 0&quot;</span> <span class="attr">style</span>=<span class="string">&quot;stroke-dashoffset: 30px; word-spacing: 0ex; stroke-linecap: round; stroke-opacity: 1; column-break-before: always&quot;</span> <span class="attr">style</span>=<span class="string">&quot;-webkit-margin-collapse: collapse separate; font-feature-settings: &#x27;liga&#x27; 1; hyphens: auto; border-radius: -1 0 0px 42; border-bottom-right-radius: 0px&quot;</span> <span class="attr">name</span>=<span class="string">&quot;\uJItGlTNA&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span> <span class="attr">behavior</span>=<span class="string">&quot;scroll&quot;</span> <span class="attr">autoload</span>=<span class="string">&quot;autoload&quot;</span> <span class="attr">face</span>=<span class="string">&quot;Arial,helvetica&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span>&gt;</span>|Z l<span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># add_html_ids处理后后htmlctx的结果</span><br><span class="line">   &#123;&#x27;htmlvars&#x27;: [&#123;&#x27;name&#x27;: &#x27;htmlvar00001&#x27;, &#x27;type&#x27;: &#x27;HTMLIFrameElement&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;htmlvar00002&#x27;, &#x27;type&#x27;: &#x27;HTMLCanvasElement&#x27;&#125;...], </span><br><span class="line">   &#x27;htmlvarctr&#x27;: 20, </span><br><span class="line">   &#x27;svgvarctr&#x27;: 0, </span><br><span class="line">   &#x27;htmlvargen&#x27;: &#x27;/* newvar&#123;htmlvar00001:HTMLIFrameElement&#125; */ var htmlvar00001 = document.getElementById(&quot;htmlvar00001&quot;); //HTMLIFrameElement\n/* newvar&#123;htmlvar00002:HTMLCanvasElement&#125; */ var htmlvar00002 = document.getElementById(&quot;htmlvar00002&quot;); //HTMLCanvasElement\n ...&#x27;&#125;</span><br><span class="line"></span><br><span class="line"># htm的结果，在标签后面加上了id</span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;htmlvar00001&quot;</span> <span class="attr">longdesc</span>=<span class="string">&quot;^r&#123;=g$3-<span class="symbol">&amp;#x27;</span>f<span class="symbol">&amp;gt;</span>&#125;N7&quot;</span> <span class="attr">is</span>=<span class="string">&quot;x-rect&quot;</span> <span class="attr">srcdoc</span>=<span class="string">&quot;!m!VM)u&quot;</span> <span class="attr">frameborder</span>=<span class="string">&quot;1&quot;</span> <span class="attr">srcdoc</span>=<span class="string">&quot;gPd80b6D0g&quot;</span> <span class="attr">style</span>=<span class="string">&quot;scroll-snap-points-y: inherit; mso-font-kerning: 6pt; border-bottom-left-radius: -1px; border-right-style: hidden; overflow-y: auto&quot;</span> <span class="attr">download</span>=<span class="string">&quot;^<span class="symbol">&amp;lt;</span>&quot;</span> <span class="attr">formnovalidate</span>=<span class="string">&quot;formnovalidate&quot;</span> <span class="attr">srcset</span>=<span class="string">&quot;AJZ=1<span class="symbol">&amp;#x27;</span>btpN<span class="symbol">&amp;#x27;</span>=&quot;</span> <span class="attr">formmethod</span>=<span class="string">&quot;get&quot;</span>&gt;</span>t;3qg<span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;htmlvar00002&quot;</span> <span class="attr">dir</span>=<span class="string">&quot;rtl&quot;</span> <span class="attr">style</span>=<span class="string">&quot;clip-path: url(#htmlvar00006); grid-template-areas: &#x27;a&#x27;; overflow-wrap: break-word; width: 1pt; tab-size: 0&quot;</span> <span class="attr">style</span>=<span class="string">&quot;stroke-dashoffset: 30px; word-spacing: 0ex; stroke-linecap: round; stroke-opacity: 1; column-break-before: always&quot;</span> <span class="attr">style</span>=<span class="string">&quot;-webkit-margin-collapse: collapse separate; font-feature-settings: &#x27;liga&#x27; 1; hyphens: auto; border-radius: -1 0 0px 42; border-bottom-right-radius: 0px&quot;</span> <span class="attr">name</span>=<span class="string">&quot;\uJItGlTNA&quot;</span> <span class="attr">seed</span>=<span class="string">&quot;0&quot;</span> <span class="attr">behavior</span>=<span class="string">&quot;scroll&quot;</span> <span class="attr">autoload</span>=<span class="string">&quot;autoload&quot;</span> <span class="attr">face</span>=<span class="string">&quot;Arial,helvetica&quot;</span> <span class="attr">marginwidth</span>=<span class="string">&quot;0&quot;</span>&gt;</span>|Z l<span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># generate_html_elements处理后htmlctx的结果：htmlvars和htmlvargen后面都又增加了5个元素。但是该函数没有更新html变量。</span><br><span class="line">   &#123;&#x27;htmlvars&#x27;: [&#123;&#x27;name&#x27;: &#x27;htmlvar00001&#x27;, &#x27;type&#x27;: &#x27;HTMLIFrameElement&#x27;&#125;, &#123;&#x27;name&#x27;: &#x27;htmlvar00002&#x27;, &#x27;type&#x27;: &#x27;HTMLCanvasElement&#x27;&#125;...], </span><br><span class="line">   &#x27;htmlvarctr&#x27;: 25, </span><br><span class="line">   &#x27;svgvarctr&#x27;: 0, </span><br><span class="line">   &#x27;htmlvargen&#x27;: &#x27;/* newvar&#123;htmlvar00001:HTMLIFrameElement&#125; */ var htmlvar00001 = document.getElementById(&quot;htmlvar00001&quot;); //HTMLIFrameElement\n/* newvar&#123;htmlvar00002:HTMLCanvasElement&#125; */ var htmlvar00002 = document.getElementById(&quot;htmlvar00002&quot;); //HTMLCanvasElement\n ...&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>经过上面的过程，可以将我们给定的模板进行替换，模板大致如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- saved from url=(0014)about:internet --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"></span></span><br><span class="line"><span class="css"><span class="comment">/*begincss*/</span></span></span><br><span class="line"><span class="css">&lt;cssfuzzer&gt;</span></span><br><span class="line"><span class="css"><span class="comment">/*endcss*/</span></span></span><br><span class="line"><span class="css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">freememory</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">try</span> &#123; CollectGarbage(); &#125; <span class="keyword">catch</span>(err) &#123; &#125;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">try</span> &#123; FuzzingFunctions.garbageCollect(); &#125; <span class="keyword">catch</span>(err) &#123; &#125;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">try</span> &#123; FuzzingFunctions.cycleCollect(); &#125; <span class="keyword">catch</span>(err) &#123; &#125;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">try</span> &#123; <span class="built_in">window</span>.gc(); &#125; <span class="keyword">catch</span>(err) &#123; &#125;</span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> runcount = &#123;<span class="string">&#x27;jsfuzzer&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;eventhandler1&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;eventhandler2&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;eventhandler3&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;eventhandler4&#x27;</span>:<span class="number">0</span>, <span class="string">&#x27;eventhandler5&#x27;</span>:<span class="number">0</span>&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">GetVariable</span>(<span class="params">fuzzervars, var_type</span>) </span>&#123; <span class="keyword">if</span>(fuzzervars[var_type]) &#123; <span class="keyword">return</span> fuzzervars[var_type]; &#125; <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">SetVariable</span>(<span class="params">fuzzervars, var_name, var_type</span>) </span>&#123; fuzzervars[var_type] = var_name; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">jsfuzzer</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;jsfuzzer&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;jsfuzzer&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">eventhandler1</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;eventhandler1&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;eventhandler1&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">eventhandler2</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;eventhandler2&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;eventhandler2&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">eventhandler3</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;eventhandler3&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;eventhandler3&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">eventhandler4</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;eventhandler4&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;eventhandler4&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"><span class="function"><span class="keyword">function</span> <span class="title">eventhandler5</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">runcount[<span class="string">&quot;eventhandler5&quot;</span>]++; <span class="keyword">if</span>(runcount[<span class="string">&quot;eventhandler5&quot;</span>] &gt; <span class="number">2</span>) &#123; <span class="keyword">return</span>; &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&lt;jsfuzzer&gt;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">jsfuzzer()</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--beginhtml--&gt;</span><span class="tag">&lt;<span class="name">htmlfuzzer</span>&gt;</span><span class="comment">&lt;!--endhtml--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>分别将<htmlfuzzer>，<jsfuzzer>，<cssfuzzer>在对应的位置进行替换，只要保证模板语法正确，生成的html，css，js语法正确，并可以通过js成功与DOM元素进行交互，在对变量的边界值做个界定，这样一个生成各个html样本的生成器就完成了，当然generator.py这个文件只是个壳子，真正的功能点在grammar.py实现，还有我们自定义的语法文件，我们可以根据自己的需要定制化规则和代码。</p>
<p>关键函数的流程大致如下，</p>
<p><img src="/2022/04/14/domato101/image-20220117201908982.png" alt="image-20220117201908982"></p>
<h3 id="grammar-py-1"><a href="#grammar-py-1" class="headerlink" title="grammar.py"></a>grammar.py</h3><p>上面我们有几块代码没有跟，分别是generate_samples函数调用的<code>parse_from_file</code>，generate_new_sample函数调用的<code>generate_symbol</code>还有generate_function_body函数调用的<code>_generate_code</code>。在上面对代码分析时也已经大概了解了这三个函数相关的功能了</p>
<p><code>parse_from_file</code>：从文件中解析语法并生成一个操作”类”，可以使用该”类”进行一些函数操作。</p>
<p><code>generate_symbol</code>：使用上面的操作”类”生成随机的html和css代码。</p>
<p><code>_generate_code</code>：使用上面的操作”类”生成随机的js代码。</p>
<p>最开始还有一个类的定义，Grammar()，我们先看下Grammar类的代码</p>
<h4 id="Grammar"><a href="#Grammar" class="headerlink" title="Grammar"></a>Grammar</h4><p>这个类接近1000行代码，就不贴了，其实grammar.py文件主要的逻辑都在里面，所以我们研究那三个函数即可。这里贴出定义结构体的代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grammar</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">   <span class="comment"># 接近1000行</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self._root = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        self._creators = &#123;&#125;</span><br><span class="line">        self._nonrecursive_creators = &#123;&#125;</span><br><span class="line">        self._all_rules = []</span><br><span class="line">        self._interesting_lines = &#123;&#125;</span><br><span class="line">        self._all_nonhelper_lines = []</span><br><span class="line"></span><br><span class="line">        self._creator_cdfs = &#123;&#125;</span><br><span class="line">        self._nonrecursivecreator_cdfs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self._var_format = <span class="string">&#x27;var%05d&#x27;</span></span><br><span class="line"></span><br><span class="line">        self._definitions_dir = <span class="string">&#x27;.&#x27;</span></span><br><span class="line"></span><br><span class="line">        self._imports = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self._functions = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self._line_guard = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        self._recursion_max = <span class="number">50</span></span><br><span class="line">        self._var_reuse_prob = <span class="number">0.75</span></span><br><span class="line">        self._interesting_line_prob = <span class="number">0.9</span></span><br><span class="line">        self._max_vars_of_same_type = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">        self._inheritance = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        self._cssgrammar = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Helper dictionaries for creating built-in types.</span></span><br><span class="line">        self._constant_types = &#123;</span><br><span class="line">            <span class="string">&#x27;lt&#x27;</span>: <span class="string">&#x27;&lt;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;gt&#x27;</span>: <span class="string">&#x27;&gt;&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;hash&#x27;</span>: <span class="string">&#x27;#&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;cr&#x27;</span>: <span class="built_in">chr</span>(<span class="number">13</span>),</span><br><span class="line">            <span class="string">&#x27;lf&#x27;</span>: <span class="built_in">chr</span>(<span class="number">10</span>),</span><br><span class="line">            <span class="string">&#x27;space&#x27;</span>: <span class="string">&#x27; &#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;tab&#x27;</span>: <span class="built_in">chr</span>(<span class="number">9</span>),</span><br><span class="line">            <span class="string">&#x27;ex&#x27;</span>: <span class="string">&#x27;!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self._built_in_types = &#123;</span><br><span class="line">            <span class="string">&#x27;int&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;int32&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;uint32&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;int8&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;uint8&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;int16&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;uint16&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;int64&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;uint64&#x27;</span>: self._generate_int,</span><br><span class="line">            <span class="string">&#x27;float&#x27;</span>: self._generate_float,</span><br><span class="line">            <span class="string">&#x27;double&#x27;</span>: self._generate_float,</span><br><span class="line">            <span class="string">&#x27;char&#x27;</span>: self._generate_char,</span><br><span class="line">            <span class="string">&#x27;string&#x27;</span>: self._generate_string,</span><br><span class="line">            <span class="string">&#x27;htmlsafestring&#x27;</span>: self._generate_html_string,</span><br><span class="line">            <span class="string">&#x27;hex&#x27;</span>: self._generate_hex,</span><br><span class="line">            <span class="string">&#x27;import&#x27;</span>: self._generate_import,</span><br><span class="line">            <span class="string">&#x27;lines&#x27;</span>: self._generate_lines</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        self._command_handlers = &#123;</span><br><span class="line">            <span class="string">&#x27;varformat&#x27;</span>: self._set_variable_format,</span><br><span class="line">            <span class="string">&#x27;include&#x27;</span>: self._include_from_file,</span><br><span class="line">            <span class="string">&#x27;import&#x27;</span>: self._import_grammar,</span><br><span class="line">            <span class="string">&#x27;lineguard&#x27;</span>: self._set_line_guard,</span><br><span class="line">            <span class="string">&#x27;max_recursion&#x27;</span>: self._set_recursion_depth,</span><br><span class="line">            <span class="string">&#x27;var_reuse_prob&#x27;</span>: self._set_var_reuse_probability,</span><br><span class="line">            <span class="string">&#x27;extends&#x27;</span>: self._set_extends</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<h4 id="parse-from-file"><a href="#parse-from-file" class="headerlink" title="parse_from_file"></a>parse_from_file</h4><p><code>parse_from_file</code>函数并没有做太多的工作，读取了传入的语法文件，并将内容放入content中，之后调用<code>parse_from_string</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse_from_file</span>(<span class="params">self, filename</span>):</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;从文件中解析语法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">打开一个txt文件，解析并加载语法规则，语法详情查看readme。</span></span><br><span class="line"><span class="string">import可以使语法文件包含其他语法文件。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Args:</span></span><br><span class="line"><span class="string">          filename: 语法文件绝对路径</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      Returns:</span></span><br><span class="line"><span class="string">         错误号，便于排查错误。</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">... </span></span><br><span class="line">      <span class="keyword">return</span> self.parse_from_string(content)		<span class="comment"># 使用content变量将文件内容存储起来。</span></span><br></pre></td></tr></table></figure>

<h5 id="parse-from-string"><a href="#parse-from-string" class="headerlink" title="parse_from_string"></a>parse_from_string</h5><p>该函数相当于解析的主函数。</p>
<p>使用了<code>_include_from_string</code>将文件中的语法放入其对应的grammar中，这个grammar在generator.py中为htmlgrammar，cssgrammar，jsgrammar。</p>
<p><code>_normalize_probabilities</code>会统计语法中出现的概率，放入self中的<code>_creator_cdfs</code>和<code>_nonrecursivecreator_cdfs</code>字段中。</p>
<p><code>_compute_interesting_indices</code>会统计js代码中“有趣”的行，并在之后生成js随机代码中出现更高的频率。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_from_string</span>(<span class="params">self, grammar_str</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;从字符串中解析语法</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     将字符串按行解析并加载语法规则。语法详情查看readme。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        grammar_str: 从与反文件中读取的语法，以字符串格式进行存储。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        错误号，便于排查错误。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    errors = self._include_from_string(grammar_str)				<span class="comment"># 将语法从grammar_str放入self中</span></span><br><span class="line">    <span class="keyword">if</span> errors:</span><br><span class="line">        <span class="keyword">return</span> errors</span><br><span class="line"></span><br><span class="line">    self._normalize_probabilities()											<span class="comment"># 统计语法中出现的概率，放入self中的某个字段中</span></span><br><span class="line">    self._compute_interesting_indices()									<span class="comment"># 在传入文件为js.txt时第一次起作用。该函数会判断每行是否有&lt;line&gt;，而js.txt中存在</span></span><br><span class="line">    																						<span class="comment"># !lineguard try &#123; &lt;line&gt; &#125; catch(e) &#123; &#125;</span></span><br><span class="line">        																					<span class="comment"># 会让js.txt每行都尝试加入一个&lt;line&gt;，从而触发该函数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h5 id="include-from-string"><a href="#include-from-string" class="headerlink" title="_include_from_string"></a>_include_from_string</h5><p>跟入函数，该函数为语法存储的关键函数。首先识别每行是否为注释，如果为注释则不处理，之后匹配是否为预定义命令，比如<code>!include</code>等等，如果识别到则交由对应的函数进行处理。否则就使用<code>_parse_grammar_line</code>处理每行代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_include_from_string</span>(<span class="params">self, grammar_str</span>):</span></span><br><span class="line">       in_code = <span class="literal">False</span></span><br><span class="line">       helper_lines = <span class="literal">False</span></span><br><span class="line">       in_function = <span class="literal">False</span></span><br><span class="line">       num_errors = <span class="number">0</span></span><br><span class="line">       lines = grammar_str.split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">       <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> <span class="keyword">not</span> in_function:</span><br><span class="line">               cleanline = self._remove_comments(line)				<span class="comment"># 删除每行的注释</span></span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">not</span> cleanline:</span><br><span class="line">                   <span class="keyword">continue</span></span><br><span class="line">           <span class="keyword">else</span>:</span><br><span class="line">               cleanline = line</span><br><span class="line"></span><br><span class="line">           <span class="comment"># Process special commands</span></span><br><span class="line">           match = re.match(<span class="string">r&#x27;^!([a-z_]+)\s*(.*)$&#x27;</span>, cleanline)</span><br><span class="line">           <span class="keyword">if</span> match:																								<span class="comment"># 当匹配到预定义命令。 eg:    &#x27;!include common.txt&#x27;</span></span><br><span class="line">               command = match.group(<span class="number">1</span>)															<span class="comment"># eg: include</span></span><br><span class="line">               params = match.group(<span class="number">2</span>)																	<span class="comment"># eg: common.txt</span></span><br><span class="line">               <span class="string">&quot;&quot;&quot;        </span></span><br><span class="line"><span class="string">       self._command_handlers = &#123;</span></span><br><span class="line"><span class="string">           &#x27;varformat&#x27;: self._set_variable_format,</span></span><br><span class="line"><span class="string">           &#x27;include&#x27;: self._include_from_file,</span></span><br><span class="line"><span class="string">           &#x27;import&#x27;: self._import_grammar,</span></span><br><span class="line"><span class="string">           &#x27;lineguard&#x27;: self._set_line_guard,</span></span><br><span class="line"><span class="string">           &#x27;max_recursion&#x27;: self._set_recursion_depth,</span></span><br><span class="line"><span class="string">           &#x27;var_reuse_prob&#x27;: self._set_var_reuse_probability,</span></span><br><span class="line"><span class="string">           &#x27;extends&#x27;: self._set_extends</span></span><br><span class="line"><span class="string">       &#125;&quot;&quot;&quot;</span></span><br><span class="line">               <span class="keyword">if</span> command <span class="keyword">in</span> self._command_handlers:										<span class="comment"># 匹配到相关的关键词时调用对应的函数。</span></span><br><span class="line">                   self._command_handlers[command](params)								<span class="comment"># eg:  &#x27;include&#x27;: self._include_from_file,</span></span><br><span class="line">               <span class="keyword">elif</span> command == <span class="string">&#x27;begin&#x27;</span> <span class="keyword">and</span> params == <span class="string">&#x27;lines&#x27;</span>:</span><br><span class="line">                   in_code = <span class="literal">True</span></span><br><span class="line">                   helper_lines = <span class="literal">False</span></span><br><span class="line">               <span class="keyword">elif</span> command == <span class="string">&#x27;begin&#x27;</span> <span class="keyword">and</span> params == <span class="string">&#x27;helperlines&#x27;</span>:</span><br><span class="line">                   in_code = <span class="literal">True</span></span><br><span class="line">                   helper_lines = <span class="literal">True</span></span><br><span class="line">               <span class="keyword">elif</span> command == <span class="string">&#x27;end&#x27;</span> <span class="keyword">and</span> params <span class="keyword">in</span> (<span class="string">&#x27;lines&#x27;</span>, <span class="string">&#x27;helperlines&#x27;</span>):</span><br><span class="line">                   <span class="keyword">if</span> in_code:</span><br><span class="line">                       in_code = <span class="literal">False</span></span><br><span class="line">               <span class="keyword">elif</span> command == <span class="string">&#x27;begin&#x27;</span> <span class="keyword">and</span> params.startswith(<span class="string">&#x27;function&#x27;</span>):</span><br><span class="line">                   match = re.match(<span class="string">r&#x27;^function\s*([a-zA-Z._0-9]+)$&#x27;</span>, params)</span><br><span class="line">                   <span class="keyword">if</span> match <span class="keyword">and</span> <span class="keyword">not</span> in_function:</span><br><span class="line">                       function_name = match.group(<span class="number">1</span>)</span><br><span class="line">                       function_body = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                       in_function = <span class="literal">True</span></span><br><span class="line">                   <span class="keyword">else</span>:</span><br><span class="line">                       <span class="built_in">print</span>(<span class="string">&#x27;Error parsing line &#x27;</span> + line)</span><br><span class="line">                       num_errors += <span class="number">1</span></span><br><span class="line">               <span class="keyword">elif</span> command == <span class="string">&#x27;end&#x27;</span> <span class="keyword">and</span> params == <span class="string">&#x27;function&#x27;</span>:</span><br><span class="line">                   <span class="keyword">if</span> in_function:</span><br><span class="line">                       in_function = <span class="literal">False</span></span><br><span class="line">                       self._save_function(function_name, function_body)</span><br><span class="line">               <span class="keyword">else</span>:</span><br><span class="line">                   <span class="built_in">print</span>(<span class="string">&#x27;Unknown command: &#x27;</span> + command)</span><br><span class="line">                   num_errors += <span class="number">1</span></span><br><span class="line">               <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span>:</span><br><span class="line">               <span class="keyword">if</span> in_function:</span><br><span class="line">                   function_body += cleanline + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">               <span class="keyword">elif</span> in_code:</span><br><span class="line">                   self._parse_code_line(cleanline, helper_lines)				<span class="comment"># 如果是code则交由该函数处理</span></span><br><span class="line">               <span class="keyword">else</span>:</span><br><span class="line">                   self._parse_grammar_line(cleanline)								<span class="comment"># 每行语法一般都交由该函数进行处理</span></span><br><span class="line">           <span class="keyword">except</span> GrammarError:</span><br><span class="line">               <span class="built_in">print</span>(<span class="string">&#x27;Error parsing line &#x27;</span> + line)</span><br><span class="line">               num_errors += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> num_errors</span><br></pre></td></tr></table></figure>

<h5 id="parse-grammar-line"><a href="#parse-grammar-line" class="headerlink" title="_parse_grammar_line"></a>_parse_grammar_line</h5><p>可以看出代码逻辑主要将传入的<code>line</code>放<code>入self._all_rules</code>中。也会在<code>self._creators</code>的对应<code>tag_name</code>中放入对应的元素。该函数的作用主要是将传入的一行语法录入到self的属性中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_parse_grammar_line</span>(<span class="params">self, line</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parses a grammar rule.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># Check if the line matches grammar rule pattern (&lt;tagname&gt; = ...).</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Parse the line to create a grammar rule.</span></span><br><span class="line">    ...</span><br><span class="line">   </span><br><span class="line">    <span class="comment"># Splits the line into constant parts and tags. For example</span></span><br><span class="line">    <span class="comment"># &quot;foo&lt;bar&gt;baz&quot; would be split into three parts, &quot;foo&quot;, &quot;bar&quot; and &quot;baz&quot;</span></span><br><span class="line">    <span class="comment"># Every other part is going to be constant and every other part</span></span><br><span class="line">    <span class="comment"># is going to be a tag, always starting with a constant. Empty</span></span><br><span class="line">    <span class="comment"># spaces between tags/beginning/end are not a problem because</span></span><br><span class="line">    <span class="comment"># then empty strings will be returned in corresponding places,</span></span><br><span class="line">    <span class="comment"># for example &quot;&lt;foo&gt;&lt;bar&gt;&quot; gets split into &quot;&quot;, &quot;foo&quot;, &quot;&quot;, &quot;bar&quot;, &quot;&quot;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Store the rule in appropriate sets.</span></span><br><span class="line">    create_tag_name = rule[<span class="string">&#x27;creates&#x27;</span>][<span class="string">&#x27;tagname&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> create_tag_name <span class="keyword">in</span> self._creators:</span><br><span class="line">        self._creators[create_tag_name].append(rule)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self._creators[create_tag_name] = [rule]</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;nonrecursive&#x27;</span> <span class="keyword">in</span> rule[<span class="string">&#x27;creates&#x27;</span>]:</span><br><span class="line">        <span class="keyword">if</span> create_tag_name <span class="keyword">in</span> self._nonrecursive_creators:</span><br><span class="line">            self._nonrecursive_creators[create_tag_name].append(rule)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._nonrecursive_creators[create_tag_name] = [rule]</span><br><span class="line">    self._all_rules.append(rule)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;root&#x27;</span> <span class="keyword">in</span> rule[<span class="string">&#x27;creates&#x27;</span>]:</span><br><span class="line">        self._root = create_tag_name</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<h5 id="parse-code-line"><a href="#parse-code-line" class="headerlink" title="_parse_code_line"></a>_parse_code_line</h5><p>可以看到44-47行，会对 self._creators[‘line’]添加一些元素，这会对后面<code>_compute_interesting_indices</code>起作用，我们可以说如果在<code>self._creators[&#39;line&#39;]</code>中的元素可能是“有趣”的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_parse_code_line</span>(<span class="params">self, line, helper_lines=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Parses a rule for generating code.&quot;&quot;&quot;</span></span><br><span class="line">    rule = &#123;</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;code&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;parts&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;creates&#x27;</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># Splits the line into constant parts and tags. For example</span></span><br><span class="line">    <span class="comment"># &quot;foo&lt;bar&gt;baz&quot; would be split into three parts, &quot;foo&quot;, &quot;bar&quot; and &quot;baz&quot;</span></span><br><span class="line">    <span class="comment"># Every other part is going to be constant and every other part</span></span><br><span class="line">    <span class="comment"># is going to be a tag, always starting with a constant. Empty</span></span><br><span class="line">    <span class="comment"># spaces between tags/beginning/end are not a problem because</span></span><br><span class="line">    <span class="comment"># then empty strings will be returned in corresponding places,</span></span><br><span class="line">    <span class="comment"># for example &quot;&lt;foo&gt;&lt;bar&gt;&quot; gets split into &quot;&quot;, &quot;foo&quot;, &quot;&quot;, &quot;bar&quot;, &quot;&quot;</span></span><br><span class="line">    rule_parts = re.split(<span class="string">r&#x27;&lt;([^&gt;)]*)&gt;&#x27;</span>, line)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(rule_parts)):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> rule_parts[i]:</span><br><span class="line">                rule[<span class="string">&#x27;parts&#x27;</span>].append(&#123;</span><br><span class="line">                    <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;text&#x27;</span>: rule_parts[i]</span><br><span class="line">                &#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            parsedtag = self._parse_tag_and_attributes(rule_parts[i])</span><br><span class="line">            rule[<span class="string">&#x27;parts&#x27;</span>].append(parsedtag)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;new&#x27;</span> <span class="keyword">in</span> parsedtag:</span><br><span class="line">                rule[<span class="string">&#x27;creates&#x27;</span>].append(parsedtag)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> tag <span class="keyword">in</span> rule[<span class="string">&#x27;creates&#x27;</span>]:</span><br><span class="line">        tag_name = tag[<span class="string">&#x27;tagname&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> tag_name <span class="keyword">in</span> _NONINTERESTING_TYPES:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> tag_name <span class="keyword">in</span> self._creators:</span><br><span class="line">            self._creators[tag_name].append(rule)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._creators[tag_name] = [rule]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;nonrecursive&#x27;</span> <span class="keyword">in</span> tag:</span><br><span class="line">            <span class="keyword">if</span> tag_name <span class="keyword">in</span> self._nonrecursive_creators:</span><br><span class="line">                self._nonrecursive_creators[tag_name].append(rule)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._nonrecursive_creators[tag_name] = [rule]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> helper_lines:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;line&#x27;</span> <span class="keyword">in</span> self._creators:</span><br><span class="line">            self._creators[<span class="string">&#x27;line&#x27;</span>].append(rule)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self._creators[<span class="string">&#x27;line&#x27;</span>] = [rule]</span><br><span class="line"></span><br><span class="line">    self._all_rules.append(rule)</span><br></pre></td></tr></table></figure>

<h5 id="normalize-probabilities"><a href="#normalize-probabilities" class="headerlink" title="_normalize_probabilities"></a>_normalize_probabilities</h5><p>主要就是遍历了下<code>self._creators</code>与<code>self._nonrecursive_creators</code>，而它们在之前调用<code>_include_from_string</code>函数时被赋值了。遍历后调用<code>_get_cdf</code>来统计哪些tag使用了概率，并放入_creator_cdfs字典中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_normalize_probabilities</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Preprocessess probabilities for production rules.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Creates CDFs (cumulative distribution functions) and normalizes</span></span><br><span class="line"><span class="string">    probabilities in the [0,1] range for all creators. This is a</span></span><br><span class="line"><span class="string">    preprocessing function that makes subsequent creator selection</span></span><br><span class="line"><span class="string">    based on probability easier.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> symbol, creators <span class="keyword">in</span> self._creators.items():</span><br><span class="line">        cdf = self._get_cdf(symbol, creators)</span><br><span class="line">        self._creator_cdfs[symbol] = cdf								<span class="comment"># 维护了一个字典_creator_cdfs，分别表示每个tag对应的概率分布。</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> symbol, creators <span class="keyword">in</span> self._nonrecursive_creators.items():</span><br><span class="line">        cdf = self._get_cdf(symbol, creators)</span><br><span class="line">        self._nonrecursivecreator_cdfs[symbol] = cdf</span><br><span class="line">        </span><br><span class="line">        <span class="string">&quot;&quot;&quot; eg: 处理common.txt</span></span><br><span class="line"><span class="string">        _creator_cdfs = &#123;&#x27;newline&#x27;: [], &#x27;interestingint&#x27;: [], &#x27;fuzzint&#x27;: [], &#x27;short&#x27;: [1.0], &#x27;boolean&#x27;: [], &#x27;percentage&#x27;: [], &#x27;elementid&#x27;: [], &#x27;svgelementid&#x27;: [], &#x27;class&#x27;: [], &#x27;color&#x27;: [], &#x27;tagname&#x27;: [], &#x27;svgtagname&#x27;: [], &#x27;imgsrc&#x27;: [], &#x27;videosrc&#x27;: [], &#x27;audiosrc&#x27;: []&#125;</span></span><br><span class="line"><span class="string">        _nonrecursivecreator_cdfs = &#123;&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="compute-interesting-indices"><a href="#compute-interesting-indices" class="headerlink" title="_compute_interesting_indices"></a>_compute_interesting_indices</h5><p>主要判断每个line是否有一些不”有趣“的特征，比如<code>type</code>不为<code>text</code>，<code>tagname</code>不在<code>_NONINTERESTING_TYPES</code>中等等，这块通过黑名单的方式进行实现，后续可以通过再添加黑名单进一步优化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_compute_interesting_indices</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment"># select interesting lines for each variable type</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;line&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> self._creators:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self._creators[<span class="string">&#x27;line&#x27;</span>])):</span><br><span class="line">        self._all_nonhelper_lines.append(i)</span><br><span class="line">        rule = self._creators[<span class="string">&#x27;line&#x27;</span>][i]</span><br><span class="line">        <span class="keyword">for</span> part <span class="keyword">in</span> rule[<span class="string">&#x27;parts&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> part[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;text&#x27;</span>:									<span class="comment"># not intersting</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            tagname = part[<span class="string">&#x27;tagname&#x27;</span>]</span><br><span class="line">            <span class="keyword">if</span> tagname <span class="keyword">in</span> _NONINTERESTING_TYPES:			<span class="comment"># not intersting</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;new&#x27;</span> <span class="keyword">in</span> part:												<span class="comment"># not intersting</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> tagname <span class="keyword">not</span> <span class="keyword">in</span> self._interesting_lines:</span><br><span class="line">                self._interesting_lines[tagname] = []</span><br><span class="line">            self._interesting_lines[tagname].append(i)</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/14/domato101/image-20220118102602184.png" alt="image-20220118102602184"></p>
<h4 id="generate-symbol"><a href="#generate-symbol" class="headerlink" title="generate_symbol"></a>generate_symbol</h4><p>generate_symbol函数之前我们猜测是随机生成html和css代码的函数。我们跟入该函数去验证我们的猜想。</p>
<p>函数逻辑基本定义了个结构体之后调用了<code>_generate</code>函数，跟入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_symbol</span>(<span class="params">self, name</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Expands a symbol whose name is given as an argument.&quot;&quot;&quot;</span></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">&#x27;lastvar&#x27;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&#x27;lines&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;variables&#x27;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&#x27;force_var_reuse&#x27;</span>: <span class="literal">False</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> self._generate(name, context, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h5 id="generate"><a href="#generate" class="headerlink" title="_generate"></a>_generate</h5><p>首先检查我们是否已经有给定类型的变量（对应30行位置处的if判断）。而这段代码只有在生成js代码时才会调用，所以我们后续讨论。</p>
<p>之后调用了<code>_select_creator</code>和<code>_expand_rule</code>函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate</span>(<span class="params">self, symbol, context, recursion_depth=<span class="number">0</span>, force_nonrecursive=<span class="literal">False</span></span>):</span></span><br><span class="line">       <span class="string">&quot;&quot;&quot;生成用户定义的symbol.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       为给定符号选择规则并解析规则的右侧。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Args:</span></span><br><span class="line"><span class="string">           symbol: 要被解析的符号名</span></span><br><span class="line"><span class="string">           context: 字典包括:</span></span><br><span class="line"><span class="string">               &#x27;lastvar&#x27;: 创建的最后一个变量的索引。</span></span><br><span class="line"><span class="string">               &#x27;lines&#x27;: 生成的代码行。（用于编程语言生成）。</span></span><br><span class="line"><span class="string">               &#x27;variables&#x27;: 包含迄今为止创建的所有变量名称的字典。</span></span><br><span class="line"><span class="string">           recursion_depth:当前递归深度。</span></span><br><span class="line"><span class="string">           force_nonrecursive: 是否强制只使用非递归规则。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Returns:</span></span><br><span class="line"><span class="string">           包含符号扩展的字符串。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       Raises:</span></span><br><span class="line"><span class="string">           GrammarError: 如果语法描述不正确导致某些规则无法解析</span></span><br><span class="line"><span class="string">           RecursionError: 如果达到最大递归级别。</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># print symbol</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># print &#x27;Expanding &#x27; + symbol + &#x27; in depth &#x27; + str(recursion_depth)</span></span><br><span class="line"></span><br><span class="line">       force_var_reuse = context[<span class="string">&#x27;force_var_reuse&#x27;</span>]			<span class="comment"># 强制变量重用</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># Check if we already have a variable of the given type.</span></span><br><span class="line">       <span class="keyword">if</span> (symbol <span class="keyword">in</span> context[<span class="string">&#x27;variables&#x27;</span>] <span class="keyword">and</span></span><br><span class="line">               symbol <span class="keyword">not</span> <span class="keyword">in</span> _NONINTERESTING_TYPES):</span><br><span class="line">           <span class="comment"># print symbol + &#x27;:&#x27; + str(len(context[&#x27;variables&#x27;][symbol])) + &#x27;:&#x27; + str(force_var_reuse)</span></span><br><span class="line">           <span class="keyword">if</span> (force_var_reuse <span class="keyword">or</span></span><br><span class="line">                   random.random() &lt; self._var_reuse_prob <span class="keyword">or</span></span><br><span class="line">                   <span class="built_in">len</span>(context[<span class="string">&#x27;variables&#x27;</span>][symbol]) &gt; self._max_vars_of_same_type):</span><br><span class="line">               <span class="comment"># print &#x27;reusing existing var of type &#x27; + symbol</span></span><br><span class="line">               context[<span class="string">&#x27;force_var_reuse&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">               variables = context[<span class="string">&#x27;variables&#x27;</span>][symbol]</span><br><span class="line">               <span class="keyword">return</span> variables[random.randint(<span class="number">0</span>, <span class="built_in">len</span>(variables) - <span class="number">1</span>)]</span><br><span class="line">               <span class="comment"># print &#x27;Not reusing existing var of type &#x27; + symbol</span></span><br><span class="line"></span><br><span class="line">       creator = self._select_creator(</span><br><span class="line">           symbol,</span><br><span class="line">           recursion_depth,</span><br><span class="line">           force_nonrecursive</span><br><span class="line">       )</span><br><span class="line">       <span class="keyword">return</span> self._expand_rule(</span><br><span class="line">           symbol,</span><br><span class="line">           creator,</span><br><span class="line">           context,</span><br><span class="line">           recursion_depth,</span><br><span class="line">           force_nonrecursive</span><br><span class="line">       )</span><br></pre></td></tr></table></figure>

<p>首先看下<code>_select_creator</code>的代码逻辑。</p>
<h5 id="select-creator"><a href="#select-creator" class="headerlink" title="_select_creator"></a>_select_creator</h5><p>前面做了一些简单的判断，传入的<code>symbol</code>一定要被识别为已知类型，否则程序将无法生成代码（第20行）；判断了递归深度不能溢出；之后根据force_nonrecursive判断是否强制非递归，并添加到不同的数组中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_select_creator</span>(<span class="params">self, symbol, recursion_depth, force_nonrecursive</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;选择给定符号的creator。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    creator基于语法中指定的概率，或者如果未指定概率则均匀分布。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        symbol: 要获取其creator规则的符号的名称</span></span><br><span class="line"><span class="string">        recursion_depth: 当前递归深度</span></span><br><span class="line"><span class="string">        force_nonrecursive: 如果为 True，则仅使用标记为“非递归”的creator（如果可用）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        描述可以创建给定符号的规则的字典。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Raises:</span></span><br><span class="line"><span class="string">        RecursionError: 如果达到最大递归级别。</span></span><br><span class="line"><span class="string">        GrammarError: 如果没有创建给定类型的规则。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Do we even know how to create this type?</span></span><br><span class="line">    <span class="keyword">if</span> symbol <span class="keyword">not</span> <span class="keyword">in</span> self._creators:</span><br><span class="line">        <span class="keyword">raise</span> GrammarError(<span class="string">&#x27;No creators for type &#x27;</span> + symbol)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> recursion_depth &gt;= self._recursion_max:</span><br><span class="line">        <span class="keyword">raise</span> RecursionError(</span><br><span class="line">            <span class="string">&#x27;Maximum recursion level reached while creating &#x27;</span></span><br><span class="line">            <span class="string">&#x27;object of type&#x27;</span> + symbol</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">elif</span> force_nonrecursive <span class="keyword">and</span> symbol <span class="keyword">in</span> self._nonrecursive_creators:</span><br><span class="line">        creators = self._nonrecursive_creators[symbol]</span><br><span class="line">        cdf = self._nonrecursivecreator_cdfs[symbol]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        creators = self._creators[symbol]</span><br><span class="line">        cdf = self._creator_cdfs[symbol]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cdf:</span><br><span class="line">        <span class="comment"># Uniform distribution, faster</span></span><br><span class="line">        <span class="keyword">return</span> creators[random.randint(<span class="number">0</span>, <span class="built_in">len</span>(creators) - <span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Select a creator according to the cdf</span></span><br><span class="line">    idx = bisect.bisect_left(cdf, random.random(), <span class="number">0</span>, <span class="built_in">len</span>(cdf))</span><br><span class="line">    <span class="keyword">return</span> creators[idx]</span><br></pre></td></tr></table></figure>



<h5 id="expand-rule"><a href="#expand-rule" class="headerlink" title="_expand_rule"></a>_expand_rule</h5><p>由于语法规则中有些右侧元素索引着其他元素，那么需要使用这个函数将其扩展，这样做的目的是为了语法简便。</p>
<p>在生成html和css代码时其实不会执行到最后的代码段，核心点在于调用_generate函数，而_generate函数也调用了该_expand_rule函数，二者存递归调用，将右侧的元素完全展开。</p>
<p>随机生成的结果通过ret_parts保存，最后拼接得到最终结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_expand_rule</span>(<span class="params">self, symbol, rule, context,</span></span></span><br><span class="line"><span class="params"><span class="function">                 recursion_depth, force_nonrecursive</span>):</span></span><br><span class="line">   <span class="string">&quot;&quot;&quot;扩展给定的规则。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    遍历规则右侧的所有元素，将它们替换为它们的字符串表示或递归调用 _Generate() 以获取其他非终结符号。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数：</span></span><br><span class="line"><span class="string">        符号：正在解析的符号的名称。</span></span><br><span class="line"><span class="string">        规则：将用于扩展符号的生产规则。</span></span><br><span class="line"><span class="string">        上下文：字典包括：</span></span><br><span class="line"><span class="string">            &#x27;lastvar&#x27;：创建的最后一个变量的索引。</span></span><br><span class="line"><span class="string">            &#x27;lines&#x27;：生成的代码行</span></span><br><span class="line"><span class="string">                （用于编程语言生成）。</span></span><br><span class="line"><span class="string">            &#x27;variables&#x27;：包含所有名称的字典</span></span><br><span class="line"><span class="string">                到目前为止创建的变量。</span></span><br><span class="line"><span class="string">        recursion_depth：当前递归深度</span></span><br><span class="line"><span class="string">        force_nonrecursive：是否强制只使用非递归规则。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    回报：</span></span><br><span class="line"><span class="string">        包含符号扩展的字符串。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    提高：</span></span><br><span class="line"><span class="string">        GrammarError：如果语法描述不正确导致某些规则无法解析</span></span><br><span class="line"><span class="string">        RecursionError：如果达到最大递归级别。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">    ...</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                expanded = self._generate(</span><br><span class="line">                    part[<span class="string">&#x27;tagname&#x27;</span>],</span><br><span class="line">                    context,</span><br><span class="line">                    recursion_depth + <span class="number">1</span>,</span><br><span class="line">                    force_nonrecursive</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">except</span> RecursionError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> force_nonrecursive:</span><br><span class="line">                    expanded = self._generate(</span><br><span class="line">                        part[<span class="string">&#x27;tagname&#x27;</span>],</span><br><span class="line">                        context,</span><br><span class="line">                        recursion_depth + <span class="number">1</span>,</span><br><span class="line">                        <span class="literal">True</span></span><br><span class="line">                    )</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> RecursionError(e)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;id&#x27;</span> <span class="keyword">in</span> part:</span><br><span class="line">            variable_ids[part[<span class="string">&#x27;id&#x27;</span>]] = expanded</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;beforeoutput&#x27;</span> <span class="keyword">in</span> part:</span><br><span class="line">            expanded = self._exec_function(</span><br><span class="line">                part[<span class="string">&#x27;beforeoutput&#x27;</span>],</span><br><span class="line">                part,</span><br><span class="line">                context,</span><br><span class="line">                expanded</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        ret_parts.append(expanded)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add all newly created variables to the context</span></span><br><span class="line">    additional_lines = []</span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> new_vars:</span><br><span class="line">        <span class="keyword">if</span> v[<span class="string">&#x27;type&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> _NONINTERESTING_TYPES:</span><br><span class="line">            self._add_variable(v[<span class="string">&#x27;name&#x27;</span>], v[<span class="string">&#x27;type&#x27;</span>], context)</span><br><span class="line">            additional_lines.append(<span class="string">&quot;if (!&quot;</span> + v[<span class="string">&#x27;name&#x27;</span>] + <span class="string">&quot;) &#123; &quot;</span> + v[<span class="string">&#x27;name&#x27;</span>] + <span class="string">&quot; = GetVariable(fuzzervars, &#x27;&quot;</span> + v[<span class="string">&#x27;type&#x27;</span>] + <span class="string">&quot;&#x27;); &#125; else &#123; &quot;</span> + self._get_variable_setters(v[<span class="string">&#x27;name&#x27;</span>], v[<span class="string">&#x27;type&#x27;</span>]) + <span class="string">&quot; &#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return the result.</span></span><br><span class="line">    <span class="comment"># In case of &#x27;ordinary&#x27; grammar rules, return the filled rule.</span></span><br><span class="line">    <span class="comment"># In case of code, return just the variable name</span></span><br><span class="line">    <span class="comment"># and update the context</span></span><br><span class="line">    filed_rule = <span class="string">&#x27;&#x27;</span>.join(ret_parts)</span><br><span class="line">    <span class="keyword">if</span> rule[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;grammar&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> filed_rule</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        context[<span class="string">&#x27;lines&#x27;</span>].append(filed_rule)</span><br><span class="line">        context[<span class="string">&#x27;lines&#x27;</span>].extend(additional_lines)</span><br><span class="line">        <span class="keyword">if</span> symbol == <span class="string">&#x27;line&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> filed_rule</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ret_vars[random.randint(<span class="number">0</span>, <span class="built_in">len</span>(ret_vars) - <span class="number">1</span>)]</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/14/domato101/image-20220119112246373.png" alt="image-20220119112246373"></p>
<h4 id="generate-code"><a href="#generate-code" class="headerlink" title="_generate_code"></a>_generate_code</h4><h5 id="generate-code-1"><a href="#generate-code-1" class="headerlink" title="_generate_code"></a>_generate_code</h5><p>调用了<code>_add_variable</code>，<code>_expand_rule</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_generate_code</span>(<span class="params">self, num_lines, initial_variables=[], last_var=<span class="number">0</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generates a given number of lines of code.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    context = &#123;</span><br><span class="line">        <span class="string">&#x27;lastvar&#x27;</span>: last_var,</span><br><span class="line">        <span class="string">&#x27;lines&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;variables&#x27;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&#x27;interesting_lines&#x27;</span>: [],</span><br><span class="line">        <span class="string">&#x27;force_var_reuse&#x27;</span>: <span class="literal">False</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> initial_variables:</span><br><span class="line">        self._add_variable(v[<span class="string">&#x27;name&#x27;</span>], v[<span class="string">&#x27;type&#x27;</span>], context)</span><br><span class="line">    self._add_variable(<span class="string">&#x27;document&#x27;</span>, <span class="string">&#x27;Document&#x27;</span>, context)</span><br><span class="line">    self._add_variable(<span class="string">&#x27;window&#x27;</span>, <span class="string">&#x27;Window&#x27;</span>, context)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(context[<span class="string">&#x27;lines&#x27;</span>]) &lt; num_lines:</span><br><span class="line">        tmp_context = context.copy()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> (random.random() &lt; self._interesting_line_prob) <span class="keyword">and</span> (<span class="built_in">len</span>(tmp_context[<span class="string">&#x27;interesting_lines&#x27;</span>]) &gt; <span class="number">0</span>):</span><br><span class="line">                tmp_context[<span class="string">&#x27;force_var_reuse&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">                lineno = random.choice(tmp_context[<span class="string">&#x27;interesting_lines&#x27;</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                lineno = random.choice(self._all_nonhelper_lines)</span><br><span class="line">            creator = self._creators[<span class="string">&#x27;line&#x27;</span>][lineno]</span><br><span class="line">            self._expand_rule(<span class="string">&#x27;line&#x27;</span>, creator, tmp_context, <span class="number">0</span>, <span class="literal">False</span>)</span><br><span class="line">            context = tmp_context</span><br><span class="line">        <span class="keyword">except</span> RecursionError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Warning: &#x27;</span> + <span class="built_in">str</span>(e))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self._line_guard:</span><br><span class="line">        guarded_lines = context[<span class="string">&#x27;lines&#x27;</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        guarded_lines = []</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> context[<span class="string">&#x27;lines&#x27;</span>]:</span><br><span class="line">            guarded_lines.append(self._line_guard.replace(<span class="string">&#x27;&lt;line&gt;&#x27;</span>, line))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\n&#x27;</span>.join(guarded_lines)</span><br></pre></td></tr></table></figure>

<h5 id="add-variable"><a href="#add-variable" class="headerlink" title="_add_variable"></a>_add_variable</h5><p>更新<code>_interesting_lines</code>，更新context[‘variables’][var_type]，递归处理<code>self._inheritance[var_type]</code>的元素。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_add_variable</span>(<span class="params">self, var_name, var_type, context</span>):</span></span><br><span class="line">    <span class="keyword">if</span> var_type <span class="keyword">not</span> <span class="keyword">in</span> context[<span class="string">&#x27;variables&#x27;</span>]:</span><br><span class="line">        context[<span class="string">&#x27;variables&#x27;</span>][var_type] = []</span><br><span class="line">        <span class="keyword">if</span> var_type <span class="keyword">in</span> self._interesting_lines:</span><br><span class="line">            set1 = <span class="built_in">set</span>(context[<span class="string">&#x27;interesting_lines&#x27;</span>])</span><br><span class="line">            set2 = <span class="built_in">set</span>(self._interesting_lines[var_type])</span><br><span class="line">            new_interesting = set2 - set1</span><br><span class="line">            context[<span class="string">&#x27;interesting_lines&#x27;</span>] += <span class="built_in">list</span>(new_interesting)</span><br><span class="line">    context[<span class="string">&#x27;variables&#x27;</span>][var_type].append(var_name)</span><br><span class="line">    <span class="keyword">if</span> var_type <span class="keyword">in</span> self._inheritance:</span><br><span class="line">        <span class="keyword">for</span> parent_type <span class="keyword">in</span> self._inheritance[var_type]:</span><br><span class="line">            self._add_variable(var_name, parent_type, context)</span><br></pre></td></tr></table></figure>

<h5 id="expand-rule-1"><a href="#expand-rule-1" class="headerlink" title="_expand_rule"></a>_expand_rule</h5><p>该函数上面提到过，不多说了。</p>
<p><img src="/2022/04/14/domato101/image-20220119171957132.png" alt="image-20220119171957132"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，domato是一python开发的基于生成的DOM fuzzer。其核心在于给定语法规则生成随机的html文件。严格来说它并没有实现喂数据并检测崩溃的功能，可以把它当作一个生成器。</p>
<p>domato有两个主要的功能py文件 generator.py 和 grammar.py ，generator.py相当于外壳文件，用于初始化模板文件，并将生成的数据进行处理，最终生成一个样本文件；grammar.py 则相当于一个随机生成前端代码的库，通过读取特定的语法规则，来随机生成html，css，js代码，而这个语法文件通过txt文件进行维护，我们可以随时向语法文件添加新的特性来支持工具生成最新语法特性的代码。</p>
<p>该工具简单易用，可以方便对pdf js引擎，浏览器，js语法引擎等等场景进行fuzz，在问世之初便拿到很多CVE.</p>
<p>但是该工具最大的弊端在于没有与基于代码覆盖率引导的技术相结合，导致数据只是漫无目的生成，发现漏洞的随机性比较高，但是和代码覆盖引导结合有些问题</p>
<ol>
<li>由于大的样本会对fuzz效率产生比较大的影响，所以在传统的基于覆盖引导技术的fuzz过程中一般会对样本进行精简（也就是语料库蒸馏），一般domato生成的html文件比较大，而拿afl-tmin来说处理一个大文件的时间是很长的，而成百上千的大文件语料库蒸馏就是一个比较大的问题，如何在保证语料库蒸馏效果的基础上提高语料库蒸馏的效率。而不至于语料库蒸馏的时间比真正fuzz的时间还要更长。</li>
<li>由于domato只实现了生成语料库的功能，我们需要自行实现自动化漏洞类型识别，挂机重启，数据处理，日志处理等等问题。</li>
<li>上面提到了语料库蒸馏的问题，还有关键的问题在于基于覆盖引导的dom fuzzer怎样实现，作者之前实现了该功能，但是效果并不理想，可见需要正确的编码和思想才可以充分利用基于覆盖引导的优势，否则只会适得其反。</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol>
<li><a class="link"   target="_blank" rel="noopener" href="https://github.com/googleprojectzero/domato" >官方github<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2017/09/the-great-dom-fuzz-off-of-2017.html" >官方blog<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.skylined.nl/20181017001.html" >damato配合bugid自动化进行fuzz与分类<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://symeonp.github.io/2020/04/18/grammar-based-fuzzing.html" >使用domato对pdf解析阅读器进行fuzz<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://sigpwn.io/blog/2018/5/13/adding-afl-bloom-filter-to-domato-for-fun" >将 AFL 布隆过滤器添加到 Domato 以获得更多崩溃<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://sigpwn.io/blog/2018/4/14/domato-fuzzers-generation-engine-internals" >Domato Fuzzer 的生成引擎内部结构<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link"   target="_blank" rel="noopener" href="https://blog.jmpesp.org/2020/01/fuzzing-php-with-domato.html?m=1&fbclid=IwAR16VPIISd2dERbma9o5bmYrEo-iBS7gPhsr0UqjUJWLlctWiHO1zpmPjHg" >使用Domato去fuzz php解析引擎<i class="fas fa-external-link-alt"></i></a></li>
</ol>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ol>
<li>将AFL布隆过滤器与domato结合</li>
</ol>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">#浏览器</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/fuzz/">#fuzz</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">#源码分析</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/04/19/gdb9-2%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8A%E7%9B%B8%E5%85%B3%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">gdb9.2源码安装以及相关插件安装</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/03/30/CVE-2022-0847-dirtypipe-linux%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E5%85%A8%E7%BD%91%E7%AC%AC%E4%BA%8C%E8%AF%A6%E7%BB%86%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CVE-2022-0847 dirtypipe linux本地提权全网第二详细漏洞分析</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'oP8c99sduOuJjyeVoKafuweh-gzGzoHsz',
                    appKey: 'TwXXvHbKxF0DVsXV22S2uRVG',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '欢迎大家吐槽~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'fa1lr4in';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('false') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">fa1lr4in</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Domato101"><span class="nav-text">Domato101</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8bugid%E9%85%8D%E5%90%88domato%E8%BF%9B%E8%A1%8Cfuzz%E6%B5%8B%E8%AF%95"><span class="nav-text">使用bugid配合domato进行fuzz测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fuzz-cmd"><span class="nav-text">fuzz.cmd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#index-html"><span class="nav-text">index.html</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%88%86%E6%9E%90"><span class="nav-text">模块分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#generator-py"><span class="nav-text">generator.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grammar-py"><span class="nav-text">grammar.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95"><span class="nav-text">扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="nav-text">基本语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E4%BB%A3%E7%A0%81"><span class="nav-text">生成编程语言代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B3%A8%E9%87%8A"><span class="nav-text">注释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E6%97%A0%E9%99%90%E9%80%92%E5%BD%92"><span class="nav-text">防止无限递归</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#include%E4%B8%8Eimport"><span class="nav-text">include与import</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-Python-%E4%BB%A3%E7%A0%81"><span class="nav-text">使用 Python 代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E7%AC%A6%E5%8F%B7"><span class="nav-text">内置符号</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AC%A6%E5%8F%B7%E5%B1%9E%E6%80%A7"><span class="nav-text">符号属性</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#generator-py-1"><span class="nav-text">generator.py</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grammar-py-1"><span class="nav-text">grammar.py</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Grammar"><span class="nav-text">Grammar</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#parse-from-file"><span class="nav-text">parse_from_file</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-from-string"><span class="nav-text">parse_from_string</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#include-from-string"><span class="nav-text">_include_from_string</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-grammar-line"><span class="nav-text">_parse_grammar_line</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#parse-code-line"><span class="nav-text">_parse_code_line</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#normalize-probabilities"><span class="nav-text">_normalize_probabilities</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#compute-interesting-indices"><span class="nav-text">_compute_interesting_indices</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#generate-symbol"><span class="nav-text">generate_symbol</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#generate"><span class="nav-text">_generate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#select-creator"><span class="nav-text">_select_creator</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#expand-rule"><span class="nav-text">_expand_rule</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#generate-code"><span class="nav-text">_generate_code</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#generate-code-1"><span class="nav-text">_generate_code</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#add-variable"><span class="nav-text">_add_variable</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#expand-rule-1"><span class="nav-text">_expand_rule</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO"><span class="nav-text">TODO</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
